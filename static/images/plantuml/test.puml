@startuml
!theme plain
skinparam backgroundColor white
skinparam handwritten false
skinparam DefaultFontName "Arial"
skinparam DefaultFontSize 12

title Android Perfetto 性能追踪系统架构 (Smart Cockpit Implementation)

package "User Space (App/Service Layer)" as UserSpace {
    [perfetto CLI] as CLI <<Consumer>>
    [Traceur / System Tracing] as Traceur <<Consumer>>
}

package "System Services (Producers)" as SystemServices {
    [InputFlinger] as Input <<Producer>>
    [SurfaceFlinger] as SF <<Producer>>
    [System Server] as SS <<Producer>>
}

package "Perfetto Core (The Brain)" as PerfettoCore {
    component "traced (Daemon)" as Traced {
        [Service_Impl] as Srv
        [Shared Memory Pool] as SHM
        [Buffer Manager] as BufMgr
    }
    
    component "traced_probes" as Probes {
        [Ftrace Probe]
        [Sys_Stats Probe]
    }
}

package "Kernel Space" as KernelSpace {
    [Ftrace / Debugfs] as Ftrace
    [Kernel Sched/Binder] as KEvent
}

' 交互连接
CLI -down-> Srv : 1. 发送 .pbtxt 配置 (via Socket)
Srv -right-> SHM : 2. 分配共享内存页
Srv <-up-> Input : 3. IPC (通知开始录制)
Input --> SHM : 4. 零拷贝写入数据 (Trace Events)

Probes -up-> Srv : 5. 汇聚内核数据
Probes -down-> Ftrace : 监听内核事件

Ftrace <-down-> KEvent : 捕获调度/Binder信息

Srv -left-> BufMgr : 6. 维护 Ring Buffer
BufMgr .up.> CLI : 7. 触发落盘 (Result .perfetto-trace)

' note right of SHM
'   座舱架构中，零拷贝是
'   保证低 CPU 开销的核心
' end note

@enduml