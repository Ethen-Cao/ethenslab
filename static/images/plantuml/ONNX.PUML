@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontSize 13
skinparam defaultFontColor black
skinparam arrowColor #333333
skinparam nodesep 50
skinparam ranksep 40
skinparam linetype ortho

' --- 样式定义 ---
skinparam rectangle {
    BackgroundColor #F5F5F5
    BorderColor #9E9E9E
    RoundCorner 6
}
skinparam component {
    BackgroundColor #E3F2FD
    BorderColor #1E88E5
}
skinparam file {
    BackgroundColor #FFF9C4
    BorderColor #FBC02D
}

title QNN HTP Architecture: Full Lifecycle (Fixed Directions)

' --- 图例 (Legend) ---
legend right
    | 颜色 | 阶段 / 含义 |
    | <#FF0000> | <b>Phase 1: 初始化与建图</b> (只运行一次) |
    | <#0000FF> | <b>Side-load 回环</b> (驱动加载 Skel 文件) |
    | <#008000> | <b>Phase 2: 推理执行</b> (每帧运行, 高频) |
endlegend

node "Qualcomm SoC" {

    rectangle "CPU Subsystem (Application Processor)" as CPU_DOMAIN {

        rectangle "1. App Process Space" as LAYER_APP {
            component "App Code" as AppCode
            file "Assets/model.onnx" as Model

            rectangle "Native Libraries" {
                component "ONNX Runtime" as ORT
                component "QNN EP" as QNN_EP
                
                package "QNN SDK" {
                    component "Backend Manager\n(libQnnHtp.so)" as QnnHtp
                    component "Stub\n(CPU Proxy)" as QnnStub
                }
                
                file "libQnnHtpVxxSkel.so\n(Disk Artifact)" as SkelFile
            }
        }

        rectangle "2. System / Kernel" as LAYER_SYS {
            component "FastRPC Lib" as FastRPC
            component "FastRPC Driver" as Driver
            database "Shared Memory\n(ION / DMA-BUF)" as Mem
        }
    }

    rectangle "DSP Subsystem" as DSP_DOMAIN {
        component "QuRT OS" as QuRT

        package "Signed PD" {
            component "Skel Instance\n(Running Code)" as SkelRun
            component "HTP Hardware\n(NPU)" as HTP_HW
        }
    }
}

' =======================
' 逻辑连线 (已修复方向问题)
' =======================

' --- Phase 1: Initialization (红色箭头) ---
AppCode -[#FF0000]down-> ORT : 1. CreateSession
ORT .[#FF0000]right.> Model : 2. Parse
ORT -[#FF0000]down-> QNN_EP : 3. Delegate
QNN_EP -[#FF0000]down-> QnnHtp : 4. Init
QnnHtp -[#FF0000]down-> QnnStub : 5. Load Stub

' RPC 建立
QnnStub -[#FF0000]down-> FastRPC : 6. Open Session
FastRPC -[#FF0000]down-> Driver : 7. ioctl

' DSP 唤醒
Driver -[#FF0000]down-> QuRT : 8. WakeUp & Create PD

' --- Side-load Loop (蓝色箭头 - 加载回环) ---
QuRT .[#0000FF]up.> Driver : 9. Request Load
Driver .[#0000FF]up.> FastRPC : 10. Upcall
FastRPC .[#0000FF]left.> SkelFile : 11. READ FILE
FastRPC .[#0000FF]down.> Mem : 12. Map to Shared Mem
Mem .[#0000FF]down.> SkelRun : 13. Load into DSP Mem

' --- Phase 2: Execution (绿色箭头 - 已修复方向) ---
AppCode -[#008000]right-> ORT : Run(Input)

' 修复点：添加了 down 方向
ORT -[#008000]down-> QNN_EP
QNN_EP -[#008000]down-> QnnStub

' 写入共享内存 (使用 dotted 线表示数据流，solid 线表示控制流)
QnnStub .[#008000]right.> Mem : 14. Write Input Tensor

' RPC 执行链
QnnStub -[#008000]down-> FastRPC : 15. Invoke Execute
FastRPC -[#008000]down-> Driver
Driver -[#008000]down-> SkelRun : 16. Signal
SkelRun -[#008000]down-> HTP_HW : 17. Compute

' note left of Mem
'   数据不走 RPC 拷贝
'   而是走共享内存
' end note

@enduml