<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image | Ethen 的实验室</title><meta name=keywords content><meta name=description content="在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。
本文将深入解析其文件结构、编译配置、构建流程以及打包机制。
1. 源码结构与文件路径
在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 vendor/qcom/opensource/base-devicetree 目录下。
关键文件类型与路径
所有核心文件位于 arch/arm64/boot/dts/qcom/ 目录下：


SoC 基础定义 (.dtsi):

sa8797p.dtsi: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。
sa8x97p.dtsi: 系列通用的定义。



虚拟机资源定义 (&ldquo;The Contract&rdquo;):

sa8797p-vms.dtsi: 这是配置虚拟设备的核心文件。
它定义了 auto_vm (Android Guest) 的资源，包括：

reserved-memory: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 gunyah-label）。
virtio-backends: 定义 Host 内核可见的后端逻辑设备（带有 qcom,label）。
gh-secure-vm-loader: 将上述资源绑定到特定的 VMID。





项目级覆盖 (Overlay) (.dtso):

sa8797p-overlay.dtso: 通用的 Overlay入口。
sa8797p-voyah-common-overlay.dtso: 特定项目（Voyah）的扩展配置。
最佳实践：当需要添加新设备（如 virtio-fs）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。



板级顶层定义 (.dts):

sa8797p-voyah-v20.dts: 针对具体硬件板卡的顶层描述文件。



2. 编译配置 (Bitbake Recipe)
Yocto 构建系统通过 Recipe 来管理编译过程。"><meta name=author content><link rel=canonical href=https://ethen-cao.github.io/ethenslab/gunyah/gunyah_devicetree/><link crossorigin=anonymous href=/ethenslab/assets/css/stylesheet.a1917769c3c78460b110da6d7905321bb53af4a56f22ba4cc0de824cf4d097ab.css integrity="sha256-oZF3acPHhGCxENpteQUyG7U69KVvIrpMwN6CTPTQl6s=" rel="preload stylesheet" as=style><link rel=icon href=https://ethen-cao.github.io/ethenslab/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ethen-cao.github.io/ethenslab/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ethen-cao.github.io/ethenslab/favicon-32x32.png><link rel=apple-touch-icon href=https://ethen-cao.github.io/ethenslab/apple-touch-icon.png><link rel=mask-icon href=https://ethen-cao.github.io/ethenslab/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ethen-cao.github.io/ethenslab/gunyah/gunyah_devicetree/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://ethen-cao.github.io/ethenslab/gunyah/gunyah_devicetree/"><meta property="og:site_name" content="Ethen 的实验室"><meta property="og:title" content="高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image"><meta property="og:description" content="在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。
本文将深入解析其文件结构、编译配置、构建流程以及打包机制。
1. 源码结构与文件路径 在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 vendor/qcom/opensource/base-devicetree 目录下。
关键文件类型与路径 所有核心文件位于 arch/arm64/boot/dts/qcom/ 目录下：
SoC 基础定义 (.dtsi):
sa8797p.dtsi: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。 sa8x97p.dtsi: 系列通用的定义。 虚拟机资源定义 (“The Contract”):
sa8797p-vms.dtsi: 这是配置虚拟设备的核心文件。 它定义了 auto_vm (Android Guest) 的资源，包括： reserved-memory: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 gunyah-label）。 virtio-backends: 定义 Host 内核可见的后端逻辑设备（带有 qcom,label）。 gh-secure-vm-loader: 将上述资源绑定到特定的 VMID。 项目级覆盖 (Overlay) (.dtso):
sa8797p-overlay.dtso: 通用的 Overlay入口。 sa8797p-voyah-common-overlay.dtso: 特定项目（Voyah）的扩展配置。 最佳实践：当需要添加新设备（如 virtio-fs）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。 板级顶层定义 (.dts):
sa8797p-voyah-v20.dts: 针对具体硬件板卡的顶层描述文件。 2. 编译配置 (Bitbake Recipe) Yocto 构建系统通过 Recipe 来管理编译过程。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="gunyah"><meta property="article:published_time" content="2025-08-04T09:49:58+08:00"><meta property="article:modified_time" content="2025-08-04T09:49:58+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image"><meta name=twitter:description content="在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。
本文将深入解析其文件结构、编译配置、构建流程以及打包机制。
1. 源码结构与文件路径
在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 vendor/qcom/opensource/base-devicetree 目录下。
关键文件类型与路径
所有核心文件位于 arch/arm64/boot/dts/qcom/ 目录下：


SoC 基础定义 (.dtsi):

sa8797p.dtsi: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。
sa8x97p.dtsi: 系列通用的定义。



虚拟机资源定义 (&ldquo;The Contract&rdquo;):

sa8797p-vms.dtsi: 这是配置虚拟设备的核心文件。
它定义了 auto_vm (Android Guest) 的资源，包括：

reserved-memory: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 gunyah-label）。
virtio-backends: 定义 Host 内核可见的后端逻辑设备（带有 qcom,label）。
gh-secure-vm-loader: 将上述资源绑定到特定的 VMID。





项目级覆盖 (Overlay) (.dtso):

sa8797p-overlay.dtso: 通用的 Overlay入口。
sa8797p-voyah-common-overlay.dtso: 特定项目（Voyah）的扩展配置。
最佳实践：当需要添加新设备（如 virtio-fs）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。



板级顶层定义 (.dts):

sa8797p-voyah-v20.dts: 针对具体硬件板卡的顶层描述文件。



2. 编译配置 (Bitbake Recipe)
Yocto 构建系统通过 Recipe 来管理编译过程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Gunyah开发笔记","item":"https://ethen-cao.github.io/ethenslab/gunyah/"},{"@type":"ListItem","position":2,"name":"高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image","item":"https://ethen-cao.github.io/ethenslab/gunyah/gunyah_devicetree/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image","name":"高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image","description":"在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。\n本文将深入解析其文件结构、编译配置、构建流程以及打包机制。\n1. 源码结构与文件路径 在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 vendor/qcom/opensource/base-devicetree 目录下。\n关键文件类型与路径 所有核心文件位于 arch/arm64/boot/dts/qcom/ 目录下：\nSoC 基础定义 (.dtsi):\nsa8797p.dtsi: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。 sa8x97p.dtsi: 系列通用的定义。 虚拟机资源定义 (\u0026ldquo;The Contract\u0026rdquo;):\nsa8797p-vms.dtsi: 这是配置虚拟设备的核心文件。 它定义了 auto_vm (Android Guest) 的资源，包括： reserved-memory: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 gunyah-label）。 virtio-backends: 定义 Host 内核可见的后端逻辑设备（带有 qcom,label）。 gh-secure-vm-loader: 将上述资源绑定到特定的 VMID。 项目级覆盖 (Overlay) (.dtso):\nsa8797p-overlay.dtso: 通用的 Overlay入口。 sa8797p-voyah-common-overlay.dtso: 特定项目（Voyah）的扩展配置。 最佳实践：当需要添加新设备（如 virtio-fs）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。 板级顶层定义 (.dts):\nsa8797p-voyah-v20.dts: 针对具体硬件板卡的顶层描述文件。 2. 编译配置 (Bitbake Recipe) Yocto 构建系统通过 Recipe 来管理编译过程。\n","keywords":[],"articleBody":"在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。\n本文将深入解析其文件结构、编译配置、构建流程以及打包机制。\n1. 源码结构与文件路径 在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 vendor/qcom/opensource/base-devicetree 目录下。\n关键文件类型与路径 所有核心文件位于 arch/arm64/boot/dts/qcom/ 目录下：\nSoC 基础定义 (.dtsi):\nsa8797p.dtsi: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。 sa8x97p.dtsi: 系列通用的定义。 虚拟机资源定义 (“The Contract”):\nsa8797p-vms.dtsi: 这是配置虚拟设备的核心文件。 它定义了 auto_vm (Android Guest) 的资源，包括： reserved-memory: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 gunyah-label）。 virtio-backends: 定义 Host 内核可见的后端逻辑设备（带有 qcom,label）。 gh-secure-vm-loader: 将上述资源绑定到特定的 VMID。 项目级覆盖 (Overlay) (.dtso):\nsa8797p-overlay.dtso: 通用的 Overlay入口。 sa8797p-voyah-common-overlay.dtso: 特定项目（Voyah）的扩展配置。 最佳实践：当需要添加新设备（如 virtio-fs）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。 板级顶层定义 (.dts):\nsa8797p-voyah-v20.dts: 针对具体硬件板卡的顶层描述文件。 2. 编译配置 (Bitbake Recipe) Yocto 构建系统通过 Recipe 来管理编译过程。\nRecipe 文件: layers/meta-qti-auto-kernel/recipes-kernel/linux/kernel-basedevicetree.bb (及其 .bbappend)。 工作原理: Recipe 将源码目录变量 ${S} 指向 vendor/qcom/opensource/base-devicetree。 它定义了依赖关系 DEPENDS += \"virtual/kernel\"，确保内核环境已准备好。 在 do_compile 阶段，它执行 make 命令。 3. 编译过程详解 编译过程并非由单一工具完成，而是通过一个 Wrapper Makefile 调用 Linux 内核构建系统，最后由脚本合并。\n第一阶段：Wrapper Makefile 调用 Bitbake 执行 vendor/qcom/opensource/base-devicetree/Makefile。 该 Makefile 设置了关键环境变量：\nKDIR: 指向 Linux 内核源码树。 TECHPACK_INCLUDE: 包含路径，确保能找到 oot-dt-bindings 头文件。 然后它执行：\n$(MAKE) -C $(KDIR) ... dtbs 这意味着它切换到内核目录，利用内核的 Kbuild 系统来编译外部的 device tree。\n第二阶段：DTC 编译 (生成 .dtb 和 .dtbo) 内核的 Kbuild 系统调用设备树编译器 (dtc)：\n预处理: 处理 #include 指令。 编译: 将 .dts (如 sa8797p-voyah-v20.dts) 编译为 基础 Blob (.dtb)。 将 .dtso (如 sa8797p-voyah-common-overlay.dtso) 编译为 Overlay Blob (.dtbo)。 第三阶段：合并 (Merge) 编译完成后，会调用 merge_dtbs.sh 脚本 。 该脚本使用 fdtoverlay 工具，将匹配的 .dtbo (Overlay) 动态应用到基础 .dtb 上：\nfdtoverlay -i base.dtb -o final_merged.dtb -v overlay1.dtbo overlay2.dtbo ... 结果：生成一个包含所有硬件定义以及所有 VM 资源配置（您添加的 Virtio-FS 节点）的最终 DTB 文件。\n4. 虚拟机配置机制 (Gunyah Contract) 这是 Gunyah 架构最独特的部分。Host 的设备树不仅仅描述硬件，还描述了 VM 的权限。\n关键配置项 在 .dtsi 或 .dtso 中，必须成对配置以下两项，才能让 qcrosvm 正常工作：\n物理资源 (Memory):\nauto_vm_fs_ring: auto_vm_fs_ring@B002BE000 { no-map; /* 禁止 Host OS 挪作他用 */ reg = \u003c0xB 0x002BE000 ...\u003e; /* 固定的物理地址 */ gunyah-label = \u003c0x5C\u003e; /* 资源 ID */ }; 逻辑设备 (Backend):\nauto_vm_be59: auto_vm_be59@5C { qcom,vm = \u003c\u0026auto_vm\u003e; qcom,label = \u003c0x5C\u003e; /* 设备 ID */ }; 运行时交互 Gunyah Hypervisor (EL2): 启动时读取最终 DTB，记录下 Label 0x5C 对应物理地址 0xB002BE000。 qcrosvm (EL1 User): 启动时参数 --vhost-user-fs ...,label=5C。它发起 ioctl 请求操作 0x5C。 验证: Hypervisor 检查 DTB 记录，确认 0x5C 存在且合法，允许 qcrosvm 建立连接。 5. 打包过程 (Packaging) 生成的 DTB 最终必须被打包进启动镜像才能生效。\n工具: mkbootimg (Android 标准工具)。 输入: kernel (Image.gz): Linux Host 内核。 ramdisk (initrd.img): 根文件系统。 dtb: 上一步生成的最终合并 DTB。 输出: sa8797-boot.img。 命令示例 (由 qimage-boot.bbclass 处理): mkbootimg --kernel Image.gz --dtb final_merged.dtb --ramdisk initrd.img --output boot.img ... 总结 修改: 您在 sa8797p-voyah-common-overlay.dtso 中添加了 virtio-fs 的 label 和 ring-buffer。 编译: Bitbake 调用 Wrapper Makefile，进而调用 Kernel DTC，生成 .dtb 和 .dtbo。 合并: merge_dtbs.sh 将 Overlay 合并入 Base DTB。 打包: 合并后的 DTB 被 mkbootimg 打包进 boot.img。 生效: 设备启动，Bootloader 加载 boot.img，Gunyah 读取 DTB 中的新配置，从而允许您的 qcrosvm 使用新的 label 启动 virtio-fs。 @startuml !theme plain package \"Base / SoC Definitions\" { component \"sa8x97p.dtsi\" as sa8x97p_dtsi component \"sa8797p.dtsi\" as sa8797p_dtsi component \"sa8x97p-non-safe.dtsi\" as nonsafe_dtsi } package \"Voyah Project (Base DTB)\" { component \"sa8797p-voyah-v20.dts\" as voyah_v20_dts #LightBlue component \"sa8797p-voyah-common.dtsi\" as voyah_common_dtsi voyah_v20_dts -down-\u003e voyah_common_dtsi : includes voyah_common_dtsi -down-\u003e sa8x97p_dtsi : includes voyah_common_dtsi -down-\u003e sa8797p_dtsi : includes voyah_common_dtsi -down-\u003e nonsafe_dtsi : includes } package \"Feature Definitions (DTSI)\" { component \"sa8797p-vms.dtsi\" as vms_dtsi #LightYellow note right of vms_dtsi 定义 auto_vm 和 virtio-backends (Gunyah Resources) end note component \"sa8797p-vfio.dtsi\" as vfio_dtsi component \"sa8797p-dma-heaps.dtsi\" as heaps_dtsi } package \"Generic Overlay (DTBO)\" { component \"sa8797p-overlay.dtso\" as overlay_dtso #LightGreen overlay_dtso -down-\u003e vms_dtsi : includes overlay_dtso -down-\u003e vfio_dtsi : includes overlay_dtso -down-\u003e heaps_dtsi : includes } package \"Voyah Project Overlay (DTBO)\" { component \"sa8797p-voyah-v20-overlay.dtso\" as voyah_v20_overlay #LightBlue component \"sa8797p-voyah-common-overlay.dtso\" as voyah_common_overlay voyah_v20_overlay -down-\u003e voyah_common_overlay : includes voyah_common_overlay -down-\u003e overlay_dtso : includes } note bottom of voyah_common_overlay **关键修改点**: 这里引用了 \u0026auto_vm 和 \u0026auto_vm_0 并追加了更多 label (0x53-0x5B) end note @enduml ","wordCount":"525","inLanguage":"en","datePublished":"2025-08-04T09:49:58+08:00","dateModified":"2025-08-04T09:49:58+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://ethen-cao.github.io/ethenslab/gunyah/gunyah_devicetree/"},"publisher":{"@type":"Organization","name":"Ethen 的实验室","logo":{"@type":"ImageObject","url":"https://ethen-cao.github.io/ethenslab/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ethen-cao.github.io/ethenslab/ accesskey=h title="Ethen 的实验室 (Alt + H)">Ethen 的实验室</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ethen-cao.github.io/ethenslab/android-dev/ title=Android系统开发><span>Android系统开发</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/android-automotive-os-dev/ title="Android Automotive"><span>Android Automotive</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/qnx/ title=QNX开发><span>QNX开发</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/gunyah/ title=Gunyah><span>Gunyah</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/ivi-solution/ title=智能座舱方案><span>智能座舱方案</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/explore-ai title="Explore AI"><span>Explore AI</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ethen-cao.github.io/ethenslab/>Home</a>&nbsp;»&nbsp;<a href=https://ethen-cao.github.io/ethenslab/gunyah/>Gunyah开发笔记</a></div><h1 class="post-title entry-hint-parent">高通 Gunyah 虚拟化平台设备树 (Device Tree) 全解：从源码到 Boot Image</h1><div class=post-meta><span title='2025-08-04 09:49:58 +0800 CST'>August 4, 2025</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;525 words</div></header><div class=post-content><p>在基于 Gunyah Hypervisor 的高通汽车平台（如 SA8797P）中，设备树（Device Tree）扮演着双重角色：它不仅描述了 Linux Host 的物理硬件，还充当了 Hypervisor 的“资源授权合约”，定义了虚拟机（VM）可以访问哪些内存和虚拟设备。</p><p>本文将深入解析其文件结构、编译配置、构建流程以及打包机制。</p><h2 id=1-源码结构与文件路径>1. 源码结构与文件路径<a hidden class=anchor aria-hidden=true href=#1-源码结构与文件路径>#</a></h2><p>在 Yocto 项目中，设备树源码通常独立于内核源码管理，位于 <code>vendor/qcom/opensource/base-devicetree</code> 目录下。</p><h3 id=关键文件类型与路径>关键文件类型与路径<a hidden class=anchor aria-hidden=true href=#关键文件类型与路径>#</a></h3><p>所有核心文件位于 <code>arch/arm64/boot/dts/qcom/</code> 目录下：</p><ol><li><p><strong>SoC 基础定义 (<code>.dtsi</code>)</strong>:</p><ul><li><strong><code>sa8797p.dtsi</code></strong>: 定义了芯片级的硬件，如 CPU、中断控制器 (GIC)、总线、时钟等。</li><li><strong><code>sa8x97p.dtsi</code></strong>: 系列通用的定义。</li></ul></li><li><p><strong>虚拟机资源定义 (&ldquo;The Contract&rdquo;)</strong>:</p><ul><li><strong><code>sa8797p-vms.dtsi</code></strong>: <strong>这是配置虚拟设备的核心文件</strong>。</li><li>它定义了 <code>auto_vm</code> (Android Guest) 的资源，包括：<ul><li><strong><code>reserved-memory</code></strong>: 为 Virtio 环形缓冲区（Ring Buffers）预留的物理内存（带有 <code>gunyah-label</code>）。</li><li><strong><code>virtio-backends</code></strong>: 定义 Host 内核可见的后端逻辑设备（带有 <code>qcom,label</code>）。</li><li><strong><code>gh-secure-vm-loader</code></strong>: 将上述资源绑定到特定的 VMID。</li></ul></li></ul></li><li><p><strong>项目级覆盖 (Overlay) (<code>.dtso</code>)</strong>:</p><ul><li><strong><code>sa8797p-overlay.dtso</code></strong>: 通用的 Overlay入口。</li><li><strong><code>sa8797p-voyah-common-overlay.dtso</code></strong>: <strong>特定项目（Voyah）的扩展配置</strong>。</li><li><em>最佳实践</em>：当需要添加新设备（如 <code>virtio-fs</code>）时，推荐修改此文件，以利用其覆盖机制，避免破坏基础平台定义。</li></ul></li><li><p><strong>板级顶层定义 (<code>.dts</code>)</strong>:</p><ul><li><strong><code>sa8797p-voyah-v20.dts</code></strong>: 针对具体硬件板卡的顶层描述文件。</li></ul></li></ol><h2 id=2-编译配置-bitbake-recipe>2. 编译配置 (Bitbake Recipe)<a hidden class=anchor aria-hidden=true href=#2-编译配置-bitbake-recipe>#</a></h2><p>Yocto 构建系统通过 Recipe 来管理编译过程。</p><ul><li><strong>Recipe 文件</strong>: <code>layers/meta-qti-auto-kernel/recipes-kernel/linux/kernel-basedevicetree.bb</code> (及其 <code>.bbappend</code>)。</li><li><strong>工作原理</strong>:<ol><li>Recipe 将源码目录变量 <code>${S}</code> 指向 <code>vendor/qcom/opensource/base-devicetree</code>。</li><li>它定义了依赖关系 <code>DEPENDS += "virtual/kernel"</code>，确保内核环境已准备好。</li><li>在 <code>do_compile</code> 阶段，它执行 <code>make</code> 命令。</li></ol></li></ul><h2 id=3-编译过程详解>3. 编译过程详解<a hidden class=anchor aria-hidden=true href=#3-编译过程详解>#</a></h2><p>编译过程并非由单一工具完成，而是通过一个 Wrapper Makefile 调用 Linux 内核构建系统，最后由脚本合并。</p><h3 id=第一阶段wrapper-makefile-调用>第一阶段：Wrapper Makefile 调用<a hidden class=anchor aria-hidden=true href=#第一阶段wrapper-makefile-调用>#</a></h3><p>Bitbake 执行 <code>vendor/qcom/opensource/base-devicetree/Makefile</code>。
该 Makefile 设置了关键环境变量：</p><ul><li><code>KDIR</code>: 指向 Linux 内核源码树。</li><li><code>TECHPACK_INCLUDE</code>: 包含路径，确保能找到 <code>oot-dt-bindings</code> 头文件。</li></ul><p>然后它执行：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-makefile data-lang=makefile><span style=display:flex><span><span style=color:#66d9ef>$(</span>MAKE<span style=color:#66d9ef>)</span> <span style=color:#960050;background-color:#1e0010>-C</span> <span style=color:#66d9ef>$(</span>KDIR<span style=color:#66d9ef>)</span> <span style=color:#960050;background-color:#1e0010>...</span> <span style=color:#960050;background-color:#1e0010>dtbs</span>
</span></span></code></pre></div><p>这意味着它切换到内核目录，利用内核的 Kbuild 系统来编译外部的 device tree。</p><h3 id=第二阶段dtc-编译-生成-dtb-和-dtbo>第二阶段：DTC 编译 (生成 .dtb 和 .dtbo)<a hidden class=anchor aria-hidden=true href=#第二阶段dtc-编译-生成-dtb-和-dtbo>#</a></h3><p>内核的 Kbuild 系统调用设备树编译器 (<code>dtc</code>)：</p><ol><li><strong>预处理</strong>: 处理 <code>#include</code> 指令。</li><li><strong>编译</strong>:<ul><li>将 <code>.dts</code> (如 <code>sa8797p-voyah-v20.dts</code>) 编译为 <strong>基础 Blob (<code>.dtb</code>)</strong>。</li><li>将 <code>.dtso</code> (如 <code>sa8797p-voyah-common-overlay.dtso</code>) 编译为 <strong>Overlay Blob (<code>.dtbo</code>)</strong>。</li></ul></li></ol><h3 id=第三阶段合并-merge>第三阶段：合并 (Merge)<a hidden class=anchor aria-hidden=true href=#第三阶段合并-merge>#</a></h3><p>编译完成后，会调用 <code>merge_dtbs.sh</code> 脚本 。
该脚本使用 <code>fdtoverlay</code> 工具，将匹配的 <code>.dtbo</code> (Overlay) 动态应用到基础 <code>.dtb</code> 上：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>fdtoverlay -i base.dtb -o final_merged.dtb -v overlay1.dtbo overlay2.dtbo ...
</span></span></code></pre></div><p><strong>结果</strong>：生成一个包含所有硬件定义<strong>以及</strong>所有 VM 资源配置（您添加的 Virtio-FS 节点）的最终 DTB 文件。</p><h2 id=4-虚拟机配置机制-gunyah-contract>4. 虚拟机配置机制 (Gunyah Contract)<a hidden class=anchor aria-hidden=true href=#4-虚拟机配置机制-gunyah-contract>#</a></h2><p>这是 Gunyah 架构最独特的部分。Host 的设备树不仅仅描述硬件，还描述了 VM 的权限。</p><h3 id=关键配置项>关键配置项<a hidden class=anchor aria-hidden=true href=#关键配置项>#</a></h3><p>在 <code>.dtsi</code> 或 <code>.dtso</code> 中，必须成对配置以下两项，才能让 <code>qcrosvm</code> 正常工作：</p><ol><li><p><strong>物理资源 (Memory)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-dts data-lang=dts><span style=display:flex><span>auto_vm_fs_ring: <span style=color:#a6e22e>auto_vm_fs_ring</span><span style=color:#f92672>@</span><span style=color:#ae81ff>B002BE000</span><span style=color:#75715e> </span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>no-map</span>;                      <span style=color:#75715e>/* 禁止 Host OS 挪作他用 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reg</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0xB</span> <span style=color:#ae81ff>0x002BE000</span> ...<span style=color:#f92672>&gt;</span>;  <span style=color:#75715e>/* 固定的物理地址 */</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gunyah-label</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0x5C</span><span style=color:#f92672>&gt;</span>;       <span style=color:#75715e>/* 资源 ID */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li><li><p><strong>逻辑设备 (Backend)</strong>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-dts data-lang=dts><span style=display:flex><span>auto_vm_be59: <span style=color:#a6e22e>auto_vm_be59</span><span style=color:#f92672>@</span><span style=color:#ae81ff>5C</span><span style=color:#75715e> </span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>qcom</span>,<span style=color:#a6e22e>vm</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>&amp;auto_vm<span style=color:#f92672>&gt;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>qcom</span>,<span style=color:#a6e22e>label</span> <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span><span style=color:#ae81ff>0x5C</span><span style=color:#f92672>&gt;</span>;         <span style=color:#75715e>/* 设备 ID */</span>
</span></span><span style=display:flex><span>};
</span></span></code></pre></div></li></ol><h3 id=运行时交互>运行时交互<a hidden class=anchor aria-hidden=true href=#运行时交互>#</a></h3><ul><li><strong>Gunyah Hypervisor (EL2)</strong>: 启动时读取最终 DTB，记录下 <code>Label 0x5C</code> 对应物理地址 <code>0xB002BE000</code>。</li><li><strong>qcrosvm (EL1 User)</strong>: 启动时参数 <code>--vhost-user-fs ...,label=5C</code>。它发起 <code>ioctl</code> 请求操作 <code>0x5C</code>。</li><li><strong>验证</strong>: Hypervisor 检查 DTB 记录，确认 <code>0x5C</code> 存在且合法，允许 <code>qcrosvm</code> 建立连接。</li></ul><h2 id=5-打包过程-packaging>5. 打包过程 (Packaging)<a hidden class=anchor aria-hidden=true href=#5-打包过程-packaging>#</a></h2><p>生成的 DTB 最终必须被打包进启动镜像才能生效。</p><ol><li><strong>工具</strong>: <code>mkbootimg</code> (Android 标准工具)。</li><li><strong>输入</strong>:<ul><li><code>kernel</code> (<code>Image.gz</code>): Linux Host 内核。</li><li><code>ramdisk</code> (<code>initrd.img</code>): 根文件系统。</li><li><strong><code>dtb</code></strong>: <strong>上一步生成的最终合并 DTB</strong>。</li></ul></li><li><strong>输出</strong>: <code>sa8797-boot.img</code>。</li><li><strong>命令示例</strong> (由 <code>qimage-boot.bbclass</code> 处理):<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span>mkbootimg --kernel Image.gz --dtb final_merged.dtb --ramdisk initrd.img --output boot.img ...
</span></span></code></pre></div></li></ol><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><ol><li><strong>修改</strong>: 您在 <code>sa8797p-voyah-common-overlay.dtso</code> 中添加了 <code>virtio-fs</code> 的 <code>label</code> 和 <code>ring-buffer</code>。</li><li><strong>编译</strong>: Bitbake 调用 Wrapper Makefile，进而调用 Kernel DTC，生成 <code>.dtb</code> 和 <code>.dtbo</code>。</li><li><strong>合并</strong>: <code>merge_dtbs.sh</code> 将 Overlay 合并入 Base DTB。</li><li><strong>打包</strong>: 合并后的 DTB 被 <code>mkbootimg</code> 打包进 <code>boot.img</code>。</li><li><strong>生效</strong>: 设备启动，Bootloader 加载 <code>boot.img</code>，Gunyah 读取 DTB 中的新配置，从而允许您的 <code>qcrosvm</code> 使用新的 label 启动 <code>virtio-fs</code>。</li></ol><pre tabindex=0><code class=language-plantuml data-lang=plantuml>@startuml
!theme plain

package &#34;Base / SoC Definitions&#34; {
    component &#34;sa8x97p.dtsi&#34; as sa8x97p_dtsi
    component &#34;sa8797p.dtsi&#34; as sa8797p_dtsi
    component &#34;sa8x97p-non-safe.dtsi&#34; as nonsafe_dtsi
}

package &#34;Voyah Project (Base DTB)&#34; {
    component &#34;sa8797p-voyah-v20.dts&#34; as voyah_v20_dts #LightBlue
    component &#34;sa8797p-voyah-common.dtsi&#34; as voyah_common_dtsi
    
    voyah_v20_dts -down-&gt; voyah_common_dtsi : includes 
    voyah_common_dtsi -down-&gt; sa8x97p_dtsi : includes 
    voyah_common_dtsi -down-&gt; sa8797p_dtsi : includes 
    voyah_common_dtsi -down-&gt; nonsafe_dtsi : includes 
}

package &#34;Feature Definitions (DTSI)&#34; {
    component &#34;sa8797p-vms.dtsi&#34; as vms_dtsi #LightYellow
    note right of vms_dtsi
      定义 auto_vm 和 virtio-backends
      (Gunyah Resources)
    end note
    component &#34;sa8797p-vfio.dtsi&#34; as vfio_dtsi
    component &#34;sa8797p-dma-heaps.dtsi&#34; as heaps_dtsi
}

package &#34;Generic Overlay (DTBO)&#34; {
    component &#34;sa8797p-overlay.dtso&#34; as overlay_dtso #LightGreen
    
    overlay_dtso -down-&gt; vms_dtsi : includes 
    overlay_dtso -down-&gt; vfio_dtsi : includes 
    overlay_dtso -down-&gt; heaps_dtsi : includes 
}

package &#34;Voyah Project Overlay (DTBO)&#34; {
    component &#34;sa8797p-voyah-v20-overlay.dtso&#34; as voyah_v20_overlay #LightBlue
    component &#34;sa8797p-voyah-common-overlay.dtso&#34; as voyah_common_overlay
    
    voyah_v20_overlay -down-&gt; voyah_common_overlay : includes 
    voyah_common_overlay -down-&gt; overlay_dtso : includes 
}

note bottom of voyah_common_overlay
  **关键修改点**:
  这里引用了 &amp;auto_vm 和 &amp;auto_vm_0
  并追加了更多 label (0x53-0x5B) 
end note

@enduml
</code></pre></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ethen-cao.github.io/ethenslab/>Ethen 的实验室</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src=https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js></script><script>(function(){const e=document.querySelectorAll("pre > code.language-plantuml, pre > code.language-planuml");e.forEach(e=>{const s=e.innerText,o=plantumlEncoder.encode(s),i="https://www.plantuml.com/plantuml/svg/"+o,t=document.createElement("img");t.src=i,t.alt="PlantUML Diagram",t.style.maxWidth="100%";const n=e.parentNode;n.parentNode.replaceChild(t,n)})})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>