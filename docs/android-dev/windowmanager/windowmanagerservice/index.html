<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/ethenslab/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=ethenslab/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>WindowManagerService 解析 | Ethen 的实验室</title>
<meta name="keywords" content="">
<meta name="description" content="WindowManagerService 概述
WindowManagerService（简称WMS）是Android系统中负责窗口（Window）管理的核心系统服务。它是屏幕上所有可见元素的“总管家”，决定了所有窗口的外观、行为和交互方式。
作为Android框架层（Framework Layer）的关键部分，WMS随系统启动，并稳定运行在权限极高的 system_server 进程中。这个位置赋予了它管理所有应用窗口和系统窗口的最高权限。
WMS的角色像一个“总指挥”，它并不亲自执行所有底层操作，而是协调系统中的多个组件来共同完成对窗口的生命周期管理。其核心作用包括：


窗口的创建与管理 (Creation &amp; Management): 与 ActivityManagerService (AMS) 协同工作。当AMS决定要显示某个Activity时，WMS负责为其创建和管理对应的窗口实例（WindowState）。


布局与计算 (Layout &amp; Calculation): 通过自顶向下的遍历，精确计算出每个窗口在屏幕上的最终位置和尺寸（Frame），从而适配不同尺寸的屏幕以及分屏、小窗等各种显示模式。


层级与Z序 (Layer &amp; Z-Order): 维护所有窗口的前后堆叠顺序（Z-Order），决定哪个窗口显示在最上层，哪个窗口被遮挡，确保界面元素以正确的次序呈现。


绘制与合成 (Drawing &amp; Composition): WMS自身不负责绘制窗口内容。它管理窗口的绘图表面（Surface），并将所有窗口的元数据（位置、层级、透明度等）统一提交给 SurfaceFlinger，由后者完成最终的画面合成。


窗口动画 (Window Animation): 负责实现窗口切换、应用启动/退出、调整大小等过程中的过渡动画，为用户提供流畅的视觉体验。


输入事件分发 (Input Event Dispatching): 作为输入系统的关键一环，WMS接收原始的触摸、按键等事件，准确判断事件应该由哪个窗口接收，并交由 InputDispatcher 进行精确投递。


窗口的创建与管理
窗口的创建请求总是由应用进程发起的，WMS 则是请求的响应者和执行者。

触发流程：

应用层调用：当一个 Activity 的 onResume() 回调被触发，准备变得可见时，其内部的 PhoneWindow 会通过 WindowManager.addView() 方法将它的根视图（DecorView）添加到窗口中。这个调用是应用请求显示UI的起点。
ViewRootImpl 的桥梁作用：addView() 的调用会创建一个名为 ViewRootImpl 的关键对象。ViewRootImpl 充当了应用UI和WMS之间的“信使”和“桥梁”。
Binder IPC 调用：ViewRootImpl 通过一个名为 IWindowSession 的 Binder 接口，向 WMS 发起一个远程调用，通常是 addToDisplay()。这个调用会携带两个核心信息：

Window Token: 一个唯一的 Binder 令牌，用于将这个窗口与 AMS 中的 ActivityRecord 关联起来，WMS据此知道这个窗口属于哪个Activity。

WindowManager.LayoutParams: 一个包含了窗口所有期望属性的参数集，如窗口的类型（应用窗口、系统窗口）、尺寸（MATCH_PARENT等）、标志（FLAG_NOT_FOCUSABLE等）和 gravity。



WMS 的响应动作：">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/ethenslab/android-dev/windowmanager/windowmanagerservice/">
<link crossorigin="anonymous" href="/ethenslab/assets/css/stylesheet.567f8bd71a171069f2611f547cfbe0bb49776948da76706c9904cf19ce820b59.css" integrity="sha256-Vn&#43;L1xoXEGnyYR9UfPvgu0l3aUjadnBsmQTPGc6CC1k=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/ethenslab/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/ethenslab/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/ethenslab/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/ethenslab/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/ethenslab/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/ethenslab/android-dev/windowmanager/windowmanagerservice/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/ethenslab/" accesskey="h" title="Ethen 的实验室 (Alt + H)">Ethen 的实验室</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/ethenslab/android-dev/" title="Android系统开发">
                    <span>Android系统开发</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ethenslab/android-automotive-os-dev/" title="Android Automotive">
                    <span>Android Automotive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/ethenslab/ivi-solution/" title="智能座舱方案">
                    <span>智能座舱方案</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/ethenslab/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/ethenslab/android-dev/">Android系统开发</a>&nbsp;»&nbsp;<a href="http://localhost:1313/ethenslab/android-dev/windowmanager/">WindowManager</a></div>
    <h1 class="post-title entry-hint-parent">
      WindowManagerService 解析
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2025-07-29 10:22:54 +0800 CST'>July 29, 2025</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;169 words

</div>
  </header> 
  <div class="post-content"><h2 id="windowmanagerservice-概述">WindowManagerService 概述<a hidden class="anchor" aria-hidden="true" href="#windowmanagerservice-概述">#</a></h2>
<p>WindowManagerService（简称WMS）是Android系统中负责窗口（Window）管理的核心系统服务。它是屏幕上所有可见元素的“总管家”，决定了所有窗口的外观、行为和交互方式。</p>
<p>作为Android框架层（Framework Layer）的关键部分，WMS随系统启动，并稳定运行在权限极高的 system_server 进程中。这个位置赋予了它管理所有应用窗口和系统窗口的最高权限。</p>
<p>WMS的角色像一个“总指挥”，它并不亲自执行所有底层操作，而是协调系统中的多个组件来共同完成对窗口的生命周期管理。其核心作用包括：</p>
<ul>
<li>
<p>窗口的创建与管理 (Creation &amp; Management): 与 ActivityManagerService (AMS) 协同工作。当AMS决定要显示某个Activity时，WMS负责为其创建和管理对应的窗口实例（WindowState）。</p>
</li>
<li>
<p>布局与计算 (Layout &amp; Calculation): 通过自顶向下的遍历，精确计算出每个窗口在屏幕上的最终位置和尺寸（Frame），从而适配不同尺寸的屏幕以及分屏、小窗等各种显示模式。</p>
</li>
<li>
<p>层级与Z序 (Layer &amp; Z-Order): 维护所有窗口的前后堆叠顺序（Z-Order），决定哪个窗口显示在最上层，哪个窗口被遮挡，确保界面元素以正确的次序呈现。</p>
</li>
<li>
<p>绘制与合成 (Drawing &amp; Composition): WMS自身不负责绘制窗口内容。它管理窗口的绘图表面（Surface），并将所有窗口的元数据（位置、层级、透明度等）统一提交给 SurfaceFlinger，由后者完成最终的画面合成。</p>
</li>
<li>
<p>窗口动画 (Window Animation): 负责实现窗口切换、应用启动/退出、调整大小等过程中的过渡动画，为用户提供流畅的视觉体验。</p>
</li>
<li>
<p>输入事件分发 (Input Event Dispatching): 作为输入系统的关键一环，WMS接收原始的触摸、按键等事件，准确判断事件应该由哪个窗口接收，并交由 InputDispatcher 进行精确投递。</p>
</li>
</ul>
<h2 id="窗口的创建与管理">窗口的创建与管理<a hidden class="anchor" aria-hidden="true" href="#窗口的创建与管理">#</a></h2>
<p>窗口的创建请求总是由应用进程发起的，WMS 则是请求的响应者和执行者。</p>
<p><img alt="WindowState 创建时序示意图" loading="lazy" src="/ethenslab/images/windowstate-creation.png"></p>
<p><strong>触发流程</strong>：</p>
<ul>
<li>应用层调用：当一个 Activity 的 onResume() 回调被触发，准备变得可见时，其内部的 PhoneWindow 会通过 WindowManager.addView() 方法将它的根视图（DecorView）添加到窗口中。这个调用是应用请求显示UI的起点。</li>
<li>ViewRootImpl 的桥梁作用：addView() 的调用会创建一个名为 ViewRootImpl 的关键对象。ViewRootImpl 充当了应用UI和WMS之间的“信使”和“桥梁”。</li>
<li>Binder IPC 调用：ViewRootImpl 通过一个名为 IWindowSession 的 Binder 接口，向 WMS 发起一个远程调用，通常是 addToDisplay()。这个调用会携带两个核心信息：
<ul>
<li>Window Token: 一个唯一的 Binder 令牌，用于将这个窗口与 AMS 中的 ActivityRecord 关联起来，WMS据此知道这个窗口属于哪个Activity。
<img alt="WindowToken创建与使用示意图" loading="lazy" src="/ethenslab/images/windowtoken-creation-transport.png"></li>
<li>WindowManager.LayoutParams: 一个包含了窗口所有期望属性的参数集，如窗口的类型（应用窗口、系统窗口）、尺寸（MATCH_PARENT等）、标志（FLAG_NOT_FOCUSABLE等）和 gravity。</li>
</ul>
</li>
</ul>
<p><strong>WMS 的响应动作</strong>：</p>
<ul>
<li>权限验证：WMS 首先会检查调用者是否有权限添加所请求类型的窗口。例如，应用不能随意添加系统警报窗口（TYPE_APPLICATION_OVERLAY），这需要特殊权限。</li>
<li>创建 WindowState 实例：验证通过后，WMS 会 new WindowState(&hellip;)，创建一个新的 WindowState 对象。这个对象会保存所有从 LayoutParams 传递过来的属性。</li>
<li>创建绘图表面 (SurfaceControl)：紧接着，WMS 会为这个新的 WindowState 创建一个对应的 SurfaceControl。这是一个指向 SurfaceFlinger 中一个图层（Layer）的句柄，是窗口能够被看见和渲染的基础。</li>
<li>加入层级树：WMS 根据 Window Token 找到其归属的 Task 和 TaskFragment，然后将新创建的 WindowState 添加到这个容器的子节点列表中，完成了其在窗口层级树中的“注册”。</li>
<li>返回结果给应用：WMS 将 SurfaceControl 的信息以及其他必要的配置返回给应用进程的 ViewRootImpl。ViewRootImpl 收到后，就可以创建出应用侧的 Surface 对象，并开始组织第一次绘制。</li>
<li>调度布局：由于新窗口的加入改变了屏幕的整体布局，WMS 会将布局状态标记为“待定”（dirty），并在下一个合适的时机触发一次 WindowSurfacePlacer 的布局遍历。</li>
</ul>
<p>一旦 WindowState 被创建并加入到层级树中，它就进入了被 WMS 持续管理的“活动”状态。管理主要体现在以下几个方面：</p>
<ul>
<li>状态追踪：WindowState 内部维护了大量的状态标志，如是否可见、是否拥有焦点、是否正在播放动画、是否可以接收触摸事件等。WMS 会根据用户交互和系统事件不断更新这些状态。</li>
<li>布局与定位：在每一次 WindowSurfacePlacer 的布局遍历中，WMS 都会访问每一个 WindowState，读取其 LayoutParams，并结合其父容器的约束，计算出它最终的 Frame（位置和尺寸）。计算结果会通过 SurfaceControl 的事务（Transaction）更新到 SurfaceFlinger。</li>
<li>层级（Z-Order）调整：WMS 维护着一个所有窗口的Z序列表。当用户触摸某个窗口使其获得焦点时，WMS 会调整这个列表，将该窗口及其所属的 Task 提升到更高的层级，以确保它显示在最前面。</li>
<li>响应属性更新：应用可以通过 WindowManager.updateViewLayout() 方法在运行时修改窗口的 LayoutParams。这个请求会通过 Binder 发送到 WMS，WMS 会更新对应的 WindowState 对象的属性，并再次调度布局以应用变更。</li>
<li>输入事件路由：当触摸事件发生时，WMS（与 InputDispatcher 协同）会从Z序最高的窗口开始检查，判断触摸点是否落在该 WindowState 的 Frame 内，以及该窗口是否可以接收输入。一旦找到合适的目标，输入事件就会被派发给该窗口。</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="http://localhost:1313/ethenslab/android-dev/activitymanager/activitymanager/">
    <span class="title">Next »</span>
    <br>
    <span>ActivityManager 深度解析</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/ethenslab/">Ethen 的实验室</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
