<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>WindowManager on Ethen çš„å®éªŒå®¤</title><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/</link><description>Recent content in WindowManager on Ethen çš„å®éªŒå®¤</description><generator>Hugo -- 0.152.2</generator><language>en</language><lastBuildDate>Mon, 29 Sep 2025 10:22:54 +0800</lastBuildDate><atom:link href="https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/index.xml" rel="self" type="application/rss+xml"/><item><title>Activity è·¨å±å¹•è¿ç§»</title><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/activity-reparent/</link><pubDate>Mon, 29 Sep 2025 10:22:54 +0800</pubDate><guid>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/activity-reparent/</guid><description>&lt;p&gt;&lt;img loading="lazy" src="https://ethen-cao.github.io/ethenslab/static/images/activity-reparent.png"&gt;&lt;/p&gt;
&lt;h2 id="åˆ†æ­¥è¯´æ˜ä¸ç”Ÿå‘½å‘¨æœŸæ˜ å°„"&gt;åˆ†æ­¥è¯´æ˜ï¼ˆä¸ç”Ÿå‘½å‘¨æœŸæ˜ å°„ï¼‰&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Launcher å‘èµ·&lt;/strong&gt;ï¼šç”¨æˆ·ç‚¹å‡» â†’ Launcher æ„é€  &lt;code&gt;Intent&lt;/code&gt;ï¼ˆå¸¦ &lt;code&gt;launchDisplayId=2&lt;/code&gt;ï¼‰å¹¶è°ƒç”¨ &lt;code&gt;startActivity()&lt;/code&gt; åˆ° ATMSã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ATMS å†³ç­–&lt;/strong&gt;ï¼šATMS åœ¨ system_server å†…éƒ¨æŸ¥çœ‹ &lt;code&gt;ActivityRecord/TaskRecord&lt;/code&gt;ï¼Œå†³å®šæŠŠæŸä¸ª Task ä» Display1 ç§»åˆ° Display2ï¼ˆä¿®æ”¹ parentï¼š&lt;code&gt;TaskDisplayArea&lt;/code&gt;ï¼‰ã€‚è¿™ä¸€æ­¥åªæ˜¯æœåŠ¡ç«¯çš„æ•°æ®ç»“æ„å˜åŒ–ï¼Œä¸ä¼šç›´æ¥è°ƒç”¨åº”ç”¨å¯¹è±¡çš„æ–¹æ³•ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åè°ƒ WMS&lt;/strong&gt;ï¼šATMS é€šçŸ¥ WMS å‡†å¤‡çª—å£åˆ‡æ¢ï¼ˆåº”ç”¨ transitionï¼‰ï¼Œä»¥ä¾¿åœ¨ surface å±‚é¢ä¸Šèƒ½åšå¹³æ»‘è¿ç§»ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æš‚åœç›®æ ‡ Display ä¸Šçš„å½“å‰å‰å°&lt;/strong&gt;ï¼ˆActivityBï¼‰ï¼šä¸ºäº†ä¿è¯ç›®æ ‡ Display ä¸Šåªä¼šæœ‰ä¸€ä¸ª resumed Activityï¼ŒATMS å…ˆå¯¹ Display2 ä¸Šå½“å‰çš„å‰å° Activityï¼ˆActivityBï¼‰å‘ &lt;code&gt;IApplicationThread.schedulePauseActivity&lt;/code&gt;ï¼Œç­‰å¾…åº”ç”¨è¿›ç¨‹å› ACKï¼ˆpauseFinishedï¼‰ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æš‚åœå°†è¦è¢«ç§»åŠ¨çš„ ActivityAï¼ˆæº Display1ï¼‰&lt;/strong&gt;ï¼šATMS å¯¹ ActivityA å‘ &lt;code&gt;schedulePauseActivity&lt;/code&gt;ï¼Œåº”ç”¨è¿›ç¨‹è¿›å…¥ &lt;code&gt;onPause()&lt;/code&gt;ï¼Œå¹¶å› ACKã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è¿™ä¸€æ­¥éå¸¸é‡è¦ï¼šæŠŠè¦ç§»åŠ¨çš„ Activity ä¿æŒåœ¨é-resumed çŠ¶æ€ï¼Œä¾¿äºæ”¹å˜å®ƒçš„çª—å£æ‰€å± Display/Surfaceã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;WMS åš Window/Surface reparent&lt;/strong&gt;ï¼šATMS è¯·æ±‚ WMS å°†å¯¹åº”çš„ &lt;code&gt;WindowContainer&lt;/code&gt;/task çª—å£æ ‘ä» Display1 ç§»åˆ° Display2ï¼›WMS åœ¨ SurfaceControl å±‚ï¼ˆé€šè¿‡ SurfaceFlingerï¼‰æŠŠ layer é‡æ–° attach åˆ°ç›®æ ‡ Display çš„ layer stackã€‚&lt;/p&gt;</description></item><item><title>Insets animation flow</title><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/insets_animation_flow/</link><pubDate>Mon, 29 Sep 2025 10:22:54 +0800</pubDate><guid>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/insets_animation_flow/</guid><description>&lt;p&gt;Insets åŠ¨ç”» API çš„æ ¸å¿ƒä»·å€¼åœ¨äº&lt;strong&gt;æ¶ˆé™¤ç³»ç»Ÿ UI åŠ¨ç”»å’Œåº”ç”¨ UI åŠ¨ç”»ä¹‹é—´çš„â€œå‰²è£‚æ„Ÿâ€&lt;/strong&gt;ï¼Œå°†ä¸¤è€…èåˆæˆä¸€ä¸ªå¹³æ»‘ã€æ— ç¼çš„æ•´ä½“ã€‚&lt;/p&gt;
&lt;p&gt;ä»¥ä¸‹æ˜¯ä¸€äº›å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼Œä»æœ€å¸¸è§åˆ°æ›´é«˜çº§çš„äº¤äº’ï¼š&lt;/p&gt;
&lt;h3 id="1-æ ¸å¿ƒåœºæ™¯é”®ç›˜çš„æ˜¾ç¤ºä¸éšè—-messaging--input"&gt;1. æ ¸å¿ƒåœºæ™¯ï¼šé”®ç›˜çš„æ˜¾ç¤ºä¸éšè— (Messaging &amp;amp; Input)&lt;/h3&gt;
&lt;p&gt;è¿™æ˜¯æœ€ç»å…¸ã€æœ€èƒ½ä½“ç°å…¶ä»·å€¼çš„åœºæ™¯ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¼ ç»Ÿä½“éªŒ (é—®é¢˜æ‰€åœ¨):&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨ä¸€ä¸ªèŠå¤©åº”ç”¨é‡Œï¼Œä½ ç‚¹å‡»åº•éƒ¨çš„è¾“å…¥æ¡†ã€‚&lt;/li&gt;
&lt;li&gt;é”®ç›˜ä»åº•éƒ¨æ»‘å‡ºï¼Œè¿™ä¸ªåŠ¨ç”»æ˜¯ç³»ç»Ÿè´Ÿè´£çš„ã€‚&lt;/li&gt;
&lt;li&gt;åœ¨é”®ç›˜åŠ¨ç”»çš„åŒæ—¶ï¼Œåº”ç”¨æ”¶åˆ°ä¸€ä¸ªâ€œå¯ç”¨ç©ºé—´å˜å°äº†â€çš„é€šçŸ¥ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨ä¸ºäº†é˜²æ­¢è¾“å…¥æ¡†è¢«é”®ç›˜é®æŒ¡ï¼Œåªèƒ½&lt;strong&gt;è·³å˜å¼åœ°&lt;/strong&gt;å°†æ•´ä¸ªèŠå¤©åˆ—è¡¨å’Œè¾“å…¥æ¡†å‘ä¸Šç§»åŠ¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“æœï¼š&lt;/strong&gt; ç”¨æˆ·ä¼šæ„Ÿè§‰é”®ç›˜å’ŒèŠå¤©ç•Œé¢æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ä¸œè¥¿åœ¨åŠ¨ï¼Œä½“éªŒå¾ˆç”Ÿç¡¬ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ Insets åŠ¨ç”» (è§£å†³æ–¹æ¡ˆ):&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç‚¹å‡»è¾“å…¥æ¡†ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ¥ç®¡é”®ç›˜çš„åŠ¨ç”»æ§åˆ¶æƒã€‚&lt;/li&gt;
&lt;li&gt;åœ¨é”®ç›˜ä»åº•éƒ¨å‘ä¸Šæ»‘å‡ºçš„æ¯ä¸€å¸§ï¼Œåº”ç”¨éƒ½ç²¾ç¡®åœ°è®¡ç®—å‡ºé”®ç›˜çš„å½“å‰é«˜åº¦ï¼Œå¹¶&lt;strong&gt;åŒæ­¥åœ°ã€ç­‰é€Ÿåœ°&lt;/strong&gt;å°†è‡ªå·±çš„èŠå¤©åˆ—è¡¨å’Œè¾“å…¥æ¡†ä¹Ÿå‘ä¸Šæ¨ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“æœï¼š&lt;/strong&gt; åœ¨ç”¨æˆ·çœ‹æ¥ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯ä¸€ä¸ªè¿è´¯çš„åŠ¨ç”»ï¼š&lt;strong&gt;ä»¿ä½›æ˜¯é”®ç›˜â€œæ¨â€ç€èŠå¤©å†…å®¹å‘ä¸Šç§»åŠ¨&lt;/strong&gt;ï¼Œéå¸¸è‡ªç„¶ã€æµç•…ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th style="text-align: left"&gt;åœºæ™¯&lt;/th&gt;
&lt;th style="text-align: left"&gt;ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜&lt;/th&gt;
&lt;th style="text-align: left"&gt;Insets åŠ¨ç”»çš„æ•ˆæœ&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td style="text-align: left"&gt;èŠå¤©åº”ç”¨&lt;/td&gt;
&lt;td style="text-align: left"&gt;é”®ç›˜åŠ¨ç”»ä¸å†…å®¹ç§»åŠ¨åˆ†ç¦»ï¼Œå†…å®¹&lt;strong&gt;è·³å˜&lt;/strong&gt;&lt;/td&gt;
&lt;td style="text-align: left"&gt;é”®ç›˜&lt;strong&gt;å¹³æ»‘æ¨èµ·&lt;/strong&gt;å†…å®¹ï¼ŒåŠ¨ç”»æ— ç¼è¡”æ¥&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="2-æ²‰æµ¸å¼æ¨¡å¼çš„è¿‡æ¸¡-video--photo-apps"&gt;2. æ²‰æµ¸å¼æ¨¡å¼çš„è¿‡æ¸¡ (Video &amp;amp; Photo Apps)&lt;/h3&gt;
&lt;p&gt;å½“åº”ç”¨è¿›å…¥æˆ–é€€å‡ºå…¨å±ï¼ˆæ²‰æµ¸å¼ï¼‰æ¨¡å¼æ—¶ï¼ŒçŠ¶æ€æ å’Œå¯¼èˆªæ ä¼šæ˜¾ç¤ºæˆ–éšè—ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¼ ç»Ÿä½“éªŒ (é—®é¢˜æ‰€åœ¨):&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½ åœ¨ä¸€ä¸ªç›¸å†Œåº”ç”¨ä¸­å…¨å±æŸ¥çœ‹ä¸€å¼ å›¾ç‰‡ã€‚ä½ ç‚¹å‡»å±å¹•ï¼Œå¸Œæœ›é€€å‡ºå…¨å±ã€‚&lt;/li&gt;
&lt;li&gt;ç³»ç»ŸçŠ¶æ€æ å’Œå¯¼èˆªæ &lt;strong&gt;çªç„¶å‡ºç°&lt;/strong&gt;æˆ–&lt;strong&gt;æ·¡å…¥&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨å†…å®¹åŒºåŸŸï¼ˆå›¾ç‰‡ï¼‰ä¸ºäº†é€‚åº”å˜å°çš„ç©ºé—´ï¼Œ&lt;strong&gt;çªç„¶ç¼©æ”¾æˆ–ç§»åŠ¨&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“æœï¼š&lt;/strong&gt; åŠ¨ç”»ä¸åè°ƒï¼Œæ„Ÿè§‰åƒæ˜¯ç³»ç»Ÿ UI ç²—æš´åœ°â€œè¦†ç›–â€åœ¨äº†å†…å®¹ä¸Šã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ Insets åŠ¨ç”» (è§£å†³æ–¹æ¡ˆ):&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç‚¹å‡»å±å¹•ã€‚&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ¥ç®¡çŠ¶æ€æ å’Œå¯¼èˆªæ çš„åŠ¨ç”»ã€‚&lt;/li&gt;
&lt;li&gt;å½“çŠ¶æ€æ ä»é¡¶éƒ¨æ»‘å…¥ã€å¯¼èˆªæ ä»åº•éƒ¨æ»‘å…¥çš„æ¯ä¸€å¸§ï¼Œåº”ç”¨éƒ½&lt;strong&gt;åŒæ­¥åœ°ã€å¹³æ»‘åœ°&lt;/strong&gt;å°†å›¾ç‰‡è¿›è¡Œç¼©æ”¾å’Œå¹³ç§»ï¼Œä½¿å…¶æ­£å¥½å¡«å……åœ¨ä¸¤ä¸ªç³»ç»Ÿæ ä¹‹é—´çš„æ–°ç©ºé—´é‡Œã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç»“æœï¼š&lt;/strong&gt; æ•´ä¸ªè¿‡æ¸¡éå¸¸ä¼˜é›…ï¼Œæ„Ÿè§‰åƒæ˜¯&lt;strong&gt;ç”»é¢å’Œç³»ç»Ÿæ ä¸€èµ·æ„æˆäº†ä¸€åœºç²¾å¿ƒç¼–æ’çš„è½¬åœºåŠ¨ç”»&lt;/strong&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="3-é«˜çº§äº¤äº’åœºæ™¯æ‰‹åŠ¿æ§åˆ¶åŠ¨ç”»"&gt;3. é«˜çº§äº¤äº’åœºæ™¯ï¼šæ‰‹åŠ¿æ§åˆ¶åŠ¨ç”»&lt;/h3&gt;
&lt;p&gt;è¿™æ˜¯ Insets åŠ¨ç”» API å¼ºå¤§çµæ´»æ€§çš„ä½“ç°ï¼Œå…è®¸å¼€å‘è€…åˆ›é€ æ›´ä¸°å¯Œçš„äº¤äº’ã€‚&lt;/p&gt;</description></item><item><title>SplitScreenController flow</title><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/splitscreen-wmshell/</link><pubDate>Mon, 29 Sep 2025 10:22:54 +0800</pubDate><guid>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/splitscreen-wmshell/</guid><description>&lt;h2 id="æ—¶åºå›¾"&gt;æ—¶åºå›¾&lt;/h2&gt;
&lt;p&gt;&lt;img loading="lazy" src="https://ethen-cao.github.io/ethenslab/images/splitscreen_wmshell.png"&gt;&lt;/p&gt;
&lt;h2 id="debug"&gt;Debug&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;æ‰“å°åˆ†å±åŒºåŸŸ&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;adb shell dumpsys activity service SystemUIService WMShell
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;dump SystemUI&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ adb shell dumpsys activity service SystemUIService
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Enable protolog&lt;/p&gt;
&lt;p&gt;å‚è€ƒ &lt;code&gt;frameworks/base/libs/WindowManager/Shell/src/com/android/wm/shell/ProtoLogController.java&lt;/code&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;helpå‘½ä»¤ï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ adb shell dumpsys activity service SystemUIService WMShell help
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;æŸ¥çœ‹protolog statusï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; $ adb shell dumpsys activity service SystemUIService WMShell protolog status
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; SERVICE com.android.systemui/.SystemUIService e73cb38 pid&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;4871&lt;/span&gt; user&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Client:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; com.android.systemui.wmshell.WMShell:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ----------------------------------------------------------------------------
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; ProtoLog status: Disabled
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Enabled log groups:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Proto: TEST_GROUP WM_DEBUG_ADD_REMOVE WM_DEBUG_ANIM WM_DEBUG_APP_TRANSITIONS WM_DEBUG_APP_TRANSITIONS_ANIM WM_DEBUG_BACK_PREVIEW WM_DEBUG_BOOT WM_DEBUG_CONFIGURATION WM_DEBUG_CONTAINERS WM_DEBUG_CONTENT_RECORDING WM_DEBUG_DRAW WM_DEBUG_DREAM WM_DEBUG_FOCUS WM_DEBUG_FOCUS_LIGHT WM_DEBUG_IME WM_DEBUG_IMMERSIVE WM_DEBUG_KEEP_SCREEN_ON WM_DEBUG_LOCKTASK WM_DEBUG_ORIENTATION WM_DEBUG_RECENTS_ANIMATIONS WM_DEBUG_REMOTE_ANIMATIONS WM_DEBUG_RESIZE WM_DEBUG_SCREEN_ON WM_DEBUG_STARTING_WINDOW WM_DEBUG_STATES WM_DEBUG_SWITCH WM_DEBUG_SYNC_ENGINE WM_DEBUG_TASKS WM_DEBUG_WALLPAPER WM_DEBUG_WINDOW_INSETS WM_DEBUG_WINDOW_MOVEMENT WM_DEBUG_WINDOW_ORGANIZER WM_DEBUG_WINDOW_TRANSITIONS WM_DEBUG_WINDOW_TRANSITIONS_MIN WM_ERROR WM_SHELL_BACK_PREVIEW WM_SHELL_DESKTOP_MODE WM_SHELL_DRAG_AND_DROP WM_SHELL_FLOATING_APPS WM_SHELL_FOLDABLE WM_SHELL_INIT WM_SHELL_PICTURE_IN_PICTURE WM_SHELL_RECENTS_TRANSITION WM_SHELL_RECENT_TASKS WM_SHELL_SPLIT_SCREEN WM_SHELL_STARTING_WINDOW WM_SHELL_SYSUI_EVENTS WM_SHELL_TASK_ORG WM_SHELL_TRANSITIONS WM_SHOW_SURFACE_ALLOC WM_SHOW_TRANSACTIONS
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Logcat: WM_DEBUG_BACK_PREVIEW WM_DEBUG_CONTENT_RECORDING WM_DEBUG_DREAM WM_DEBUG_WINDOW_TRANSITIONS_MIN WM_ERROR WM_SHELL_BACK_PREVIEW WM_SHELL_DRAG_AND_DROP WM_SHELL_INIT WM_SHELL_PICTURE_IN_PICTURE WM_SHELL_RECENTS_TRANSITION WM_SHELL_SPLIT_SCREEN WM_SHELL_TRANSITIONS
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Logging definitions loaded: &lt;span style="color:#ae81ff"&gt;0&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; Dump took 2ms
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;ul&gt;
&lt;li&gt;enable protologï¼š&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ adb shell dumpsys activity service SystemUIService WMShell protolog enable WM_SHELL_TRANSITIONS WM_SHELL_DRAG_AND_DROP WM_SHELL_SPLIT_SCREEN
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ adb shell dumpsys activity service SystemUIService WMShell protolog start
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ol&gt;</description></item><item><title>WindowManagerService è§£æ</title><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/windowmanagerservice/</link><pubDate>Tue, 29 Jul 2025 10:22:54 +0800</pubDate><guid>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/windowmanagerservice/</guid><description>&lt;h2 id="windowmanagerservice-æ¦‚è¿°"&gt;WindowManagerService æ¦‚è¿°&lt;/h2&gt;
&lt;p&gt;WindowManagerServiceï¼ˆç®€ç§°WMSï¼‰æ˜¯Androidç³»ç»Ÿä¸­è´Ÿè´£çª—å£ï¼ˆWindowï¼‰ç®¡ç†çš„æ ¸å¿ƒç³»ç»ŸæœåŠ¡ã€‚å®ƒæ˜¯å±å¹•ä¸Šæ‰€æœ‰å¯è§å…ƒç´ çš„â€œæ€»ç®¡å®¶â€ï¼Œå†³å®šäº†æ‰€æœ‰çª—å£çš„å¤–è§‚ã€è¡Œä¸ºå’Œäº¤äº’æ–¹å¼ã€‚&lt;/p&gt;
&lt;p&gt;ä½œä¸ºAndroidæ¡†æ¶å±‚ï¼ˆFramework Layerï¼‰çš„å…³é”®éƒ¨åˆ†ï¼ŒWMSéšç³»ç»Ÿå¯åŠ¨ï¼Œå¹¶ç¨³å®šè¿è¡Œåœ¨æƒé™æé«˜çš„ system_server è¿›ç¨‹ä¸­ã€‚è¿™ä¸ªä½ç½®èµ‹äºˆäº†å®ƒç®¡ç†æ‰€æœ‰åº”ç”¨çª—å£å’Œç³»ç»Ÿçª—å£çš„æœ€é«˜æƒé™ã€‚&lt;/p&gt;
&lt;p&gt;WMSçš„è§’è‰²åƒä¸€ä¸ªâ€œæ€»æŒ‡æŒ¥â€ï¼Œå®ƒå¹¶ä¸äº²è‡ªæ‰§è¡Œæ‰€æœ‰åº•å±‚æ“ä½œï¼Œè€Œæ˜¯åè°ƒç³»ç»Ÿä¸­çš„å¤šä¸ªç»„ä»¶æ¥å…±åŒå®Œæˆå¯¹çª—å£çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚å…¶æ ¸å¿ƒä½œç”¨åŒ…æ‹¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;çª—å£çš„åˆ›å»ºä¸ç®¡ç† (Creation &amp;amp; Management): ä¸ ActivityManagerService (AMS) ååŒå·¥ä½œã€‚å½“AMSå†³å®šè¦æ˜¾ç¤ºæŸä¸ªActivityæ—¶ï¼ŒWMSè´Ÿè´£ä¸ºå…¶åˆ›å»ºå’Œç®¡ç†å¯¹åº”çš„çª—å£å®ä¾‹ï¼ˆWindowStateï¼‰ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¸ƒå±€ä¸è®¡ç®— (Layout &amp;amp; Calculation): é€šè¿‡è‡ªé¡¶å‘ä¸‹çš„éå†ï¼Œç²¾ç¡®è®¡ç®—å‡ºæ¯ä¸ªçª—å£åœ¨å±å¹•ä¸Šçš„æœ€ç»ˆä½ç½®å’Œå°ºå¯¸ï¼ˆFrameï¼‰ï¼Œä»è€Œé€‚é…ä¸åŒå°ºå¯¸çš„å±å¹•ä»¥åŠåˆ†å±ã€å°çª—ç­‰å„ç§æ˜¾ç¤ºæ¨¡å¼ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å±‚çº§ä¸Zåº (Layer &amp;amp; Z-Order): ç»´æŠ¤æ‰€æœ‰çª—å£çš„å‰åå †å é¡ºåºï¼ˆZ-Orderï¼‰ï¼Œå†³å®šå“ªä¸ªçª—å£æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚ï¼Œå“ªä¸ªçª—å£è¢«é®æŒ¡ï¼Œç¡®ä¿ç•Œé¢å…ƒç´ ä»¥æ­£ç¡®çš„æ¬¡åºå‘ˆç°ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç»˜åˆ¶ä¸åˆæˆ (Drawing &amp;amp; Composition): WMSè‡ªèº«ä¸è´Ÿè´£ç»˜åˆ¶çª—å£å†…å®¹ã€‚å®ƒç®¡ç†çª—å£çš„ç»˜å›¾è¡¨é¢ï¼ˆSurfaceï¼‰ï¼Œå¹¶å°†æ‰€æœ‰çª—å£çš„å…ƒæ•°æ®ï¼ˆä½ç½®ã€å±‚çº§ã€é€æ˜åº¦ç­‰ï¼‰ç»Ÿä¸€æäº¤ç»™ SurfaceFlingerï¼Œç”±åè€…å®Œæˆæœ€ç»ˆçš„ç”»é¢åˆæˆã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;çª—å£åŠ¨ç”» (Window Animation): è´Ÿè´£å®ç°çª—å£åˆ‡æ¢ã€åº”ç”¨å¯åŠ¨/é€€å‡ºã€è°ƒæ•´å¤§å°ç­‰è¿‡ç¨‹ä¸­çš„è¿‡æ¸¡åŠ¨ç”»ï¼Œä¸ºç”¨æˆ·æä¾›æµç•…çš„è§†è§‰ä½“éªŒã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;è¾“å…¥äº‹ä»¶åˆ†å‘ (Input Event Dispatching): ä½œä¸ºè¾“å…¥ç³»ç»Ÿçš„å…³é”®ä¸€ç¯ï¼ŒWMSæ¥æ”¶åŸå§‹çš„è§¦æ‘¸ã€æŒ‰é”®ç­‰äº‹ä»¶ï¼Œå‡†ç¡®åˆ¤æ–­äº‹ä»¶åº”è¯¥ç”±å“ªä¸ªçª—å£æ¥æ”¶ï¼Œå¹¶äº¤ç”± InputDispatcher è¿›è¡Œç²¾ç¡®æŠ•é€’ã€‚&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="çª—å£çš„åˆ›å»ºä¸ç®¡ç†"&gt;çª—å£çš„åˆ›å»ºä¸ç®¡ç†&lt;/h2&gt;
&lt;p&gt;çª—å£çš„åˆ›å»ºè¯·æ±‚æ€»æ˜¯ç”±åº”ç”¨è¿›ç¨‹å‘èµ·çš„ï¼ŒWMS åˆ™æ˜¯è¯·æ±‚çš„å“åº”è€…å’Œæ‰§è¡Œè€…ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img alt="WindowState åˆ›å»ºæ—¶åºç¤ºæ„å›¾" loading="lazy" src="https://ethen-cao.github.io/ethenslab/images/windowstate-creation.png"&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;è§¦å‘æµç¨‹&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åº”ç”¨å±‚è°ƒç”¨ï¼šå½“ä¸€ä¸ª Activity çš„ onResume() å›è°ƒè¢«è§¦å‘ï¼Œå‡†å¤‡å˜å¾—å¯è§æ—¶ï¼Œå…¶å†…éƒ¨çš„ PhoneWindow ä¼šé€šè¿‡ WindowManager.addView() æ–¹æ³•å°†å®ƒçš„æ ¹è§†å›¾ï¼ˆDecorViewï¼‰æ·»åŠ åˆ°çª—å£ä¸­ã€‚è¿™ä¸ªè°ƒç”¨æ˜¯åº”ç”¨è¯·æ±‚æ˜¾ç¤ºUIçš„èµ·ç‚¹ã€‚&lt;/li&gt;
&lt;li&gt;ViewRootImpl çš„æ¡¥æ¢ä½œç”¨ï¼šaddView() çš„è°ƒç”¨ä¼šåˆ›å»ºä¸€ä¸ªåä¸º ViewRootImpl çš„å…³é”®å¯¹è±¡ã€‚ViewRootImpl å……å½“äº†åº”ç”¨UIå’ŒWMSä¹‹é—´çš„â€œä¿¡ä½¿â€å’Œâ€œæ¡¥æ¢â€ã€‚&lt;/li&gt;
&lt;li&gt;Binder IPC è°ƒç”¨ï¼šViewRootImpl é€šè¿‡ä¸€ä¸ªåä¸º IWindowSession çš„ Binder æ¥å£ï¼Œå‘ WMS å‘èµ·ä¸€ä¸ªè¿œç¨‹è°ƒç”¨ï¼Œé€šå¸¸æ˜¯ addToDisplay()ã€‚è¿™ä¸ªè°ƒç”¨ä¼šæºå¸¦ä¸¤ä¸ªæ ¸å¿ƒä¿¡æ¯ï¼š
&lt;ul&gt;
&lt;li&gt;Window Token: ä¸€ä¸ªå”¯ä¸€çš„ Binder ä»¤ç‰Œï¼Œç”¨äºå°†è¿™ä¸ªçª—å£ä¸ AMS ä¸­çš„ ActivityRecord å…³è”èµ·æ¥ï¼ŒWMSæ®æ­¤çŸ¥é“è¿™ä¸ªçª—å£å±äºå“ªä¸ªActivityã€‚
&lt;img alt="WindowTokenåˆ›å»ºä¸ä½¿ç”¨ç¤ºæ„å›¾" loading="lazy" src="https://ethen-cao.github.io/ethenslab/images/windowtoken-creation-transport.png"&gt;&lt;/li&gt;
&lt;li&gt;WindowManager.LayoutParams: ä¸€ä¸ªåŒ…å«äº†çª—å£æ‰€æœ‰æœŸæœ›å±æ€§çš„å‚æ•°é›†ï¼Œå¦‚çª—å£çš„ç±»å‹ï¼ˆåº”ç”¨çª—å£ã€ç³»ç»Ÿçª—å£ï¼‰ã€å°ºå¯¸ï¼ˆMATCH_PARENTç­‰ï¼‰ã€æ ‡å¿—ï¼ˆFLAG_NOT_FOCUSABLEç­‰ï¼‰å’Œ gravityã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;WMS çš„å“åº”åŠ¨ä½œ&lt;/strong&gt;ï¼š&lt;/p&gt;</description></item><item><title/><link>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/wmshell/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://ethen-cao.github.io/ethenslab/android-dev/windowmanager/wmshell/</guid><description>&lt;h3 id="transitionhandler"&gt;TransitionHandler&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;TransitionHandler&lt;/code&gt; æ˜¯ä¸€ä¸ª&lt;strong&gt;æ¥å£ (Interface)&lt;/strong&gt;ï¼Œå®ƒä¸º Shell åŠ¨ç”»ç³»ç»Ÿå®šä¹‰äº†ä¸€ä¸ª**â€œåŠ¨ç”»å¤„ç†å™¨â€&lt;strong&gt;çš„æ ‡å‡†æˆ–&lt;/strong&gt;å¥‘çº¦**ã€‚&lt;/p&gt;
&lt;p&gt;å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ª&lt;strong&gt;ä¸“å®¶å²—ä½è¯´æ˜ä¹¦&lt;/strong&gt; ğŸ“œã€‚ä»»ä½•ä¸€ä¸ªç±»ï¼Œåªè¦å®ç°äº† &lt;code&gt;TransitionHandler&lt;/code&gt; æ¥å£ï¼Œå°±æ„å‘³ç€å®ƒå…·å¤‡äº†å¤„ç†ä¸€ç±»ç‰¹å®šçª—å£è¿‡æ¸¡åŠ¨ç”»çš„ä¸“ä¸šèƒ½åŠ›ï¼Œå¹¶å¯ä»¥è¢« &lt;code&gt;Transitions&lt;/code&gt; ï¼ˆåŠ¨ç”»æ€»è°ƒåº¦å®¤ï¼‰ç»Ÿä¸€ç®¡ç†å’Œè°ƒåº¦ã€‚&lt;/p&gt;
&lt;h4 id="æ ¸å¿ƒèŒè´£"&gt;æ ¸å¿ƒèŒè´£&lt;/h4&gt;
&lt;p&gt;ä¸€ä¸ª &lt;code&gt;TransitionHandler&lt;/code&gt; å®ç°ç±»ï¼Œå…¶æ ¸å¿ƒèŒè´£ä¸»è¦æœ‰ä¸¤ä¸ªï¼š&lt;/p&gt;
&lt;h5 id="1-è®¤é¢†ä»»åŠ¡-claim-the-job---é€šè¿‡-handlerequest-æ–¹æ³•"&gt;1. è®¤é¢†ä»»åŠ¡ (Claim the Job) - é€šè¿‡ &lt;code&gt;handleRequest&lt;/code&gt; æ–¹æ³•&lt;/h5&gt;
&lt;p&gt;è¿™æ˜¯ &lt;code&gt;TransitionHandler&lt;/code&gt; &lt;strong&gt;æœ€å…³é”®&lt;/strong&gt;çš„èŒè´£ã€‚å½“ &lt;code&gt;Transitions.requestStartTransition&lt;/code&gt; æ–¹æ³•æ”¶åˆ°ä¸€ä¸ªæ¥è‡ªç³»ç»Ÿçš„åŠ¨ç”»è¯·æ±‚æ—¶ï¼Œå®ƒä¼šéå†å…¶å†…éƒ¨çš„ &lt;code&gt;Handler&lt;/code&gt; åˆ—è¡¨ï¼Œå¹¶è°ƒç”¨æ¯ä¸ª &lt;code&gt;Handler&lt;/code&gt; çš„ &lt;code&gt;handleRequest&lt;/code&gt; æ–¹æ³•ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;â€œè¿™æ˜¯æˆ‘çš„æ´»å„¿å—ï¼Ÿâ€&lt;/strong&gt;: åœ¨ &lt;code&gt;handleRequest&lt;/code&gt; æ–¹æ³•å†…éƒ¨ï¼Œ&lt;code&gt;Handler&lt;/code&gt; ä¼šæ£€æŸ¥ä¼ å…¥çš„ &lt;code&gt;TransitionRequestInfo&lt;/code&gt;ï¼ˆåŠ¨ç”»è¯·æ±‚ä¿¡æ¯ï¼‰ï¼Œæ ¹æ®åŠ¨ç”»çš„ç±»å‹ (&lt;code&gt;type&lt;/code&gt;)ã€è§¦å‘ä»»åŠ¡ (&lt;code&gt;triggerTask&lt;/code&gt;)ã€çª—å£æ¨¡å¼ç­‰ä¿¡æ¯ï¼Œæ¥åˆ¤æ–­è¿™æ˜¯å¦æ˜¯è‡ªå·±åº”è¯¥å¤„ç†çš„åŠ¨ç”»åœºæ™¯ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¾‹å¦‚ï¼Œ&lt;code&gt;RecentsTransitionHandler&lt;/code&gt; ä¼šæ£€æŸ¥åŠ¨ç”»ç±»å‹æ˜¯å¦ä¸â€œæœ€è¿‘ä»»åŠ¡â€ç›¸å…³ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;UnfoldTransitionHandler&lt;/code&gt; ä¼šæ£€æŸ¥è®¾å¤‡æ˜¯å¦æ­£åœ¨æŠ˜å /å±•å¼€ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¦‚ä½•è®¤é¢†&lt;/strong&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœ &lt;code&gt;Handler&lt;/code&gt; å†³å®šå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª &lt;code&gt;WindowContainerTransaction&lt;/code&gt; å¯¹è±¡ï¼ˆå³ä½¿è¿™ä¸ªå¯¹è±¡æ˜¯ç©ºçš„ï¼‰ã€‚è¿™å°±åƒä¸¾æ‰‹è¯´ï¼šâ€œè¿™ä¸ªæˆ‘æ¥å¤„ç†ï¼â€&lt;/li&gt;
&lt;li&gt;å¦‚æœ &lt;code&gt;Handler&lt;/code&gt; è®¤ä¸ºè¿™ä¸ªè¯·æ±‚ä¸å½’è‡ªå·±ç®¡ï¼Œå®ƒä¼šè¿”å› &lt;code&gt;null&lt;/code&gt;ã€‚&lt;code&gt;Transitions&lt;/code&gt; çœ‹åˆ° &lt;code&gt;null&lt;/code&gt; åï¼Œå°±ä¼šç»§ç»­å»é—®ä¸‹ä¸€ä¸ª &lt;code&gt;Handler&lt;/code&gt;ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id="2-æ‰§è¡ŒåŠ¨ç”»-execute-the-animation"&gt;2. æ‰§è¡ŒåŠ¨ç”» (Execute the Animation)&lt;/h5&gt;
&lt;p&gt;ä¸€æ—¦ä¸€ä¸ª &lt;code&gt;Handler&lt;/code&gt; é€šè¿‡è¿”å›é &lt;code&gt;null&lt;/code&gt; çš„ &lt;code&gt;WCT&lt;/code&gt; æˆåŠŸâ€œè®¤é¢†â€äº†ä¸€ä¸ª &lt;code&gt;Transition&lt;/code&gt;ï¼Œå®ƒå°±&lt;strong&gt;å…¨æƒè´Ÿè´£&lt;/strong&gt;è¿™ä¸ª &lt;code&gt;Transition&lt;/code&gt; çš„åŠ¨ç”»å®ç°ã€‚&lt;/p&gt;</description></item></channel></rss>