<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Ethen 的实验室</title><meta name=keywords content><meta name=description content="S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification）

适用对象：NXP S32K324（S32K3 系列）
升级链路假设：SoC 通过 SPI 向 MCU 下发升级镜像；MCU 将新镜像写入 Passive（B） 区域；通过 HSE A/B Swap 在复位后完成映射切换并启动新镜像。
已知约束：Bootloader 不在 swap 区域内；B 区物理地址范围与链接地址 TBD。
术语说明：本文“分区 A/B”指 Flash 双镜像（Active/Passive block remapping），非 Linux 分区表概念。


0. 文档控制

文档编号：SDS-S32K324-OTA-ABSWAP-001
版本：v0.9（Draft）
状态：Draft
作者：TBD
评审人：TBD
生效日期：TBD

变更记录

  
      
          版本
          日期
          变更说明
          作者
      
  
  
      
          v0.9
          TBD
          初版：定义 OTA、A/B swap、回滚策略与排障流程
          TBD
      
  


1. 引言
1.1 目的
定义 S32K324 上 OTA + A/B Swap 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。"><meta name=author content><link rel=canonical href=https://ethen-cao.github.io/ethenslab/mcu/s32kxx-ota/><link crossorigin=anonymous href=/ethenslab/assets/css/stylesheet.a1917769c3c78460b110da6d7905321bb53af4a56f22ba4cc0de824cf4d097ab.css integrity="sha256-oZF3acPHhGCxENpteQUyG7U69KVvIrpMwN6CTPTQl6s=" rel="preload stylesheet" as=style><link rel=icon href=https://ethen-cao.github.io/ethenslab/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://ethen-cao.github.io/ethenslab/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://ethen-cao.github.io/ethenslab/favicon-32x32.png><link rel=apple-touch-icon href=https://ethen-cao.github.io/ethenslab/apple-touch-icon.png><link rel=mask-icon href=https://ethen-cao.github.io/ethenslab/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://ethen-cao.github.io/ethenslab/mcu/s32kxx-ota/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://ethen-cao.github.io/ethenslab/mcu/s32kxx-ota/"><meta property="og:site_name" content="Ethen 的实验室"><meta property="og:title" content="Ethen 的实验室"><meta property="og:description" content="S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification） 适用对象：NXP S32K324（S32K3 系列） 升级链路假设：SoC 通过 SPI 向 MCU 下发升级镜像；MCU 将新镜像写入 Passive（B） 区域；通过 HSE A/B Swap 在复位后完成映射切换并启动新镜像。 已知约束：Bootloader 不在 swap 区域内；B 区物理地址范围与链接地址 TBD。 术语说明：本文“分区 A/B”指 Flash 双镜像（Active/Passive block remapping），非 Linux 分区表概念。
0. 文档控制 文档编号：SDS-S32K324-OTA-ABSWAP-001 版本：v0.9（Draft） 状态：Draft 作者：TBD 评审人：TBD 生效日期：TBD 变更记录 版本 日期 变更说明 作者 v0.9 TBD 初版：定义 OTA、A/B swap、回滚策略与排障流程 TBD 1. 引言 1.1 目的 定义 S32K324 上 OTA + A/B Swap 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="mcu"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification）

适用对象：NXP S32K324（S32K3 系列）
升级链路假设：SoC 通过 SPI 向 MCU 下发升级镜像；MCU 将新镜像写入 Passive（B） 区域；通过 HSE A/B Swap 在复位后完成映射切换并启动新镜像。
已知约束：Bootloader 不在 swap 区域内；B 区物理地址范围与链接地址 TBD。
术语说明：本文“分区 A/B”指 Flash 双镜像（Active/Passive block remapping），非 Linux 分区表概念。


0. 文档控制

文档编号：SDS-S32K324-OTA-ABSWAP-001
版本：v0.9（Draft）
状态：Draft
作者：TBD
评审人：TBD
生效日期：TBD

变更记录

  
      
          版本
          日期
          变更说明
          作者
      
  
  
      
          v0.9
          TBD
          初版：定义 OTA、A/B swap、回滚策略与排障流程
          TBD
      
  


1. 引言
1.1 目的
定义 S32K324 上 OTA + A/B Swap 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"MCUs","item":"https://ethen-cao.github.io/ethenslab/mcu/"},{"@type":"ListItem","position":2,"name":"","item":"https://ethen-cao.github.io/ethenslab/mcu/s32kxx-ota/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"","name":"","description":"S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification） 适用对象：NXP S32K324（S32K3 系列） 升级链路假设：SoC 通过 SPI 向 MCU 下发升级镜像；MCU 将新镜像写入 Passive（B） 区域；通过 HSE A/B Swap 在复位后完成映射切换并启动新镜像。 已知约束：Bootloader 不在 swap 区域内；B 区物理地址范围与链接地址 TBD。 术语说明：本文“分区 A/B”指 Flash 双镜像（Active/Passive block remapping），非 Linux 分区表概念。\n0. 文档控制 文档编号：SDS-S32K324-OTA-ABSWAP-001 版本：v0.9（Draft） 状态：Draft 作者：TBD 评审人：TBD 生效日期：TBD 变更记录 版本 日期 变更说明 作者 v0.9 TBD 初版：定义 OTA、A/B swap、回滚策略与排障流程 TBD 1. 引言 1.1 目的 定义 S32K324 上 OTA + A/B Swap 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。\n","keywords":[],"articleBody":"S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification） 适用对象：NXP S32K324（S32K3 系列） 升级链路假设：SoC 通过 SPI 向 MCU 下发升级镜像；MCU 将新镜像写入 Passive（B） 区域；通过 HSE A/B Swap 在复位后完成映射切换并启动新镜像。 已知约束：Bootloader 不在 swap 区域内；B 区物理地址范围与链接地址 TBD。 术语说明：本文“分区 A/B”指 Flash 双镜像（Active/Passive block remapping），非 Linux 分区表概念。\n0. 文档控制 文档编号：SDS-S32K324-OTA-ABSWAP-001 版本：v0.9（Draft） 状态：Draft 作者：TBD 评审人：TBD 生效日期：TBD 变更记录 版本 日期 变更说明 作者 v0.9 TBD 初版：定义 OTA、A/B swap、回滚策略与排障流程 TBD 1. 引言 1.1 目的 定义 S32K324 上 OTA + A/B Swap 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。\n1.2 范围 包含：SPI 升级协议（概念级）、镜像格式（概念级）、Flash 写入/校验流程、Bootloader/BootManager 策略、与 HSE A/B Swap 的集成点、回滚与诊断。\n不包含（TBD/Out of Scope）：\nHSE Secure Boot/SMR map 的具体配置细节（通常依赖 HSE FW RM/示例与项目密钥体系）。 具体 Flash block 地址、块大小、B 区起始地址/长度、应用链接脚本细节（均标记 TBD）。 1.3 参考资料 NXP OTA A/B Swap 演示材料（active/passive block、复位后映射切换、rollback 说明）(NXP Community) AN13388 S32K3 Memories Guide（program/erase 最小粒度、对齐、ECC、写前需擦除、最小 sector）(NXP Community) AN13414 Migration Guidelines（active/passive blocks、flash remapping、A/B swap 支持“backup firmware rollback / seamless update”）(nxp.com) NXP Community：S32K3 bank switching/A-B swap 由 HSE FW 支持；bootloader 复位后决策运行哪个应用 (NXP Community) NXP TechSupport：A/B swap 不会自动回滚，需用户请求；镜像损坏场景需 advanced secure boot + alternate pre-boot SMR map 才能在校验失败时执行备用镜像 (NXP Community) S32K3xx Security Training：HSE/secure BAF 安装与 A/B swap 配置相关说明（“A/B swap activation is definitive”等）(NXP Community) 1.4 术语与缩写 Active/Passive Block：当前运行镜像所在块 / 备用写入块。(nxp.com) A/B Swap：通过 HSE 在复位后将 passive 映射为 active（低地址空间），实现无拷贝切换。(NXP Community) BCB（Boot Control Block）：引导控制块（slot、trial、confirm、失败计数、校验摘要等）。 Trial/Confirm：试运行/确认机制（未确认则回滚）。 HSE/MU：Host Security Engine / Messaging Unit（host 与 HSE 通信接口）。(NXP Community) 2. 总体概述 2.1 系统目标 支持从 SoC 通过 SPI 对 MCU 应用固件进行 OTA 更新。 使用 Active/Passive + Flash remapping + A/B swap 实现：写 B、复位切换、试运行确认、失败回滚。(nxp.com) 在镜像损坏/无法启动时，系统能够自动或半自动恢复到可运行镜像（A）。 2.2 关键设计原则 Bootloader 不在 swap 区域内：确保无论 A/B 哪一侧损坏，仍有稳定代码可执行回滚/恢复。(NXP Community) A/B 镜像必须满足 remapping 运行模型：复位后 passive 变 active 并映射到低地址空间，新固件从相同逻辑起点执行。(NXP Community) 回滚不是“自动发生”：需 Bootloader/用户逻辑显式触发 swap 回退；镜像损坏时若需“预启动自动兜底”，需引入 advanced secure boot 机制。(NXP Community) 3. 系统架构 3.1 组件划分 SoC OTA Client\n获取升级包、拆分为 chunks、通过 SPI 发送、重传控制、最终提交。 MCU Bootloader/BootManager（非 swap 区域）\nSPI 接收升级流、写入 passive（B）区域、校验、写入 BCB、请求 HSE swap、复位。 启动时读取 BCB + reset reason，执行 trial/confirm 判断与回滚请求。 MCU Application（A/B 双镜像，位于 swap 区域）\n正常业务逻辑；在试运行成功后写 confirm。 HSE Firmware\n提供 A/B swap（bank switching/remapping）能力；与 Host 通过 MU 通信。(NXP Community) Flash（PFlash/DFlash）\nPFlash：应用镜像 A/B（Active/Passive blocks） DFlash 或预留 PFlash sector：BCB、事件计数、日志等（推荐双副本）。 3.2 典型流程（摘要） A 运行时，Bootloader 接收 SoC 下发镜像并写入 passive blocks（B）。 写完后复位，复位后 passive blocks 变 active 并映射到低地址空间，新镜像执行。(NXP Community) 若新镜像无法启动/未确认，Bootloader 依据策略请求 swap 回 A（回滚）。 若需要“镜像损坏导致无法进入应用/甚至无法执行回滚代码”的自动兜底，引入 secure boot 的备用验证图执行备用镜像。(NXP Community) 4. 存储与内存布局（TBD 驱动） 说明：S32K3 OTA demo 用“blocks 0\u00261 active / blocks 2\u00263 passive”的示例描述 A/B 切换。(NXP Community) S32K324 的实际 block 划分、A/B 容量、起始地址、对齐与保护策略需基于项目 flash 配置最终确认（本节大量 TBD）。\n4.1 Flash 分区（逻辑） Bootloader Region（Non-swap）\n起始地址：TBD 大小：TBD（建议 ≥ 64KB，含 SPI/Flash/HSE/MU/诊断/恢复模式） 属性：只读/受保护（生产态）。 Swap Region（Application NVM）\nActive Block（A）：TBD（blocks TBD） Passive Block（B）：TBD（blocks TBD） 约束：A/B 镜像容量相同（或满足 HSE swap 的等分要求，依实际配置 TBD）。 BCB \u0026 Diagnostics Region\n推荐：DFlash（如可用）或预留 PFlash sectors（最小 erase 单位为 sector）。(NXP Community) 地址/大小：TBD（至少 2 个 sector，支持双副本）。 4.2 链接地址（Vector Table 逻辑基址） 应用链接脚本中的逻辑基址：TBD 设计要求：无论镜像实际写在哪个物理 block，复位后都应以 同一逻辑起点执行（因为 remapping 将 active 映射到低地址空间）。(NXP Community) 5. 需求规格 5.1 功能需求（Functional Requirements） FR-01 OTA 传输\nMCU 应支持通过 SPI 从 SoC 接收升级包，支持分片（chunk）传输、乱序拒绝、丢包重传。 MCU 应能在升级过程中向 SoC 回报进度（已写 offset、剩余长度、错误码）。 FR-02 镜像完整性校验\nMCU 必须对每个 chunk 执行传输校验（CRC16/CRC32），校验失败不得写入 Flash。 MCU 必须在写入完成后对整个 B 镜像执行最终校验（CRC32 或 HASH），与 manifest 对比一致才允许进入切换流程。 FR-03 Flash 写入与一致性\nMCU 写 Flash 时必须满足最小 program 粒度、对齐与“写前擦除”规则。(NXP Community) MCU 应在写入阶段检测 program/erase 错误并中止升级，回报 SoC 错误原因。 FR-04 A/B Swap 切换\nMCU 在 B 镜像验证通过后，必须通过 HSE 请求 A/B swap，并触发复位，使 passive 成为 active 并映射到低地址空间执行新镜像。(NXP Community) FR-05 Trial/Confirm 试运行\nMCU 必须支持试运行（trial）模式：切到 B 后在规定时间内由 B 镜像写入确认标志（confirm）。 若 B 未确认即复位或异常复位，Bootloader 必须判定试运行失败并执行回滚策略。 FR-06 回滚（Rollback）\n回滚必须可由 Bootloader 显式请求：切回 A（请求 HSE swap 回退 + 复位）。 回滚触发条件至少包含：未确认超时、异常复位（WDG/Lockup 等）、失败计数超阈值。 说明：A/B swap 不会自动回滚，必须由用户逻辑请求；镜像损坏场景建议配合 secure boot 兜底。(NXP Community) FR-07 恢复模式\nMCU 应提供“强制进入 Bootloader/强制回 A”的手段：\nGPIO strap（TBD）、SoC SPI 命令（TBD）、连续失败次数触发（内置）。 FR-08 诊断与可观测性\nBootloader 必须记录并可输出：当前 slot、trial/confirm 状态、fail_count、最后 reset reason、最后一次升级错误码、B 镜像 CRC/HASH（可选）。 5.2 非功能需求（Non-Functional Requirements） NFR-01 可靠性\n支持断电/复位恢复：任何中间态不得导致永久变砖；至少能回到 Bootloader 或可通过恢复模式重新刷写。 BCB 必须采用双副本/日志式写入，防止写一半导致状态不可读（实现 TBD）。 NFR-02 性能\nOTA 传输吞吐：TBD（由 SPI 时钟、DMA、SoC/MCU 协议栈决定） 写入耗时：TBD（由 program/erase 粒度与校验策略决定；建议 sector 级校验可配置开关） NFR-03 安全\n支持镜像签名校验（推荐使用 HSE 能力），支持版本控制/防降级（TBD）。 若要求“镜像损坏时无需依赖应用确认即可自动选择备用镜像”，需启用 advanced secure boot + alternate pre-boot SMR map（TBD 配置）。(NXP Community) NFR-04 可维护性\n协议/状态机版本化；BCB 结构带 version 字段；错误码统一枚举。 支持现场日志导出（SPI 命令/串口/调试口 TBD）。 NFR-05 功能安全（如 ISO 26262 相关）\n回滚策略不得引入无穷重启；应有最大重试次数与降级策略（如锁定在 Bootloader 等）。 6. 详细设计 6.1 SPI 传输协议（建议实现） chunk 大小、窗口与重传策略为可配置项，默认值 TBD（推荐从 1–4KB 起步，依据 RAM 与吞吐再优化）。\n消息类型\nSTART(manifest)：image_size、image_version、target=B、hash、可选签名信息 DATA(seq, offset, len, payload, crc) END：结束标记 STATUS/ACK/NACK：状态查询、确认与重传控制 ABORT：取消升级 传输校验\n每个 DATA 必带 CRC32（或 CRC16 + 长度/offset 校验）。 MCU：CRC 失败 → NACK（请求重传），不得写 Flash。 6.2 镜像与 Manifest（建议字段） image_version（单调递增，防降级 TBD） image_size image_hash（CRC32/SHA-256） load_model：AB_SWAP（运行逻辑基址固定） entry_type：vector table at logical base（TBD） signature：可选（若启用 secure boot/HSE 校验） 6.3 Flash 写入策略（必须满足 S32K3 Flash 约束） 来自 AN13388（S32K3 Memories Guide）的关键约束（写入实现必须遵守）：\n最小 program size：2 words = 64 bits，且数据 64-bit 对齐。(NXP Community) 单次最多可 program 4 pages（1 page=256 bits），即最多 1024 bits。(NXP Community) program 只能 1→0，0→1 不允许，写入前必须 erase。(NXP Community) 最小 erase 粒度为 sector（8KB）。(NXP Community) 写入流程（建议）\n升级开始前：按 B 区覆盖范围逐 sector 擦除（8KB 对齐）。(NXP Community)\n收到 chunk：在 RAM 缓冲区拼装并对齐到 64-bit；末尾不足用 0xFF padding（TBD）。\n分段 program：按 64-bit / page / quad-page 的策略写入（以性能与实现复杂度折中为准）。(NXP Community)\n写后校验：\n最低配：检查 program/erase 返回状态 推荐：每个 sector 写完做一次 readback CRC；最终做整镜像 hash（开关可配）。 记录进度：在 BCB 中更新 “已写最大 offset / hash rolling state”（TBD）。\n6.4 与 HSE A/B Swap 集成 能力来源\nS32K3xx 支持 bank switching，A/B swap 由 HSE firmware 支持；并建议参考 demo 文档/示例。(NXP Community) 切换语义（来自 OTA demo）\n当新镜像写入 passive blocks 后触发复位：复位后 passive blocks 变 active，映射到低地址空间执行新固件。(NXP Community) 关键注意\nA/B swap 不会自动回滚：切回 A 必须由 Bootloader/用户逻辑再次请求 swap。(NXP Community) A/B swap 配置启用具有“永久性”含义（training 提到 activation is definitive），因此应在量产策略上谨慎规划启用时机与恢复路径。(NXP Community) 实现接口（TBD）：HSE service ID、MU 通信细节、swap 请求 API 以项目采用的 HSE demo app/RTD 集成为准（通常来自 HSE FW package）。(NXP Community)\n6.5 Boot Control Block（BCB）设计 BCB（建议字段）\nbcb_version active_slot：A/B trial：0/1 boot_success：0/1 fail_count：u8 image_version_A/B image_hash_B（或 last_written_hash） last_reset_reason last_error_code commit_counter（双副本选择最新记录） BCB 存储策略\n双副本（A/B records）+ CRC32 + 单调递增 counter 写入采用“追加写（1→0）+ 周期性擦除”的日志型结构（如使用 RTD/FEE 可进一步简化，TBD）。(NXP Community) 7. 回滚机制设计 7.1 设计目标 B 启动失败时：自动回到 A（最多 N 次尝试）。 避免无限重启：到达阈值后进入 Bootloader/恢复模式等待 SoC 指令。 7.2 回滚触发条件（建议默认） RC-01 未确认超时：trial=1 且 boot_success=0，且发生一次复位 → fail_count++ RC-02 异常复位：WDG/Lockup/HF 等复位原因且处于 trial → fail_count++ RC-03 失败次数阈值：fail_count ≥ 1（调试）或 ≥ 2/3（量产）→ 回滚到 A RC-04 B 镜像校验失败：写后整包 hash 不匹配 → 不允许切换（保持 A） 说明：若 B “镜像损坏到无法进入应用/无法执行确认逻辑”，仅靠 trial/confirm 仍能回滚（因为 Bootloader 不在 swap 区域，仍可执行回滚请求）。但若损坏导致更早阶段被 secure boot 拦截，则需 secure boot 备用验证图策略兜底。(NXP Community)\n7.3 回滚执行动作 当触发回滚：\n更新 BCB：active_slot=A; trial=0; boot_success=0;（并保留诊断信息） 请求 HSE swap 切回 A（TBD API） 触发 system reset 复位后 A 成为 active 并运行 8. “切 B 成功但不启动”应对流程（Runbook） 该问题在 S32K3 OTA demo 中也被频繁复现：写 B 后切换成功，但破坏 B 镜像后无法运行，官方明确 AB swap 不会自动回滚，需用户逻辑请求或引入 secure boot 机制。(NXP Community)\n8.1 先判定：复位后有没有进入 Bootloader？ 能进 Bootloader（推荐路径）：\n打印/上报：reset_reason、BCB(trial/boot_success/fail_count/active_slot)、HSE swap 状态（若可读） 若满足回滚条件：立即请求 swap 回 A + reset 同时保留失败现场：B 镜像 hash、最后写入 offset、最后错误码 进不去 Bootloader（高危）：\n排查 Bootloader 是否真的“非 swap 区域且未被覆盖”（你已声明设计上如此，但需确认链接脚本/擦写范围）。 若启用 secure boot：检查是否被 pre-boot verification 拦截（需要备用 SMR map 才能自动执行备份镜像）。(NXP Community) 启用硬件恢复路径：ROM 下载模式 / 调试口（TBD，依项目硬件）。 8.2 最常见根因与快速验证 B 镜像写入物理地址错/偏移错\n对照“passive blocks”规划（TBD），抽检 B 起始处向量表是否合理。 Flash 写入对齐/粒度错误导致向量表损坏（MSP/ResetHandler 非法）\n核查是否严格按 64-bit 对齐与最小 program 粒度写入；是否擦除到 8KB sector 边界。(NXP Community) 写后未校验导致“写入静默失败”\n开启 sector readback CRC 或全镜像 hash 校验，定位坏区。 应用链接地址模型不匹配 AB swap remapping\nAB swap 的目标是复位后 active 映射到低地址空间运行（无需复杂 linker tracking）。(nxp.com) 因此 A/B 的“运行逻辑基址/向量表基址”应一致（具体基址 TBD）。 试运行确认逻辑缺失\nB 没有写 confirm，导致系统反复尝试或停留在异常状态（需依 BCB 策略回滚）。 8.3 建议的“救场开关” Bootloader 增加 强制回 A：检测 GPIO strap（TBD）或 SoC 发来的 FORCE_ROLLBACK SPI 命令。 fail_count 阈值：调试阶段设为 1；量产设为 2~3。 BCB 记录最近一次 swap 请求与 swap 结果（TBD），便于现场定位“切换成功/启动失败”的边界点。 9. 安全设计（可选增强） 9.1 基线安全（建议） Manifest + hash 校验（MCU 侧必须做） SoC-\u003eMCU 传输链路校验（每 chunk CRC） 9.2 需要“镜像损坏也能自动兜底”的场景 官方建议：若希望在镜像损坏时自动采取动作，需要实现 advanced secure boot，并配置 alternate pre-boot SMR verification map：正常预启动校验失败时可执行备用镜像，由备用镜像采取回滚动作。(NXP Community)\n该部分具体配置/密钥/SMR map 细节：TBD（依 HSE FW RM 与项目安全策略）。(NXP Community)\n10. 测试与验证计划（摘要） 10.1 功能测试 正常 OTA：写 B → swap → B 启动 → confirm → 后续重启仍为 B 回滚测试：写入“故意破坏的 B” → swap → 触发 WDG/不 confirm → 回滚 A 断电测试：传输中断电 / 擦除中断电 / 写入中断电 / swap 前断电 / swap 后首次启动断电 10.2 可靠性与鲁棒性 chunk 丢包/重复包/乱序包 CRC 错误注入 Flash program/erase 错误注入（模拟返回错误位） 10.3 安全测试（若启用） 签名错误镜像拒绝 版本回退拒绝（anti-rollback，TBD） 11. 风险与 TBD 清单 11.1 风险 Bootloader 若擦写范围配置错误，可能误擦 swap 区或误擦自身导致变砖（必须加保护与白名单）。 BCB 若无双副本与断电保护，容易出现“状态不可判定”导致启动策略异常。 若启用 A/B swap 配置且“activation definitive”，量产前需明确恢复路径与售后策略。(NXP Community) 11.2 TBD（待确认） B 区物理地址范围（blocks/起始地址/长度） 应用链接地址（vector table 逻辑基址） SPI 速率、chunk 默认大小、窗口大小、超时与重传策略 HSE swap 请求 API/服务号/返回码（依 HSE demo/RTD 集成）(NXP Community) reset reason 获取方式与分类（WDG/lockup 等） 恢复模式入口（GPIO strap/ROM boot 等） 附录 A：关键实现检查表（工程落地用） Bootloader 链接脚本确认：不在 swap 区，擦写白名单只覆盖 passive B + BCB Flash 驱动确认：64-bit 对齐写入、写前 sector erase、错误位处理（PEP/解锁等）(NXP Community) 写后校验策略：至少整镜像 hash；建议加 sector readback CRC（可配） BCB 双副本：带 CRC + counter；断电恢复可判定最新有效记录 Trial/Confirm：B 启动后 N 秒内 confirm；Bootloader 依据 fail_count 回滚 “切 B 不启动”救场：强制回 A 命令/strap；fail_count=1（调试） （可选）Secure boot 备用验证图：镜像损坏时自动执行备用镜像并回滚 (NXP Community) 在这份文档基础上继续补齐两块最关键的 TBD（并把“切 B 成功但不启动”直接收敛到可操作的排障点）：\nS32K324 的 Flash block 划分与 swap region 规划（给我项目的 memory map/链接脚本片段即可） 你们当前 MCU 写 Flash 的 最小写入函数（一次写多少、对齐要求、擦除策略、错误返回） 补齐后我还能把 BCB 的二进制布局（字段偏移/对齐/CRC） 和 Bootloader 状态机伪代码写到可直接实现的程度。\n","wordCount":"1218","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://ethen-cao.github.io/ethenslab/mcu/s32kxx-ota/"},"publisher":{"@type":"Organization","name":"Ethen 的实验室","logo":{"@type":"ImageObject","url":"https://ethen-cao.github.io/ethenslab/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://ethen-cao.github.io/ethenslab/ accesskey=h title="Ethen 的实验室 (Alt + H)">Ethen 的实验室</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://ethen-cao.github.io/ethenslab/android-dev/ title=Android系统开发><span>Android系统开发</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/android-automotive-os-dev/ title="Android Automotive"><span>Android Automotive</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/qnx/ title=QNX开发><span>QNX开发</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/gunyah/ title=Gunyah><span>Gunyah</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/ivi-solution/ title=智能座舱方案><span>智能座舱方案</span></a></li><li><a href=https://ethen-cao.github.io/ethenslab/explore-ai title="Explore AI"><span>Explore AI</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://ethen-cao.github.io/ethenslab/>Home</a>&nbsp;»&nbsp;<a href=https://ethen-cao.github.io/ethenslab/mcu/>MCUs</a></div><h1 class="post-title entry-hint-parent"></h1><div class=post-meta>6 min&nbsp;·&nbsp;1218 words</div></header><div class=post-content><h1 id=s32k324-mcu-ota-ab-swap-机制系统设计文档system-design-specification>S32K324 MCU OTA A/B Swap 机制系统设计文档（System Design Specification）<a hidden class=anchor aria-hidden=true href=#s32k324-mcu-ota-ab-swap-机制系统设计文档system-design-specification>#</a></h1><blockquote><p><strong>适用对象</strong>：NXP S32K324（S32K3 系列）
<strong>升级链路假设</strong>：SoC 通过 <strong>SPI</strong> 向 MCU 下发升级镜像；MCU 将新镜像写入 <strong>Passive（B）</strong> 区域；通过 <strong>HSE A/B Swap</strong> 在复位后完成映射切换并启动新镜像。
<strong>已知约束</strong>：Bootloader <strong>不在 swap 区域内</strong>；B 区物理地址范围与链接地址 <strong>TBD</strong>。
<strong>术语说明</strong>：本文“分区 A/B”指 <strong>Flash 双镜像（Active/Passive block remapping）</strong>，非 Linux 分区表概念。</p></blockquote><hr><h2 id=0-文档控制>0. 文档控制<a hidden class=anchor aria-hidden=true href=#0-文档控制>#</a></h2><ul><li>文档编号：SDS-S32K324-OTA-ABSWAP-001</li><li>版本：v0.9（Draft）</li><li>状态：Draft</li><li>作者：TBD</li><li>评审人：TBD</li><li>生效日期：TBD</li></ul><h3 id=变更记录>变更记录<a hidden class=anchor aria-hidden=true href=#变更记录>#</a></h3><table><thead><tr><th>版本</th><th>日期</th><th>变更说明</th><th>作者</th></tr></thead><tbody><tr><td>v0.9</td><td>TBD</td><td>初版：定义 OTA、A/B swap、回滚策略与排障流程</td><td>TBD</td></tr></tbody></table><hr><h2 id=1-引言>1. 引言<a hidden class=anchor aria-hidden=true href=#1-引言>#</a></h2><h3 id=11-目的>1.1 目的<a hidden class=anchor aria-hidden=true href=#11-目的>#</a></h3><p>定义 S32K324 上 <strong>OTA + A/B Swap</strong> 的端到端机制：镜像传输、写入、校验、切换、试运行确认、回滚触发条件与实现要点，并提供“切 B 成功但不启动”的应对流程。</p><h3 id=12-范围>1.2 范围<a hidden class=anchor aria-hidden=true href=#12-范围>#</a></h3><ul><li><p><strong>包含</strong>：SPI 升级协议（概念级）、镜像格式（概念级）、Flash 写入/校验流程、Bootloader/BootManager 策略、与 HSE A/B Swap 的集成点、回滚与诊断。</p></li><li><p><strong>不包含（TBD/Out of Scope）</strong>：</p><ul><li>HSE Secure Boot/SMR map 的具体配置细节（通常依赖 HSE FW RM/示例与项目密钥体系）。</li><li>具体 Flash block 地址、块大小、B 区起始地址/长度、应用链接脚本细节（均标记 TBD）。</li></ul></li></ul><h3 id=13-参考资料>1.3 参考资料<a hidden class=anchor aria-hidden=true href=#13-参考资料>#</a></h3><ul><li>NXP OTA A/B Swap 演示材料（active/passive block、复位后映射切换、rollback 说明）(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li><li>AN13388 S32K3 Memories Guide（program/erase 最小粒度、对齐、ECC、写前需擦除、最小 sector）(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>AN13414 Migration Guidelines（active/passive blocks、flash remapping、A/B swap 支持“backup firmware rollback / seamless update”）(<a href=https://www.nxp.com/docs/en/application-note/AN13414.pdf title="AN13414: S32K1 to S32K3 Migration Guidelines - Application Note">nxp.com</a>)</li><li>NXP Community：S32K3 bank switching/A-B swap 由 HSE FW 支持；bootloader 复位后决策运行哪个应用 (<a href=https://community.nxp.com/t5/S32K/Bank-switching-for-s32k-microcontroller/m-p/1431652/highlight/true title="
	Bank switching for s32k microcontroller - NXP Community
">NXP Community</a>)</li><li>NXP TechSupport：A/B swap <strong>不会自动回滚</strong>，需用户请求；镜像损坏场景需 advanced secure boot + alternate pre-boot SMR map 才能在校验失败时执行备用镜像 (<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li><li>S32K3xx Security Training：HSE/secure BAF 安装与 A/B swap 配置相关说明（“A/B swap activation is definitive”等）(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</li></ul><h3 id=14-术语与缩写>1.4 术语与缩写<a hidden class=anchor aria-hidden=true href=#14-术语与缩写>#</a></h3><ul><li><strong>Active/Passive Block</strong>：当前运行镜像所在块 / 备用写入块。(<a href=https://www.nxp.com/docs/en/application-note/AN13414.pdf title="AN13414: S32K1 to S32K3 Migration Guidelines - Application Note">nxp.com</a>)</li><li><strong>A/B Swap</strong>：通过 HSE 在复位后将 passive 映射为 active（低地址空间），实现无拷贝切换。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li><li><strong>BCB</strong>（Boot Control Block）：引导控制块（slot、trial、confirm、失败计数、校验摘要等）。</li><li><strong>Trial/Confirm</strong>：试运行/确认机制（未确认则回滚）。</li><li><strong>HSE/MU</strong>：Host Security Engine / Messaging Unit（host 与 HSE 通信接口）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</li></ul><hr><h2 id=2-总体概述>2. 总体概述<a hidden class=anchor aria-hidden=true href=#2-总体概述>#</a></h2><h3 id=21-系统目标>2.1 系统目标<a hidden class=anchor aria-hidden=true href=#21-系统目标>#</a></h3><ol><li>支持从 SoC 通过 SPI 对 MCU 应用固件进行 OTA 更新。</li><li>使用 <strong>Active/Passive + Flash remapping + A/B swap</strong> 实现：写 B、复位切换、试运行确认、失败回滚。(<a href=https://www.nxp.com/docs/en/application-note/AN13414.pdf title="AN13414: S32K1 to S32K3 Migration Guidelines - Application Note">nxp.com</a>)</li><li>在镜像损坏/无法启动时，系统能够<strong>自动或半自动</strong>恢复到可运行镜像（A）。</li></ol><h3 id=22-关键设计原则>2.2 关键设计原则<a hidden class=anchor aria-hidden=true href=#22-关键设计原则>#</a></h3><ul><li><strong>Bootloader 不在 swap 区域内</strong>：确保无论 A/B 哪一侧损坏，仍有稳定代码可执行回滚/恢复。(<a href=https://community.nxp.com/t5/S32K/Bank-switching-for-s32k-microcontroller/m-p/1431652/highlight/true title="
	Bank switching for s32k microcontroller - NXP Community
">NXP Community</a>)</li><li><strong>A/B 镜像必须满足 remapping 运行模型</strong>：复位后 passive 变 active 并映射到低地址空间，新固件从相同逻辑起点执行。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li><li><strong>回滚不是“自动发生”</strong>：需 Bootloader/用户逻辑显式触发 swap 回退；镜像损坏时若需“预启动自动兜底”，需引入 advanced secure boot 机制。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li></ul><hr><h2 id=3-系统架构>3. 系统架构<a hidden class=anchor aria-hidden=true href=#3-系统架构>#</a></h2><h3 id=31-组件划分>3.1 组件划分<a hidden class=anchor aria-hidden=true href=#31-组件划分>#</a></h3><ul><li><p><strong>SoC OTA Client</strong></p><ul><li>获取升级包、拆分为 chunks、通过 SPI 发送、重传控制、最终提交。</li></ul></li><li><p><strong>MCU Bootloader/BootManager（非 swap 区域）</strong></p><ul><li>SPI 接收升级流、写入 passive（B）区域、校验、写入 BCB、请求 HSE swap、复位。</li><li>启动时读取 BCB + reset reason，执行 trial/confirm 判断与回滚请求。</li></ul></li><li><p><strong>MCU Application（A/B 双镜像，位于 swap 区域）</strong></p><ul><li>正常业务逻辑；在试运行成功后写 confirm。</li></ul></li><li><p><strong>HSE Firmware</strong></p><ul><li>提供 A/B swap（bank switching/remapping）能力；与 Host 通过 MU 通信。(<a href=https://community.nxp.com/t5/S32K/Bank-switching-for-s32k-microcontroller/m-p/1431652/highlight/true title="
	Bank switching for s32k microcontroller - NXP Community
">NXP Community</a>)</li></ul></li><li><p><strong>Flash（PFlash/DFlash）</strong></p><ul><li>PFlash：应用镜像 A/B（Active/Passive blocks）</li><li>DFlash 或预留 PFlash sector：BCB、事件计数、日志等（推荐双副本）。</li></ul></li></ul><h3 id=32-典型流程摘要>3.2 典型流程（摘要）<a hidden class=anchor aria-hidden=true href=#32-典型流程摘要>#</a></h3><ol><li>A 运行时，Bootloader 接收 SoC 下发镜像并写入 passive blocks（B）。</li><li>写完后复位，复位后 passive blocks 变 active 并映射到低地址空间，新镜像执行。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li><li>若新镜像无法启动/未确认，Bootloader 依据策略请求 swap 回 A（回滚）。</li><li>若需要“镜像损坏导致无法进入应用/甚至无法执行回滚代码”的自动兜底，引入 secure boot 的备用验证图执行备用镜像。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li></ol><hr><h2 id=4-存储与内存布局tbd-驱动>4. 存储与内存布局（TBD 驱动）<a hidden class=anchor aria-hidden=true href=#4-存储与内存布局tbd-驱动>#</a></h2><blockquote><p><strong>说明</strong>：S32K3 OTA demo 用“blocks 0&amp;1 active / blocks 2&amp;3 passive”的示例描述 A/B 切换。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)
S32K324 的实际 block 划分、A/B 容量、起始地址、对齐与保护策略需基于项目 flash 配置最终确认（本节大量 TBD）。</p></blockquote><h3 id=41-flash-分区逻辑>4.1 Flash 分区（逻辑）<a hidden class=anchor aria-hidden=true href=#41-flash-分区逻辑>#</a></h3><ul><li><p><strong>Bootloader Region（Non-swap）</strong></p><ul><li>起始地址：TBD</li><li>大小：TBD（建议 ≥ 64KB，含 SPI/Flash/HSE/MU/诊断/恢复模式）</li><li>属性：只读/受保护（生产态）。</li></ul></li><li><p><strong>Swap Region（Application NVM）</strong></p><ul><li><strong>Active Block（A）</strong>：TBD（blocks TBD）</li><li><strong>Passive Block（B）</strong>：TBD（blocks TBD）</li><li>约束：A/B 镜像容量相同（或满足 HSE swap 的等分要求，依实际配置 TBD）。</li></ul></li><li><p><strong>BCB & Diagnostics Region</strong></p><ul><li>推荐：DFlash（如可用）或预留 PFlash sectors（最小 erase 单位为 sector）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>地址/大小：TBD（至少 2 个 sector，支持双副本）。</li></ul></li></ul><h3 id=42-链接地址vector-table-逻辑基址>4.2 链接地址（Vector Table 逻辑基址）<a hidden class=anchor aria-hidden=true href=#42-链接地址vector-table-逻辑基址>#</a></h3><ul><li><strong>应用链接脚本中的逻辑基址</strong>：TBD</li><li>设计要求：无论镜像实际写在哪个物理 block，复位后都应以 <strong>同一逻辑起点</strong>执行（因为 remapping 将 active 映射到低地址空间）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li></ul><hr><h2 id=5-需求规格>5. 需求规格<a hidden class=anchor aria-hidden=true href=#5-需求规格>#</a></h2><h3 id=51-功能需求functional-requirements>5.1 功能需求（Functional Requirements）<a hidden class=anchor aria-hidden=true href=#51-功能需求functional-requirements>#</a></h3><p><strong>FR-01 OTA 传输</strong></p><ul><li>MCU 应支持通过 SPI 从 SoC 接收升级包，支持分片（chunk）传输、乱序拒绝、丢包重传。</li><li>MCU 应能在升级过程中向 SoC 回报进度（已写 offset、剩余长度、错误码）。</li></ul><p><strong>FR-02 镜像完整性校验</strong></p><ul><li>MCU 必须对每个 chunk 执行传输校验（CRC16/CRC32），校验失败不得写入 Flash。</li><li>MCU 必须在写入完成后对整个 B 镜像执行最终校验（CRC32 或 HASH），与 manifest 对比一致才允许进入切换流程。</li></ul><p><strong>FR-03 Flash 写入与一致性</strong></p><ul><li>MCU 写 Flash 时必须满足最小 program 粒度、对齐与“写前擦除”规则。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>MCU 应在写入阶段检测 program/erase 错误并中止升级，回报 SoC 错误原因。</li></ul><p><strong>FR-04 A/B Swap 切换</strong></p><ul><li>MCU 在 B 镜像验证通过后，必须通过 HSE 请求 A/B swap，并触发复位，使 passive 成为 active 并映射到低地址空间执行新镜像。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li></ul><p><strong>FR-05 Trial/Confirm 试运行</strong></p><ul><li>MCU 必须支持试运行（trial）模式：切到 B 后在规定时间内由 B 镜像写入确认标志（confirm）。</li><li>若 B 未确认即复位或异常复位，Bootloader 必须判定试运行失败并执行回滚策略。</li></ul><p><strong>FR-06 回滚（Rollback）</strong></p><ul><li>回滚必须可由 Bootloader 显式请求：切回 A（请求 HSE swap 回退 + 复位）。</li><li>回滚触发条件至少包含：未确认超时、异常复位（WDG/Lockup 等）、失败计数超阈值。</li><li>说明：A/B swap 不会自动回滚，必须由用户逻辑请求；镜像损坏场景建议配合 secure boot 兜底。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li></ul><p><strong>FR-07 恢复模式</strong></p><ul><li><p>MCU 应提供“强制进入 Bootloader/强制回 A”的手段：</p><ul><li>GPIO strap（TBD）、SoC SPI 命令（TBD）、连续失败次数触发（内置）。</li></ul></li></ul><p><strong>FR-08 诊断与可观测性</strong></p><ul><li>Bootloader 必须记录并可输出：当前 slot、trial/confirm 状态、fail_count、最后 reset reason、最后一次升级错误码、B 镜像 CRC/HASH（可选）。</li></ul><hr><h3 id=52-非功能需求non-functional-requirements>5.2 非功能需求（Non-Functional Requirements）<a hidden class=anchor aria-hidden=true href=#52-非功能需求non-functional-requirements>#</a></h3><p><strong>NFR-01 可靠性</strong></p><ul><li>支持断电/复位恢复：任何中间态不得导致永久变砖；至少能回到 Bootloader 或可通过恢复模式重新刷写。</li><li>BCB 必须采用双副本/日志式写入，防止写一半导致状态不可读（实现 TBD）。</li></ul><p><strong>NFR-02 性能</strong></p><ul><li>OTA 传输吞吐：TBD（由 SPI 时钟、DMA、SoC/MCU 协议栈决定）</li><li>写入耗时：TBD（由 program/erase 粒度与校验策略决定；建议 sector 级校验可配置开关）</li></ul><p><strong>NFR-03 安全</strong></p><ul><li>支持镜像签名校验（推荐使用 HSE 能力），支持版本控制/防降级（TBD）。</li><li>若要求“镜像损坏时无需依赖应用确认即可自动选择备用镜像”，需启用 advanced secure boot + alternate pre-boot SMR map（TBD 配置）。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li></ul><p><strong>NFR-04 可维护性</strong></p><ul><li>协议/状态机版本化；BCB 结构带 version 字段；错误码统一枚举。</li><li>支持现场日志导出（SPI 命令/串口/调试口 TBD）。</li></ul><p><strong>NFR-05 功能安全（如 ISO 26262 相关）</strong></p><ul><li>回滚策略不得引入无穷重启；应有最大重试次数与降级策略（如锁定在 Bootloader 等）。</li></ul><hr><h2 id=6-详细设计>6. 详细设计<a hidden class=anchor aria-hidden=true href=#6-详细设计>#</a></h2><h3 id=61-spi-传输协议建议实现>6.1 SPI 传输协议（建议实现）<a hidden class=anchor aria-hidden=true href=#61-spi-传输协议建议实现>#</a></h3><blockquote><p>chunk 大小、窗口与重传策略为可配置项，默认值 TBD（推荐从 1–4KB 起步，依据 RAM 与吞吐再优化）。</p></blockquote><p><strong>消息类型</strong></p><ul><li><code>START(manifest)</code>：image_size、image_version、target=B、hash、可选签名信息</li><li><code>DATA(seq, offset, len, payload, crc)</code></li><li><code>END</code>：结束标记</li><li><code>STATUS/ACK/NACK</code>：状态查询、确认与重传控制</li><li><code>ABORT</code>：取消升级</li></ul><p><strong>传输校验</strong></p><ul><li>每个 <code>DATA</code> 必带 CRC32（或 CRC16 + 长度/offset 校验）。</li><li>MCU：CRC 失败 → NACK（请求重传），<strong>不得写 Flash</strong>。</li></ul><hr><h3 id=62-镜像与-manifest建议字段>6.2 镜像与 Manifest（建议字段）<a hidden class=anchor aria-hidden=true href=#62-镜像与-manifest建议字段>#</a></h3><ul><li><code>image_version</code>（单调递增，防降级 TBD）</li><li><code>image_size</code></li><li><code>image_hash</code>（CRC32/SHA-256）</li><li><code>load_model</code>：AB_SWAP（运行逻辑基址固定）</li><li><code>entry_type</code>：vector table at logical base（TBD）</li><li><code>signature</code>：可选（若启用 secure boot/HSE 校验）</li></ul><hr><h3 id=63-flash-写入策略必须满足-s32k3-flash-约束>6.3 Flash 写入策略（必须满足 S32K3 Flash 约束）<a hidden class=anchor aria-hidden=true href=#63-flash-写入策略必须满足-s32k3-flash-约束>#</a></h3><p>来自 AN13388（S32K3 Memories Guide）的关键约束（写入实现必须遵守）：</p><ul><li>最小 program size：<strong>2 words = 64 bits</strong>，且数据 <strong>64-bit 对齐</strong>。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>单次最多可 program <strong>4 pages</strong>（1 page=256 bits），即最多 1024 bits。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>program 只能 <strong>1→0</strong>，0→1 不允许，写入前必须 erase。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li>最小 erase 粒度为 <strong>sector（8KB）</strong>。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li></ul><p><strong>写入流程（建议）</strong></p><ol><li><p>升级开始前：按 B 区覆盖范围逐 sector 擦除（8KB 对齐）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</p></li><li><p>收到 chunk：在 RAM 缓冲区拼装并对齐到 64-bit；末尾不足用 0xFF padding（TBD）。</p></li><li><p>分段 program：按 64-bit / page / quad-page 的策略写入（以性能与实现复杂度折中为准）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</p></li><li><p>写后校验：</p><ul><li>最低配：检查 program/erase 返回状态</li><li>推荐：每个 sector 写完做一次 readback CRC；最终做整镜像 hash（开关可配）。</li></ul></li><li><p>记录进度：在 BCB 中更新 “已写最大 offset / hash rolling state”（TBD）。</p></li></ol><hr><h3 id=64-与-hse-ab-swap-集成>6.4 与 HSE A/B Swap 集成<a hidden class=anchor aria-hidden=true href=#64-与-hse-ab-swap-集成>#</a></h3><p><strong>能力来源</strong></p><ul><li>S32K3xx 支持 bank switching，A/B swap 由 <strong>HSE firmware</strong> 支持；并建议参考 demo 文档/示例。(<a href=https://community.nxp.com/t5/S32K/Bank-switching-for-s32k-microcontroller/m-p/1431652/highlight/true title="
	Bank switching for s32k microcontroller - NXP Community
">NXP Community</a>)</li></ul><p><strong>切换语义（来自 OTA demo）</strong></p><ul><li>当新镜像写入 passive blocks 后触发复位：复位后 passive blocks 变 active，映射到低地址空间执行新固件。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K%40tkb/118/1/S32K3_OTA_AB_SWAP_Demostration.pdf title="NXP PowerPoint Template 2020 Confidential & Proprietary">NXP Community</a>)</li></ul><p><strong>关键注意</strong></p><ul><li>A/B swap <strong>不会自动回滚</strong>：切回 A 必须由 Bootloader/用户逻辑再次请求 swap。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li><li>A/B swap 配置启用具有“永久性”含义（training 提到 activation is definitive），因此应在量产策略上谨慎规划启用时机与恢复路径。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</li></ul><blockquote><p><strong>实现接口（TBD）</strong>：HSE service ID、MU 通信细节、swap 请求 API 以项目采用的 HSE demo app/RTD 集成为准（通常来自 HSE FW package）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</p></blockquote><hr><h3 id=65-boot-control-blockbcb设计>6.5 Boot Control Block（BCB）设计<a hidden class=anchor aria-hidden=true href=#65-boot-control-blockbcb设计>#</a></h3><p><strong>BCB（建议字段）</strong></p><ul><li><code>bcb_version</code></li><li><code>active_slot</code>：A/B</li><li><code>trial</code>：0/1</li><li><code>boot_success</code>：0/1</li><li><code>fail_count</code>：u8</li><li><code>image_version_A/B</code></li><li><code>image_hash_B</code>（或 last_written_hash）</li><li><code>last_reset_reason</code></li><li><code>last_error_code</code></li><li><code>commit_counter</code>（双副本选择最新记录）</li></ul><p><strong>BCB 存储策略</strong></p><ul><li>双副本（A/B records）+ CRC32 + 单调递增 counter</li><li>写入采用“追加写（1→0）+ 周期性擦除”的日志型结构（如使用 RTD/FEE 可进一步简化，TBD）。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li></ul><hr><h2 id=7-回滚机制设计>7. 回滚机制设计<a hidden class=anchor aria-hidden=true href=#7-回滚机制设计>#</a></h2><h3 id=71-设计目标>7.1 设计目标<a hidden class=anchor aria-hidden=true href=#71-设计目标>#</a></h3><ul><li>B 启动失败时：<strong>自动回到 A</strong>（最多 N 次尝试）。</li><li>避免无限重启：到达阈值后进入 Bootloader/恢复模式等待 SoC 指令。</li></ul><h3 id=72-回滚触发条件建议默认>7.2 回滚触发条件（建议默认）<a hidden class=anchor aria-hidden=true href=#72-回滚触发条件建议默认>#</a></h3><ul><li><strong>RC-01 未确认超时</strong>：trial=1 且 boot_success=0，且发生一次复位 → fail_count++</li><li><strong>RC-02 异常复位</strong>：WDG/Lockup/HF 等复位原因且处于 trial → fail_count++</li><li><strong>RC-03 失败次数阈值</strong>：fail_count ≥ 1（调试）或 ≥ 2/3（量产）→ 回滚到 A</li><li><strong>RC-04 B 镜像校验失败</strong>：写后整包 hash 不匹配 → 不允许切换（保持 A）</li></ul><blockquote><p>说明：若 B “镜像损坏到无法进入应用/无法执行确认逻辑”，仅靠 trial/confirm 仍能回滚（因为 Bootloader 不在 swap 区域，仍可执行回滚请求）。但若损坏导致更早阶段被 secure boot 拦截，则需 secure boot 备用验证图策略兜底。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</p></blockquote><h3 id=73-回滚执行动作>7.3 回滚执行动作<a hidden class=anchor aria-hidden=true href=#73-回滚执行动作>#</a></h3><p>当触发回滚：</p><ol><li>更新 BCB：<code>active_slot=A; trial=0; boot_success=0;</code>（并保留诊断信息）</li><li>请求 HSE swap 切回 A（TBD API）</li><li>触发 system reset</li><li>复位后 A 成为 active 并运行</li></ol><hr><h2 id=8-切-b-成功但不启动应对流程runbook>8. “切 B 成功但不启动”应对流程（Runbook）<a hidden class=anchor aria-hidden=true href=#8-切-b-成功但不启动应对流程runbook>#</a></h2><blockquote><p>该问题在 S32K3 OTA demo 中也被频繁复现：写 B 后切换成功，但破坏 B 镜像后无法运行，官方明确 <strong>AB swap 不会自动回滚</strong>，需用户逻辑请求或引入 secure boot 机制。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</p></blockquote><h3 id=81-先判定复位后有没有进入-bootloader>8.1 先判定：复位后有没有进入 Bootloader？<a hidden class=anchor aria-hidden=true href=#81-先判定复位后有没有进入-bootloader>#</a></h3><ul><li><p><strong>能进 Bootloader</strong>（推荐路径）：</p><ol><li>打印/上报：reset_reason、BCB(trial/boot_success/fail_count/active_slot)、HSE swap 状态（若可读）</li><li>若满足回滚条件：立即请求 swap 回 A + reset</li><li>同时保留失败现场：B 镜像 hash、最后写入 offset、最后错误码</li></ol></li><li><p><strong>进不去 Bootloader</strong>（高危）：</p><ul><li>排查 Bootloader 是否真的“非 swap 区域且未被覆盖”（你已声明设计上如此，但需确认链接脚本/擦写范围）。</li><li>若启用 secure boot：检查是否被 pre-boot verification 拦截（需要备用 SMR map 才能自动执行备份镜像）。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li><li>启用硬件恢复路径：ROM 下载模式 / 调试口（TBD，依项目硬件）。</li></ul></li></ul><h3 id=82-最常见根因与快速验证>8.2 最常见根因与快速验证<a hidden class=anchor aria-hidden=true href=#82-最常见根因与快速验证>#</a></h3><ol><li><p><strong>B 镜像写入物理地址错/偏移错</strong></p><ul><li>对照“passive blocks”规划（TBD），抽检 B 起始处向量表是否合理。</li></ul></li><li><p><strong>Flash 写入对齐/粒度错误导致向量表损坏</strong>（MSP/ResetHandler 非法）</p><ul><li>核查是否严格按 64-bit 对齐与最小 program 粒度写入；是否擦除到 8KB sector 边界。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li></ul></li><li><p><strong>写后未校验</strong>导致“写入静默失败”</p><ul><li>开启 sector readback CRC 或全镜像 hash 校验，定位坏区。</li></ul></li><li><p><strong>应用链接地址模型不匹配 AB swap remapping</strong></p><ul><li>AB swap 的目标是复位后 active 映射到低地址空间运行（无需复杂 linker tracking）。(<a href=https://www.nxp.com/docs/en/application-note/AN13414.pdf title="AN13414: S32K1 to S32K3 Migration Guidelines - Application Note">nxp.com</a>)</li><li>因此 A/B 的“运行逻辑基址/向量表基址”应一致（具体基址 TBD）。</li></ul></li><li><p><strong>试运行确认逻辑缺失</strong></p><ul><li>B 没有写 confirm，导致系统反复尝试或停留在异常状态（需依 BCB 策略回滚）。</li></ul></li></ol><h3 id=83-建议的救场开关>8.3 建议的“救场开关”<a hidden class=anchor aria-hidden=true href=#83-建议的救场开关>#</a></h3><ul><li>Bootloader 增加 <strong>强制回 A</strong>：检测 GPIO strap（TBD）或 SoC 发来的 <code>FORCE_ROLLBACK</code> SPI 命令。</li><li>fail_count 阈值：调试阶段设为 1；量产设为 2~3。</li><li>BCB 记录最近一次 swap 请求与 swap 结果（TBD），便于现场定位“切换成功/启动失败”的边界点。</li></ul><hr><h2 id=9-安全设计可选增强>9. 安全设计（可选增强）<a hidden class=anchor aria-hidden=true href=#9-安全设计可选增强>#</a></h2><h3 id=91-基线安全建议>9.1 基线安全（建议）<a hidden class=anchor aria-hidden=true href=#91-基线安全建议>#</a></h3><ul><li>Manifest + hash 校验（MCU 侧必须做）</li><li>SoC->MCU 传输链路校验（每 chunk CRC）</li></ul><h3 id=92-需要镜像损坏也能自动兜底的场景>9.2 需要“镜像损坏也能自动兜底”的场景<a hidden class=anchor aria-hidden=true href=#92-需要镜像损坏也能自动兜底的场景>#</a></h3><p>官方建议：若希望在镜像损坏时自动采取动作，需要实现 <strong>advanced secure boot</strong>，并配置 <strong>alternate pre-boot SMR verification map</strong>：正常预启动校验失败时可执行备用镜像，由备用镜像采取回滚动作。(<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</p><blockquote><p>该部分具体配置/密钥/SMR map 细节：<strong>TBD（依 HSE FW RM 与项目安全策略）</strong>。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</p></blockquote><hr><h2 id=10-测试与验证计划摘要>10. 测试与验证计划（摘要）<a hidden class=anchor aria-hidden=true href=#10-测试与验证计划摘要>#</a></h2><h3 id=101-功能测试>10.1 功能测试<a hidden class=anchor aria-hidden=true href=#101-功能测试>#</a></h3><ul><li>正常 OTA：写 B → swap → B 启动 → confirm → 后续重启仍为 B</li><li>回滚测试：写入“故意破坏的 B” → swap → 触发 WDG/不 confirm → 回滚 A</li><li>断电测试：传输中断电 / 擦除中断电 / 写入中断电 / swap 前断电 / swap 后首次启动断电</li></ul><h3 id=102-可靠性与鲁棒性>10.2 可靠性与鲁棒性<a hidden class=anchor aria-hidden=true href=#102-可靠性与鲁棒性>#</a></h3><ul><li>chunk 丢包/重复包/乱序包</li><li>CRC 错误注入</li><li>Flash program/erase 错误注入（模拟返回错误位）</li></ul><h3 id=103-安全测试若启用>10.3 安全测试（若启用）<a hidden class=anchor aria-hidden=true href=#103-安全测试若启用>#</a></h3><ul><li>签名错误镜像拒绝</li><li>版本回退拒绝（anti-rollback，TBD）</li></ul><hr><h2 id=11-风险与-tbd-清单>11. 风险与 TBD 清单<a hidden class=anchor aria-hidden=true href=#11-风险与-tbd-清单>#</a></h2><h3 id=111-风险>11.1 风险<a hidden class=anchor aria-hidden=true href=#111-风险>#</a></h3><ul><li>Bootloader 若擦写范围配置错误，可能误擦 swap 区或误擦自身导致变砖（必须加保护与白名单）。</li><li>BCB 若无双副本与断电保护，容易出现“状态不可判定”导致启动策略异常。</li><li>若启用 A/B swap 配置且“activation definitive”，量产前需明确恢复路径与售后策略。(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/30542/2/12_S32K3xx_Security_Overview_and_Bring_Up_Training.pdf title="12: S32K3xx Security Overview and Bring Up - Training">NXP Community</a>)</li></ul><h3 id=112-tbd待确认>11.2 TBD（待确认）<a hidden class=anchor aria-hidden=true href=#112-tbd待确认>#</a></h3><ul><li>B 区物理地址范围（blocks/起始地址/长度）</li><li>应用链接地址（vector table 逻辑基址）</li><li>SPI 速率、chunk 默认大小、窗口大小、超时与重传策略</li><li>HSE swap 请求 API/服务号/返回码（依 HSE demo/RTD 集成）(<a href=https://community.nxp.com/t5/S32K/Bank-switching-for-s32k-microcontroller/m-p/1431652/highlight/true title="
	Bank switching for s32k microcontroller - NXP Community
">NXP Community</a>)</li><li>reset reason 获取方式与分类（WDG/lockup 等）</li><li>恢复模式入口（GPIO strap/ROM boot 等）</li></ul><hr><h2 id=附录-a关键实现检查表工程落地用>附录 A：关键实现检查表（工程落地用）<a hidden class=anchor aria-hidden=true href=#附录-a关键实现检查表工程落地用>#</a></h2><ul><li><input disabled type=checkbox> Bootloader 链接脚本确认：不在 swap 区，擦写白名单只覆盖 passive B + BCB</li><li><input disabled type=checkbox> Flash 驱动确认：64-bit 对齐写入、写前 sector erase、错误位处理（PEP/解锁等）(<a href=https://community.nxp.com/pwmxy87654/attachments/pwmxy87654/S32K/37044/2/AN13388.pdf title="AN13388: S32K3 Memories Guide">NXP Community</a>)</li><li><input disabled type=checkbox> 写后校验策略：至少整镜像 hash；建议加 sector readback CRC（可配）</li><li><input disabled type=checkbox> BCB 双副本：带 CRC + counter；断电恢复可判定最新有效记录</li><li><input disabled type=checkbox> Trial/Confirm：B 启动后 N 秒内 confirm；Bootloader 依据 fail_count 回滚</li><li><input disabled type=checkbox> “切 B 不启动”救场：强制回 A 命令/strap；fail_count=1（调试）</li><li><input disabled type=checkbox> （可选）Secure boot 备用验证图：镜像损坏时自动执行备用镜像并回滚 (<a href="https://community.nxp.com/t5/S32K/How-to-enable-the-rollback-function-of-Hse-AB-SWAP-on-S32K3/td-p/2145179?profile.language=en" title="
	How to enable the rollback function of Hse AB SWAP on S32K3? - NXP Community
">NXP Community</a>)</li></ul><hr><p>在这份文档基础上继续补齐两块最关键的 <strong>TBD</strong>（并把“切 B 成功但不启动”直接收敛到可操作的排障点）：</p><ol><li>S32K324 的 <strong>Flash block 划分与 swap region 规划</strong>（给我项目的 memory map/链接脚本片段即可）</li><li>你们当前 MCU 写 Flash 的 <strong>最小写入函数</strong>（一次写多少、对齐要求、擦除策略、错误返回）</li></ol><p>补齐后我还能把 <strong>BCB 的二进制布局（字段偏移/对齐/CRC）</strong> 和 <strong>Bootloader 状态机伪代码</strong>写到可直接实现的程度。</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2026 <a href=https://ethen-cao.github.io/ethenslab/>Ethen 的实验室</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js></script><script>mermaid.initialize({startOnLoad:!0,theme:"default"})</script><script src=https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js></script><script>(function(){const e=document.querySelectorAll("pre > code.language-plantuml, pre > code.language-planuml");e.forEach(e=>{const s=e.innerText,o=plantumlEncoder.encode(s),i="https://www.plantuml.com/plantuml/svg/"+o,t=document.createElement("img");t.src=i,t.alt="PlantUML Diagram",t.style.maxWidth="100%";const n=e.parentNode;n.parentNode.replaceChild(t,n)})})()</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>