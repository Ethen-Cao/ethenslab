@startuml
skinparam sequenceMessageAlign center
skinparam noteFontSize 10
skinparam participantPadding 10
autonumber

Title Android MediaSessionService: MediaButtonSession Update Flow

box "Application Layer" #White
    participant "App A" as AppA
    participant "App B" as AppB
    participant "AudioManager" as AM_Client
end box

box "System Audio Service" #LightBlue
    participant "AudioService\n(System)" as AS
    participant "AudioPlayerStateMonitor\n(APSM)" as APSM
end box

box "System Media Service" #LightYellow
    participant "MediaSessionService" as MSS
    participant "MediaSessionStack" as Stack
end box

== Phase 1: App A Starts & Plays ==

note over AppA: App A Launches
AppA -> MSS: createSession("AppA")
activate MSS
MSS -> Stack: addSession(RecordA)
deactivate MSS

AppA -> MSS: setActive(true)
activate MSS
MSS -> Stack: onSessionActiveStateChanged(RecordA)
deactivate MSS

AppA -> AM_Client: requestAudioFocus()
AM_Client -> AS: requestAudioFocus()
AS --> AppA: GRANTED

AppA -> AS: AudioTrack.play()
activate AS
    note right of AS: AudioService detects\nplayback config change
    AS -> APSM: onPlaybackConfigChanged(uid=A, active=true)
    activate APSM
        APSM -> APSM: Update List: [uid_A]
        APSM -> MSS: onAudioPlayerActiveStateChanged(...)
        activate MSS
            MSS -> Stack: updateMediaButtonSessionIfNeeded()
            activate Stack
                Stack -> APSM: getSortedAudioPlaybackClientUids()
                APSM --> Stack: return [uid_A]
                Stack -> Stack: findMediaButtonSession(uid_A)
                note right of Stack: Match Found: RecordA
                Stack --> MSS: updateMediaButtonSession(RecordA)
                note right of MSS: **App A becomes MediaButtonSession**
            deactivate Stack
        deactivate MSS
    deactivate APSM
deactivate AS

AppA -> MSS: setPlaybackState(PLAYING)
activate MSS
MSS -> Stack: onPlaybackStateChanged(RecordA, PLAYING)
deactivate MSS

== Phase 2: Switch to App B (Preemption) ==

note over AppB: User switches to App B
AppB -> MSS: createSession("AppB")
AppB -> MSS: setActive(true)

AppB -> AM_Client: requestAudioFocus()
activate AM_Client
AM_Client -> AS: requestAudioFocus()
deactivate AM_Client

activate AS
    note right of AS: Focus Logic: Pause A, Grant B
    par Parallel Notification
        AS -> AppA: onAudioFocusChange(LOSS_TRANSIENT)
        note left of AppA: A receives Loss,\nprepares to pause
    else
        AS --> AppB: GRANTED
    end
deactivate AS

AppB -> AS: AudioTrack.play() (B starts output)
activate AS
    AS -> APSM: onPlaybackConfigChanged(uid=B, active=true)
    activate APSM
        APSM -> APSM: Update List: [uid_B, uid_A]
        note right of APSM: B is newest, moves to Top
        APSM -> MSS: onAudioPlayerActiveStateChanged(...)
        activate MSS
            MSS -> Stack: updateMediaButtonSessionIfNeeded()
            activate Stack
                Stack -> APSM: getSortedAudioPlaybackClientUids()
                APSM --> Stack: return [uid_B, uid_A]
                Stack -> Stack: findMediaButtonSession(uid_B)
                note right of Stack: Priority Match: B
                Stack --> MSS: updateMediaButtonSession(RecordB)
                note right of MSS: **MediaButtonSession switches to App B**
                
                Stack -> APSM: cleanUpAudioPlaybackUids(uid_B)
                note right of APSM: Removes inactive UIDs older than B
            deactivate Stack
        deactivate MSS
    deactivate APSM
deactivate AS

AppB -> MSS: setPlaybackState(PLAYING)
activate MSS
MSS -> Stack: onPlaybackStateChanged(RecordB, PLAYING)
deactivate MSS

== Phase 3: App A Responds to Focus Loss ==

activate AppA
    AppA -> AS: AudioTrack.pause() (A stops output)
    
    activate AS
        AS -> APSM: onPlaybackConfigChanged(uid=A, active=false)
        activate APSM
            APSM -> APSM: Update List: [uid_B]
            note right of APSM: A is inactive and cleaned up
            APSM -> MSS: onAudioPlayerActiveStateChanged(...)
            activate MSS
                MSS -> Stack: updateMediaButtonSessionIfNeeded()
                activate Stack
                    Stack -> APSM: getSortedAudioPlaybackClientUids()
                    APSM --> Stack: return [uid_B]
                    Stack -> Stack: findMediaButtonSession(uid_B)
                    note right of Stack: B matches
                    Stack -> APSM: cleanUpAudioPlaybackUids(uid_B)
                deactivate Stack
            deactivate MSS
        deactivate APSM
    deactivate AS

    AppA -> MSS: setPlaybackState(PAUSED)
    activate MSS
        MSS -> Stack: onPlaybackStateChanged(RecordA, PAUSED)
    deactivate MSS
deactivate AppA

== Phase 4: App B Pauses (Sticky Logic) ==

AppB -> AS: AudioTrack.pause()
activate AS
    AS -> APSM: onPlaybackConfigChanged(uid=B, active=false)
    activate APSM
        note right of APSM: B is inactive,\nbut kept in history list [uid_B]
        APSM -> MSS: onAudioPlayerActiveStateChanged
        activate MSS
           MSS -> Stack: updateMediaButtonSessionIfNeeded()
           activate Stack
               Stack -> APSM: getSortedAudioPlaybackClientUids()
               APSM --> Stack: return [uid_B]
               note right of Stack: List is NOT empty.\nStack checks B first.
               
               Stack -> Stack: findMediaButtonSession(uid_B)
               note right of Stack: B matches (via Priority Fallback)
               Stack --> MSS: updateMediaButtonSession(RecordB)
               
               Stack -> APSM: cleanUpAudioPlaybackUids(uid_B)
               note right of APSM: B is kept because it's the MB Session
           deactivate Stack
        deactivate MSS
    deactivate APSM
deactivate AS

AppB -> MSS: setPlaybackState(PAUSED)
activate MSS
MSS -> Stack: onPlaybackStateChanged(RecordB, PAUSED)
deactivate MSS

@enduml