@startuml
!theme plain
skinparam backgroundColor white
skinparam defaultFontName Arial
skinparam defaultFontSize 14
skinparam defaultFontColor black
skinparam arrowColor black
skinparam nodesep 60
skinparam ranksep 50
skinparam rectangle {
    BackgroundColor #ECEFF1
    BorderColor #607D8B
    RoundCorner 8
}
skinparam package {
    BackgroundColor #E3F2FD
    BorderColor #1E88E5
    FontStyle bold
}
skinparam component {
    BackgroundColor #E8F5E9
    BorderColor #2E7D32
}

title QNN HTP (ONNX Runtime) Architecture Flow

node "Qualcomm SoC (System on Chip)" {

    ' --- CPU Subsystem (Android) ---
    rectangle "CPU Subsystem (Application Processor)" as CPU_DOMAIN {

        rectangle "1. Android User Space (APK Process)" as LAYER_APP {
            component "Business Logic\n(Kotlin/Java/C++)" as AppCode
            note right of AppCode
               <b>关键配置:</b>
               setenv("ADSP_LIBRARY_PATH", 
               nativeLibraryDir, 1);
            end note

            package "Native Libraries (jniLibs / lib/arm64)" {
                component "libonnxruntime.so" as ORT
                component "libonnxruntime_providers_qnn.so" as QNN_EP
                
                package "QNN SDK CPU Libs" {
                    component "libQnnHtp.so\n(Backend Manager)" as QnnHtp
                    component "libQnnHtpV[xx]Stub.so\n(CPU Proxy)" as QnnStub
                }
                
                component "libQnnHtpV[xx]Skel.so\n(DSP Executable)" as SkelFile
                note bottom of SkelFile
                   <b>Skel 文件</b>
                   虽然打包在 CPU 文件系统
                   但必须由 FastRPC 读取并
                   加载到 DSP 运行
                end note
            }

            component "Assets (model.onnx)" as Model
            note top of Model
               由 ORT 在 CPU 端
               直接读取并解析
            end note
        }

        rectangle "2. Android System / Vendor Libs" as LAYER_SYS {
            component "libadsprpc.so (FastRPC Framework)" as FastRPC
        }

        rectangle "3. Linux Kernel Space" as LAYER_KERNEL {
            component "adsprpc.ko (FastRPC Driver)" as Driver
            component "ION / SMMU\n(Shared Memory)" as Mem
        }
    }

    ' --- DSP Subsystem ---
    rectangle "DSP Subsystem (Hexagon cDSP/HTP)" as DSP_DOMAIN {
        component "QuRT OS (Real-time Kernel)" as QuRT

        package "Signed PD (Protection Domain)" {
            component "Skel Instance (Running Code)" as SkelRun
            component "HTP Hardware (Tensor Cores)" as HTP_HW
        }
    }
}

' --- 详细调用关系 ---
AppCode -down-> ORT : 1. Run()
ORT .left.> Model: Read & Parse
ORT -down-> QNN_EP : 2. Get EP
QNN_EP -down-> QnnHtp : 3. Create Backend
QnnHtp -down-> QnnStub : 4. Load specific Stub

QnnStub -down-> FastRPC : 5. remote_handle_open()
FastRPC -down-> Driver : 6. ioctl (FASTRPC_IOCTL_INVOKE)
Driver <-> QuRT : 7. Context Switch / Wake up

QuRT .up.> Driver : 8. Request Skel
Driver .up.> FastRPC : 9. Callback
FastRPC .left.> SkelFile : 10. Read from ADSP_LIBRARY_PATH
FastRPC .down.> Mem : 11. Map to ION
Mem .down.> SkelRun : 12. Load into PD

QuRT -down-> SkelRun : 13. Execute Graph
SkelRun -down-> HTP_HW : 14. Compute
@enduml
