@startuml
!theme plain
hide footbox
skinparam linetype ortho
skinparam sequenceMessageAlign center
autonumber

' ==========================================
' 参与者定义
' ==========================================

box "Scheduling & Logic" #f9f9f9
    participant "MessageQueue\n(VSYNC)" as MQ
    participant "SurfaceFlinger" as SF
    participant "Scheduler" as Scheduler
    participant "Layer" as Layer
end box

box "Composition Engine Core" #d1c4e9
    participant "CompositionEngine" as CE
    participant "Output\n(Display)" as Output
    participant "LayerFE\n(Snapshot)" as LayerFE
    participant "OutputLayer" as OutLayer
    participant "RenderSurface" as RS
end box

box "Render Hardware" #e8f5e9
    participant "RenderEngine\n(GPU)" as RE
    participant "FramebufferSurface" as FBS
end box

box "Hardware Composer" #fff3e0
    participant "HWComposer\n(HAL)" as HWC
end box

' ==========================================
' Phase 1: 调度与锁定 (Heartbeat & Latch)
' ==========================================
== Phase 1: VSYNC Trigger & Data Latching ==

MQ ->> SF: onMessageInvalidate() \n(VSYNC Arrives)
activate SF

SF ->> SF: handleMessageTransaction()\n处理 Layer 属性变化
SF ->> SF: handleMessageInvalidate()

loop 遍历所有 Layer
    SF ->> Layer: latchBuffer()
    activate Layer
    note right of Layer: 锁定当前帧的 Buffer\n更新 mBufferInfo
    
    Layer ->> LayerFE: updateSnapshot()
    activate LayerFE
    note right of LayerFE: 固化 Buffer 句柄\n隔离主线程
    deactivate LayerFE
    deactivate Layer
end

' ==========================================
' Phase 2: SurfaceFlinger Composite Entry
' ==========================================
== Phase 2: SurfaceFlinger::composite ==

SF ->> SF: composite(pacesetterId, frameTargeters)
activate SF

SF ->> SF: moveSnapshotsToCompositionArgs()
note right of SF: 将 LayerFE 快照移动到\nCompositionRefreshArgs

loop 遍历 refreshArgs.layers
    SF ->> Layer: onPreComposition(refreshStartTime)
    note right of Layer: 更新可信呈现状态\n(TrustedPresentation)
end

' ==========================================
' Phase 3: CompositionEngine Present Flow
' ==========================================
== Phase 3: CompositionEngine::present ==

SF ->> CE: present(CompositionRefreshArgs)
activate CE

CE ->> CE: preComposition()
loop 遍历所有 LayerFE
    CE ->> LayerFE: onPreComposition()
    note right of LayerFE: 检查是否有 Pending 更新
end

' --- 3.1 Prepare 阶段 (对应代码: output->prepare) ---
group Step: Prepare (Strategy & Validation)
    loop 遍历所有 Output (args.outputs)
        CE ->> Output: prepare(args, latchedLayers)
        activate Output
        
        Output ->> Output: collectVisibleLayers()
        Output ->> Output: ensureOutputLayerIfVisible()
        
        Output ->> OutLayer: updateCompositionState()
        activate OutLayer
        OutLayer ->> LayerFE: getCompositionState()
        LayerFE -->> OutLayer: Snapshot (Geometry, Buffer)
        deactivate OutLayer

        ' 策略协商核心 (HWC Validate)
        Output ->> Output: prepareFrame()
        Output ->> HWC: validateDisplay()
        note right of HWC:HWC 检查图层属性,返回无法处理的 Layer

        HWC -->> Output: ChangedCompositionTypes (Fallback to GPU)

        Output ->> OutLayer: applyCompositionType()
        note right of OutLayer:标记 Layer 为<color:red><b>DEVICE (HWC)</b></color> 或 <color:blue><b>CLIENT (GPU)</b></color>
        
        deactivate Output
    end
end

CE ->> CE: offloadOutputs()

' --- 3.2 Present 阶段 (对应代码: output->present) ---
group Step: Present (Execution & Submission)
    loop 遍历所有 Output (args.outputs)
        CE ->> Output: present(args)
        activate Output
        note right of Output: 返回 Future<monostate>

        Output ->> Output: planComposition()
        
        ' --- 3.2.1 HWC 状态设置 (writeCompositionState) ---
        group Device Composition (Overlay Setup)
            Output ->> Output: writeCompositionState()
            activate Output
            loop 遍历 DEVICE OutputLayer
                Output ->> OutLayer: writeStateToHWC()
                OutLayer -[#red]>> HWC : setLayerBuffer(Slot, Handle, Fence) 
                note right of HWC: 将 Overlay 图层给 HWC
            end
            deactivate Output
        end

        ' --- 3.2.2 GPU 合成 (finishFrame) ---
        Output ->> Output: finishFrame()
        activate Output

        alt Strategy Prediction Failed or Buffer needed
            Output ->> RS: dequeueRenderBuffer()
            activate RS
            RS -->> Output: Buffer & Fence
            deactivate RS

            Output ->> Output: composeSurfaces() (开始 GPU 绘图)
            activate Output

            group Client Composition (GPU Rendering)
                Output ->> Output: generateClientCompositionRequests()
                
                loop 遍历 CLIENT OutputLayer
                    Output ->> LayerFE: prepareClientComposition()
                    LayerFE -->> Output: LayerSettings
                end

                alt hasClientComposition
                    Output ->> RE: drawLayers(LayerSettings[], TargetBuffer)
                    activate RE
                    RE -->> Output: Fence
                    deactivate RE
                end
            end
            deactivate Output

            Output ->> RS: queueBuffer(TargetBuffer)
            activate RS
            RS ->> FBS: advanceFrame()
            activate FBS
            FBS -[#red]>> HWC: setClientTarget(TargetBuffer)
            note right of HWC: 将 GPU 结果给 HWC
            deactivate FBS
            deactivate RS
        end
        deactivate Output
        
        ' --- 3.2.3 最终提交 (presentFrameAndReleaseLayers) ---
        Output ->> Output: presentFrameAndReleaseLayers()
        activate Output
        Output ->> HWC: presentDisplay()
        activate HWC
        HWC -->> Output: PresentFence
        deactivate HWC
        deactivate Output
        
        Output -->> CE: return ftl::Future
        deactivate Output
    end
end

' --- 3.3 等待与收尾 ---
group Step: Wait & Post
    loop 遍历 presentFutures
        CE ->> CE: future.get()
        note right of CE: 等待所有屏幕 HWC 提交完成
    end

    CE ->> CE: postComposition()
end

CE -->> SF: return
deactivate CE

' ==========================================
' Phase 4: 后处理 (Post-Composition)
' ==========================================
== Phase 4: Post Composition (Stats & Input) ==

SF ->> SF: moveSnapshotsFromCompositionArgs()
note right of SF: 释放快照所有权

SF ->> Scheduler: onCompositionPresented(presentTime)
activate Scheduler
note right of Scheduler: 更新 VSYNC 模型\n计算下一帧时间
deactivate Scheduler

SF ->> SF: onCompositionPresented()
note right of SF: 更新 Fence\n触发 Layer 回调

SF ->> SF: updateInputFlinger()
note right of SF: 发送窗口信息给 Input

SF ->> SF: mTimeStats->recordFrameDuration()

deactivate SF

@enduml