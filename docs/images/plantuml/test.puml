@startuml
!theme plain
skinparam responseMessageBelowArrow true
skinparam pageSize A4
skinparam pageOrientation landscape
skinparam dpi 150
scale 1200 width

participant "User / Script" as User
participant "memorydump\n(QNX Daemon)" as MD
participant "Guest Kernel\n(Android)" as Guest
participant "vdev-msm\n(QNX Driver)" as VDEV
participant "SMEM\n(Shared Memory)" as SMEM
participant "Hardware Register\n(Boot MISC / IMEM)" as HW
participant "Firmware\n(XBL / PBL)" as FW
participant "Rawdump Partition\n(Storage)" as Disk
participant "log_collector\n(QNX Daemon)" as LC

== Phase 1: 系统启动与注册 (Registration) ==
activate MD
User -> MD: 启动服务
MD -> SMEM: 初始化 Global TOC (ID 602)
activate SMEM
deactivate MD

group Guest 注册 (Android Boot)
    Guest -> Guest: qcom_minidump_init()
    Guest -> SMEM: 注册 Region (dmesg, stack, etc.)
    Guest -> SMEM: 代理注册 ADSP/CDSP Regions
end

group Host 注册 (QNX Boot)
    User -> MD: 驱动调用 md_ss_register_region()
    MD -> SMEM: 注册 QNX Regions (Audio Heap, etc.)
end

== Phase 2: 模式配置 (Configuration) ==
User -> MD: echo "mini_rawdump" > /dev/pdbg/.../dload_mode
activate MD
MD -> HW: set_wdog_dload_cookie(MINI_RAWDUMP)
note right: 在硬件寄存器中插旗，\n告知固件崩溃后执行 Rawdump
deactivate MD

== Scene A: 在线采集流程 (Online Guest Dump) ==
note over Guest, LC: 场景：仅 Guest VM 崩溃，Host 正常运行
Guest -> Guest: Kernel Panic / Watchdog
Guest -> VDEV: 通知 Host (Hypercall / Signal)
activate VDEV
VDEV -> LC: devctl(DCMD_COLLECT_GUEST_MINIDUMP)
activate LC
LC -> SMEM: 读取 Guest Subsystem TOC
LC -> LC: mmap(MAP_PHYS) 映射 Guest 物理内存
LC -> LC: 生成 .bin 文件 (含 Header + Sections)
LC -> Disk: 写入 /var/log/guest_dump.bin (或其他文件路径)
note right of Disk: **OTA 分区安全** (未被覆盖)
LC --> VDEV: 返回成功
deactivate LC
deactivate VDEV

== Scene B: 全系统崩溃流程 (System Crash / Rawdump) ==
note over User, Disk: 场景：Host 崩溃或 Watchdog 触发全系统重启
User -> User: System Crash / Watchdog Bite
User -> FW: CPU Reset & Jump to XBL
activate FW

FW -> HW: 读取 Boot Cookie
alt Cookie == MINI_RAWDUMP
    FW -> SMEM: 读取 Global TOC & Region List
    loop 遍历所有注册的 Region
        FW -> Disk: 裸写物理内存数据到 Rawdump 分区
        note right of Disk: **OTA 数据被销毁**
    end
end

FW -> FW: Cold Boot (Reboot OS)
deactivate FW

== Phase 3: 重启后提取 (Extraction) ==
activate LC
LC -> LC: 启动 (main)
LC -> Disk: fopen("/dev/disk/rawdump")
LC -> Disk: 读取 Header & 校验 Signature ("Raw_Dmp!")

alt Header 有效 (Previous Crash Found)
    LC -> Disk: 读取所有 Section 数据
    LC -> LC: 写入 /var/log/sbldump.bin
    LC -> Disk: fwrite(ZERO) 清空分区 Header
    note right: 清除标志防止重复提取
end
deactivate LC

@enduml