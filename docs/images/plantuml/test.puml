@startuml
!theme plain
autonumber "<b>[00]</b>"
hide footbox

participant "Reset / Boot ROM" as ROM
participant "HSE (Secure Boot)" as HSE
database   "Secure NVM\n(SMR Table / CR Table / Keys)" as NVM
participant "CPU Subsystem\n(App Core)" as CPU
participant "Recovery App\n(Alt Boot Image)" as REC
participant "HSE Service API\n(ActivatePassiveBlock)" as SRV
participant "MCU Reset Gen\n(MC_RGM / Functional Reset)" as RST
participant "Old Application\n(Restored Active @0x0040_0000)" as OLD

note over HSE,NVM
Pre-condition:
- System uses SMR-based secure boot + CR table.
- CR entry links SMR sets via preBootSmrMap / altPreBootSmrMap.
- pAltReset MUST lie within an SMR listed in altPreBootSmrMap.
- Sanction policy is defined by CR.crSanction.
end note

== Boot / Secure Boot Pre-boot Phase ==
ROM -> HSE: System reset -> HSE starts secure boot flow
HSE -> NVM: Load SMR table / CR table / keys
HSE -> CPU: Keep CPU in reset (pre-boot verify)

== Primary (Active) Pre-boot Verification ==
HSE -> HSE: Verify SMRs in preBootSmrMap\n(for Active image at logical 0x0040_0000)
alt Primary verification SUCCESS
  HSE -> CPU: Release CPU to pPassReset (normal boot)
  note right: (Not this scenario)
else Primary verification FAIL (e.g., app auth fails)
  HSE -> HSE: Enter altPreBoot verification path
end

== Alternate Pre-boot Verification (Recovery App) ==
HSE -> HSE: Verify SMRs in altPreBootSmrMap\n(Recovery App region)
alt Alt verification SUCCESS
  HSE -> CPU: Release CPU to pAltReset\n(VTOR/reset vector = pAltReset)
  CPU -> REC: Start executing Recovery App
else Alt verification FAIL
  HSE -> HSE: Apply CR.crSanction\n(KEEP_CORE_IN_RESET / RESET_SOC / DIS_KEYS ...)
  HSE -> RST: (If sanction==RESET_SOC)\nIssue Functional Reset
  note over HSE: End / stay in reset / recovery mode path (per policy)
  stop
end

== Recovery App Executes Rollback ==
REC -> SRV: Call HSE_SRV_ID_ACTIVATE_PASSIVE_BLOCK\n(request rollback to previous image)
SRV -> HSE: Send service request via MU (host->HSE)
HSE --> SRV: Response OK / FAIL

alt ActivatePassiveBlock OK
  REC -> RST: Trigger System Reset\n(Functional reset)
  note over RST,HSE: After reset, Passive becomes Active\nand maps back to logical low address space.
else ActivatePassiveBlock FAIL
  REC -> REC: Enter safe halt / log / retry policy (TBD)
  note right: For safety, do NOT jump to unverified code
  stop
end

== Post-reset Boot (Old image restored as Active) ==
RST -> ROM: Reset sequence
ROM -> HSE: HSE boot again (normal boot flow)
HSE -> CPU: Verify new Active (previous-old) image
HSE -> OLD: Release CPU -> Old Application runs\nat logical base 0x0040_0000

@enduml
