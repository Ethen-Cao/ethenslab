# H47A OTA 功能规格说明书

## 1. 基本信息

| 项目名称 (Project Name)     | H47A |
| :---------------------- | :------------- |
| 功能名称 (Function Name)    | OTA |
| 所属部门 (Department)       | 智能座舱平台软件部 |
| 文档密级 (Security Level)   | 机密 |
| 文档版本 (Document Version) | V1.0 |

## 2. 文档目的与定位

本功能规格说明书（FSS）是 **Feature Owner（FO）** 的核心交付物，旨在承接来自 **系统架构师、产品经理 (PM/PO)** 拆解的 Capability / Feature，并将其转化为软件开发团队可直接执行的**基本设计方案**。

- **对上**：承接并细化高阶需求，确保产品价值的准确传递。若上游仅提供 Capability，则由 FO 拆解为 Feature。
- **对下**：为开发团队提供可落地的设计蓝图，包括功能范围、架构视图、接口定义及非功能性约束。

## 3. 文档管理

### 3.1 版本控制

| 版本  | 日期         | 作者   | 变更摘要 |
| :--: | :--------- | :--- | :--- |
| V1.0 | YYYY/MM/DD | [作者] | 初始草稿 |

### 3.2 评审记录

| 版本  | 评审日期       | 评审人       | 评审意见   |
| :--: | :--------- | :-------- | :----- |
| V1.0 | YYYY/MM/DD | [评审人列表] | [意见摘要] |

### 3.3 参考文档

| 文档名称              | 文档编号 / 链接 |
| :---------------- | :-------- |
| 系统架构设计说明书         | [链接 / ID] |
| 产品需求文档 (PRD)      | [链接 / ID] |

## 4. 概述

### 4.1 功能目标与价值

说明本功能存在的意义，回答“为什么要做”。应直接关联到上游的 Epic 或业务目标。

示例：  
本功能旨在实现车机端与云端的 OTA 差分升级能力，减少升级包体积，提升升级效率，从而提升用户体验并降低流量成本。

### 4.2 范围

#### 4.2.1 范围内

- [列出本功能包含的职责与模块]

#### 4.2.2 范围外

- [列出与本功能相关但不由本文档负责的部分]

### 4.3 关键术语与缩略语

| 术语/缩写 | 全称                           | 描述     |
| :---- | :--------------------------- | :----- |
| FO    | Feature Owner                | 功能负责人  |
| PRD   | Product Requirement Document | 产品需求文档 |

## 5. 功能特性分解

### 5.1 编写约定与编号规则

本章节定义 OTA 功能规格说明书后续章节的**编写口径、对象模型、ID 体系与引用规则**，确保：

- 第 5 章形成**唯一权威的需求清单**；
- 第 7 章时序图能够按模板要求**关联 Feature ID 追溯**；
- 第 10 章非功能性需求按模板表格字段统一管理（类别/ID/描述/验收/策略/关联章节）；
- 第 11 章“需求可追溯性”能以“功能需求ID”为主线串起来源、设计章节与验证方法。

#### 5.1.1 编写口径与术语约定

**需求表述口径**

- “必须/应/可以”分别表示强制、推荐、可选。
- 每条需求必须写成**可验收**语句：包含触发条件、系统行为、对外输出/验收点；避免仅描述实现方式。

**名词统一**

- **任务（Task）**：一次可执行的 OTA 升级活动（含版本信息、预约信息、执行状态、结果）。
- **升级包（Package）**：云端/主节点下发或 U 盘导入的升级包实体（含版本号、校验状态）。
- **预约（Schedule）**：任务的计划执行时间及其状态（自动/自定义/取消/重约）。
- **条件（Precondition）**：执行升级所需的车辆/系统条件（如电量、车速、网络、存储等）。
- **结果（Result）**：任务最终态或终止态（成功/失败/终止/推迟等）。

#### 5.1.2 功能需求编号规则（FR）

**格式**：`FR-OTA-<Domain>-<NNN>`

- `FR`：Functional Requirement（功能需求）
- `OTA`：功能域固定前缀
- `<Domain>`：功能域枚举（见 5.1.3）
- `<NNN>`：三位顺序号，`001` 起，域内递增且**永久不复用**（删除需求也不复用编号）

**使用规则**

- 第 5 章每条需求必须有唯一 `FR-...` 编号；
- 第 7 章每个关键场景时序图应在标题处显式引用关联的需求 ID；
- 第 11 章追溯表以 `FR-...` 为主键，填写来源、设计章节/视图与验证方法。

#### 5.1.3 功能域（Domain）枚举与边界

为避免“按模块实现”导致需求碎片化，本文档以**业务能力域**作为 `<Domain>`。各域定义如下（后续第 5.3 按该顺序编写）：

| Domain | 含义              | 边界说明（写什么/不写什么）                                |
| ------ | --------------- | --------------------------------------------- |
| `GEN`  | 通用/任务生命周期底座     | 任务对象、状态持久化/恢复、事件分发、文案/配置来源与兜底等跨域能力；不写具体页面交互细节 |
| `HMI`  | HMI展示与交互        | 弹窗/页面元素、按钮行为、跳转、提示文案展示规则；不写底层通信实现             |
| `CHK`  | 查看更新/本地包识别      | 本地是否有包、版本信息获取、检查更新重试与兜底路径                     |
| `SCH`  | 预约/排程（Schedule） | 自动预约、时间选择粒度、预约提交/取消/重约、预约成功/失败反馈              |
| `PRE`  | 条件校验与推迟         | 执行门禁条件、条件不满足列表、推迟执行时间展示与处理                    |
| `EXE`  | 执行与进度           | 启动升级、进度/剩余时间刷新、进度弹窗策略、执行中异常中断表现               |
| `RST`  | 结果与后处理（Result）  | 成功/失败（含首次/二次）/终止/推迟结果展示；“未确认重启后仍提示”等结果态处理     |
| `DIAG` | 诊断与查询           | 状态查询接口、日志/事件记录、错误码映射、联调/仿真支持（如适用）             |

#### 5.1.4 非功能需求编号规则

第 9 章按模板以表格维护非功能需求（类别/需求ID/描述/验收/策略/关联章节）。

**格式**：`NFR-OTA-<Quality>-<NNN>`

- `<Quality>` 建议枚举：`PERF` 性能、`RELY` 可靠性、`RES` 资源消耗、`SEC` 安全、`COMP` 兼容性、`OBS` 可观测性/可维护性、`LEGAL` 合规等。
- 每条 `NFR-...` 应至少关联一个 `FR-...` 或关键场景（在第 9 章“关联设计章节”中引用）。

#### 5.1.5 变更与废弃规则

- 需求新增：新增 `FR-...`，在第 11 章补齐追溯链路。
- 需求修改：保持原 `FR-...` 不变，在“需求描述”中更新并在版本记录中说明原因。
- 需求删除：标记为 **Deprecated**（保留编号与删除原因），编号不复用，避免历史设计/测试追溯断裂。

### 5.2 Feature Tree（特性树总览）

本节给出 H47A OTA 的**能力地图（Feature Tree）**，用于明确第5章需求覆盖范围，并为第7章关键场景与时序图提供索引。  
说明：以下特性树按 **Domain（GEN/HMI/CHK/SCH/PRE/EXE/RST/DIAG）** 组织；每个叶子节点将在 **5.3 功能需求清单**中以 `FR-OTA-<Domain>-<NNN>` 形式落条。

---

#### 5.2.1 GEN｜通用与任务生命周期底座
- GEN-01 任务对象模型（Task/Package/Progress/Result）
- GEN-02 任务接收与状态同步（来自主节点/云端/Host）
- GEN-03 状态机与事件分发（Push/Start/Progress/Result/Defer）
- GEN-04 状态持久化与重启恢复（含“未确认重启后仍提示”支撑）
- GEN-05 文案与配置管理（来源、版本、兜底策略）
- GEN-06 权限与调用控制（对外接口/页面入口的访问控制）
- GEN-07 时间与时区处理（预约时间展示/存储/换算）

---

#### 5.2.2 HMI｜HMI 展示与交互
- HMI-01 升级任务提醒弹窗（版本/耗时/内容/按钮）
- HMI-02 服务条款入口与展示（系统更新服务条款）
- HMI-03 预约相关弹窗与页面交互（自动/自定义/重约/取消）
- HMI-04 升级进度弹窗（进度/剩余时间/提示语）
- HMI-05 升级结果弹窗（成功/失败/终止/推迟）
- HMI-06 “查看更新”入口与页面交互（含检查更新按钮）
- HMI-07 文案与长文本展示（滚动、截断、重点高亮）
- HMI-08 异常提示一致性（缺字段、超时、失败原因可读化）

---

#### 5.2.3 CHK｜查看更新/本地包识别
- CHK-01 本地是否存在待升级包检测
- CHK-02 版本信息获取与展示（当前版本/目标版本）
- CHK-03 未检测到更新/版本信息异常兜底
- CHK-04 “检查更新”重试机制与反馈
- CHK-05 本地包状态与预约状态组合呈现（未预约/已预约/失败待处理）

---

#### 5.2.4 SCH｜预约/排程（Schedule）
- SCH-01 自动预约（默认时间策略，例如 02:00）
- SCH-02 自定义预约（时间粒度、可选范围、展示规则）
- SCH-03 预约提交（loading、成功/失败反馈）
- SCH-04 重新预约/取消预约
- SCH-05 开启/关闭自动升级对下次预约策略的影响
- SCH-06 预约信息持久化与恢复（页面再次进入一致显示）

---

#### 5.2.5 PRE｜条件校验与推迟（执行门禁）
- PRE-01 执行前条件判定（电量/车速/网络/存储等）
- PRE-02 条件不满足原因列表生成与展示（可滚动）
- PRE-03 推迟执行时间生成/下发/展示（重点高亮）
- PRE-04 条件不满足下的用户操作（重新预约/关闭）
- PRE-05 条件变化与状态更新（条件满足后可执行、条件再次不满足的处理口径）

---

#### 5.2.6 EXE｜执行与进度
- EXE-01 OTA 任务启动信号处理（触发进度展示）
- EXE-02 进度上报与刷新（节流、刷新频率、百分比规则）
- EXE-03 剩余时间估算与展示规则
- EXE-04 执行阶段提示语（下载/校验/安装/重启等口径）
- EXE-05 执行中异常与中断表现（断连、超时、取消、系统重启等）
- EXE-06 执行中状态持久化（重启后恢复到合理展示/状态）

---

#### 5.2.7 RST｜结果与后处理（Result）
- RST-01 升级成功结果处理（弹窗、确认、留存策略）
- RST-02 升级失败结果处理（首次失败可重约、二次失败提示策略）
- RST-03 升级终止/取消任务结果处理
- RST-04 推迟（不满足条件）结果处理（推迟时间+原因列表）
- RST-05 结果态持久化与恢复（未确认重启后仍提示、已确认不再提示）
- RST-06 结果与错误码/原因映射（面向用户的可读提示）

---

#### 5.2.8 DIAG｜诊断与查询（可观测性能力）
- DIAG-01 任务状态查询（当前任务/预约/进度/结果）
- DIAG-02 关键事件记录（Push/Start/Progress/Result/Defer）
- DIAG-03 错误码与原因归一化（Host/MCU/Guest 统一口径）
- DIAG-04 联调/仿真能力（注入任务/进度/结果用于 HMI 联调）
- DIAG-05 日志与导出（用于问题定位与售后闭环）

---

#### 5.2.9 特性树与后续章节关系（索引规则）
- 5.3 将按本节 Domain 顺序，对每个叶子节点落地为 `FR-OTA-<Domain>-<NNN>` 需求条目；
- 第7章每个关键场景应引用其覆盖的 FR ID（一个场景对应多条 FR）；
- 第8章接口项应能追溯到对应的 FR ID；
- 第9章（非功能性需求）条目应关联关键 FR 或关键场景，以保证可验收与可追溯。


### 5.3 功能需求清单

### 5.4 关键场景清单

## 6. 软件基本设计

### 6.1 场景视图

使用用例图展示主要参与者 (Actor) 与系统交互方式。详细流程请参见第 7 章《关键场景与动态行为》。

### 6.2 逻辑视图

描述系统的功能模块组成及相互关系。

| 组件名称        | 核心职责描述        |
| :---------- | :------------ |
| Component A | [描述组件主要功能与边界] |
| Component B | [描述组件主要功能与边界] |

### 6.3 开发视图

描述代码结构，如模块划分、包关系等（建议使用包图）。

### 6.4 状态机视图（可选）

描述系统或组件的状态变化与转换条件（建议使用状态机图）。

### 6.5 物理视图（可选）

描述软件模块在硬件节点上的部署关系（建议使用部署图）。

## 7. 关键场景与动态行为

使用时序图描述关键业务流程。每个时序图应关联 Feature ID，以便追溯。

场景: [F-X.X, F-Y.Y] - [场景描述]

## 8. 接口定义

### 8.1 [组件 A] 接口

#### 8.1.1 提供接口

| 方法名 | 参数 | 返回值 | 异步回调 | 功能描述 |
| :-- | :- | :-- | :--- | :--- |

#### 8.1.2 依赖接口

| 依赖模块/组件 | 接口/服务 | 功能描述 |
| :------ | :---- | :--- |

### 8.2 [组件 B] 接口

#### 8.2.1 提供接口

| 方法名 | 参数 | 返回值 | 异步回调 | 功能描述 |
| :-- | :- | :-- | :--- | :--- |

#### 8.2.2 依赖接口

| 依赖模块/组件 | 接口/服务 | 功能描述 |
| :------ | :---- | :--- |

### 8.3 数据结构定义

定义接口中传递的关键数据对象结构体。

### 8.4 云端接口

| API 端点 | 方法 | 请求体 | 响应体 | 功能描述 |
| :----- | :- | :-- | :-- | :--- |

## 9. 非功能性需求

| 类别   | 需求 ID  | 需求描述   | 验收标准      | 设计策略与实现机制 | 关联设计章节 |
| :--- | :----- | :----- | :-------- | :-------- | :-------- |
| 性能   | NFR-P1 | 系统启动时间 | < 3 秒     |  |  |
| 可靠性  | NFR-R1 | 异常恢复时间 | < 5 秒     |  |  |
| 资源消耗 | NFR-R2 | 内存占用上限 | < 300 MB  |  |  |
| 安全   | NFR-S1 | 接口鉴权   | 通过 OAuth2 |  |  |

## 10. 错误与异常处理

| 错误场景     | 可能原因 | 系统处理策略    | 用户提示       |
| :------- | :--- | :-------- | :--------- |
| OTA 升级失败 | 网络异常 | 重试三次后上报错误 | “网络异常，请重试” |

## 11. 需求可追溯性

| 功能需求 ID | 需求描述 | 来源 (Capability) | 设计章节 / 视图      | 验证方法 (Test Case ID) |
| :------ | :--- | :-------------- | :------------- | :------------------ |
| F-X.X   | [描述] | CAP-XX          | §3.1, §4, §5.1 | TC-XXX              |

## 12. 附录 (Appendix) *[可选]*

包含补充资料、错误码表、接口示例、测试样例等。
