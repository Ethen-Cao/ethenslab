+++
date = '2025-08-08T11:36:11+08:00'
draft = false
title = 'Android DRM 框架'
+++

## Widevine L1 DRM 播放流程解读

下面的时序图展示了 **Android 平台 Widevine L1 DRM** 的核心工作原理，涵盖了 **设备注册、许可证获取、视频解密与安全渲染** 三个阶段，并特别标注了 **安全关键点（Secure Path）**。

![](/ethenslab/images/drm-contentkey.png)

---

### 阶段1：设备首次注册 / 公钥上报

1. **App 初始化 DRM**

   * 应用调用 `MediaDrm`，系统初始化 DRM 会话。

2. **TEE 生成设备密钥对**

   * 设备在 TEE 内部生成 **Device Key Pair**（公钥/私钥）。
   * **私钥仅存在于 TEE 内部，绝不导出**。

3. **设备证书生成**

   * TEE 通过 `generateProvisioningRequest()` 生成设备证书，包含设备公钥和签名。

4. **上传设备证书**

   * App 将证书发送给 License Server。
   * License Server 验证签名，并保存设备公钥，用于后续加密 Content Key。

---

### 阶段2：许可证请求与 Content Key 加密

5. **生成许可证请求**

   * App 调用 `getLicenseRequest(Content ID)`。
   * TEE 使用设备私钥对请求进行签名，保证请求合法性。

6. **发送许可证请求**

   * App 将签名请求发送给 License Server。

7. **许可证生成**

   * License Server 验证签名。
   * 使用设备公钥加密 Content Key，并生成许可证响应。
   * 加密后的许可证 = RSA_Encrypt(内容密钥, 设备公钥)

8. **许可证下发**

   * App 收到加密许可证，通过 `provideProvisionResponse()` 交给 MediaDrm/TEE。

9. **TEE 内部解密许可证**

   * TEE 使用设备私钥解密，取出 Content Key。
    当设备收到加密的许可证后，CDM 会将其传递给 TEE。在 TEE 内部：
    TEE 直接使用唯一的设备私钥来解密整个许可证，从而直接得到明文的内容密钥。
    内容密钥 = RSA_Decrypt(加密后的许可证, 设备私钥)
   * 返回一个 **会话句柄** 给 MediaDrm，而不是返回明文 Content Key。
---


### 阶段3：视频解密与 Secure Path 渲染

10. **MediaCrypto 初始化**

    * App 创建 `MediaCrypto` 实例，绑定 Content Key 会话。

11. **视频解码配置**

    * App 配置 `MediaCodec`，准备播放加密视频流。

12. **播放循环**

    * **(21)** App 将加密视频片段交给 `MediaCrypto`。
    * **(22)** `MediaCrypto` 把加密数据传给 TEE。
    * **(23)** TEE 使用 Content Key 解密。
    * **(24)** 解密后的帧不会返回 App，而是直接传递到 **SecureDecoder**（安全硬件解码器）。

      * **关键点：** 解密后数据通过 **Secure Buffer / Secure Path**，不会暴露到普通内存或应用层。
    * **(25)** SecureDecoder 渲染视频帧到屏幕。

---

### 安全关键点总结

* **设备私钥 (Device Private Key)** 永远存储在 TEE 内部，避免泄露。
* **Content Key** 只在 TEE 内部解密，并通过会话句柄访问，App 永远看不到明文密钥。
* **解密视频帧** 通过 **Secure Buffer** 直接进入 SecureDecoder，保证数据不会泄露到应用层或系统内存。
* **Secure Path 渲染** 确保视频帧只能显示，不能被截屏、拷贝或录制。

---

## Widevine L1 生产预置流程


### 概述

Widevine L1 的生产预置流程是设备从出厂到获得正式身份认证的一系列安全操作，用于保证 **设备私钥不泄露**，并让设备能够获得 **Google 签名的合法证书**，参与 Widevine DRM 的内容解密。整个流程由 OEM 工厂和 Google 云端签名服务共同完成，但 OEM 不持有 Google 的根私钥。

---

### 阶段 1：密钥对生成（Key Pair Generation）

1. **OEM 启动预置流程**：生产线上的工厂 PC 启动预置程序，准备对新出厂设备进行 Widevine L1 初始化。
2. **运行预置工具**：工厂 PC 调用专用预置工具（FactoryTool），与设备芯片内部的 TEE 交互。
3. **TEE 生成设备密钥对**：芯片内部的可信执行环境（TEE）生成唯一的 Device Key Pair，其中 **私钥永远不会导出**，公钥将用于后续申请证书。
4. **安全存储私钥**：Device Private Key 被写入 TEE 的安全存储区域（如 Fuse / Keybox / RPMB），确保不可被外部访问。
5. **导出公钥**：TEE 将 Device Public Key 提供给预置工具，用于生成证书签名请求（CSR）。

**安全亮点**：私钥永不离开 TEE，保证设备身份的安全基础。

---

### 阶段 2：证书签名请求（CSR）

6. **生成 CSR**：FactoryTool 将设备公钥与唯一的 Device ID 组合成证书签名请求（CSR）。

   * CSR 遵循标准 PKI 规范，用于申请数字签名证书。
7. **发送 CSR 至 Google 云端签名服务**：CSR 通过加密通道（如专线、VPN 或 HTTPS）上传到 Google 的 Widevine CA 系统。

   * Google 会先验证 CSR 请求来源是否来自授权 OEM 或工厂。

**安全亮点**：CSR 通过安全通道传输，保证在传输过程中不被篡改或窃取。

---

### 阶段 3：签名与证书返回

8. **Google 签名 CSR**：Google 的证书签名服务使用 Root Private Key 对 CSR 进行数字签名，生成 **设备证书（Device Certificate）**。
9. **返回签名证书**：签名后的设备证书通过加密通道返回给工厂的预置工具。

**安全亮点**：OEM 不持有 Google 根私钥，签名操作完全在 Google 云端完成，保证了证书的权威性和不可伪造性。

---

### 阶段 4：证书注入与激活

10. **注入设备证书**：FactoryTool 将签名证书写入 DeviceTEE 内部，通过 TEE 提供的安全接口完成注入。
11. **TEE 验证签名**：设备启动时或注入时，TEE 使用 Google Root Public Key 验证证书签名是否合法。
12. **永久存储证书**：签名验证通过后，设备证书被存储在 TEE 的安全存储区域，与私钥共同形成完整身份体系。
13. **返回成功状态**：TEE 向 FactoryTool 返回注入成功的状态，表示设备已成为 Widevine L1 合法设备。
14. **签名验证失败**（异常情况）：若验证失败，TEE 返回错误状态，流程中止，防止非法设备获得证书。
15. **记录流程结果**：FactoryPC 对整个流程进行记录和日志保存，以便追踪和质量管理。

**安全亮点**：

* 设备证书和私钥都存储在 TEE 内，外部软件无法访问。
* 只有经过 Google 签名的设备证书才能被设备接受并激活 Widevine L1。
* 整个流程保证了生产阶段的设备身份和密钥管理安全。

---

### 总结

1. **设备私钥永不外露**，保证了 DRM 内容密钥解密的安全根基。
2. **CSR 安全传输 + Google 云端签名**，保证了设备公钥和身份的可信性。
3. **TEE 验证与安全存储**，确保只有合法设备才能获得 Widevine L1 认证。
4. OEM 仅扮演代理角色，负责安全地生成密钥和传递 CSR，签名权威仍在 Google。

---

![](/ethenslab/images/drm-keyprovision.png)

## Widevine 远程密钥预置 (RKP) 流程


### **1. RKP 简介**

远程密钥预置（Remote Key Provisioning, RKP）是 Widevine L1 认证设备的一种现代密钥安装方法。与传统的**工厂预置（Factory Provisioning）模式不同，RKP 允许设备在离开生产线后，于首次使用**时，通过安全的网络连接动态地从 Google 服务器获取其唯一的设备密钥。

这种模式的优势在于：

  * **简化生产线流程**：无需在工厂进行耗时且复杂的密钥烧录操作。
  * **更高的安全性**：密钥仅在需要时才生成和安装，减少了生产和运输过程中的安全风险。
  * **设备可更新性**：密钥管理和证书可以在设备生命周期内进行远程更新和管理。

### **2. 关键组件**

  * **设备制造商 (OEM)**：负责设备的硬件生产和软件集成。
  * **Google RKP 服务**：一个安全的云端服务，负责为设备生成和签名密钥。
  * **高通/SoC 厂商**：提供支持 RKP 的 TEE（可信执行环境）和相关的库（如 `liboemcrypto.so`）。
  * **终端设备**：待预置的设备，包含 TEE 硬件。
  * **RKP 专用工具**：Google 提供给 OEM 的工具，用于在工厂或开发阶段与设备通信，并协助密钥注册。

### **3. RKP 工作流程**

整个 RKP 流程可以分为两个主要阶段：**工厂注册**和**远程激活**。

#### **阶段一：工厂端注册（一次性操作）**

这个阶段通常在 OEM 的工厂或开发环境中完成，目的是将设备的基本信息和公钥安全地注册到谷歌的云端服务。

1.  **设备准备**：设备出厂时，其 TEE 内已预置了支持 RKP 的基础固件，但**没有**设备密钥。
2.  **证书签名请求 (CSR) 提取**：OEM 使用 Google 提供的专用工具（如 `rkp_factory_extraction_tool`），通过 USB 或其他安全连接与设备通信。该工具指示设备的 TEE 生成一个临时的密钥对，并用其私钥对一个 CSR 进行签名。
3.  **CSR 上传**：工具将该 CSR 上传到 Google 的 RKP 服务。
4.  **Google 签名**：RKP 服务验证 CSR 的合法性，并用其**根私钥**对 CSR 进行签名，生成一个**临时的设备证书**。这个证书将用于后续远程激活时验证设备的身份。

#### **阶段二：远程密钥获取与激活（首次使用）**

这个阶段在设备首次连接到互联网时自动触发，通常在 App 尝试播放受保护内容时由 `MediaDrm` 框架启动。

1.  **设备密钥生成**：设备的 TEE 安全地生成一个**永久的**、唯一的设备密钥对。
2.  **密钥请求**：设备将这个永久密钥对的**公钥**，以及在工厂端获得的临时证书，一起发送给 Google RKP 服务。
3.  **密钥签名**：RKP 服务验证请求，并用其**根私钥**对设备的永久公钥进行签名，生成最终的、不可更改的**设备证书**。
4.  **设备激活**：设备下载并验证这个签名的设备证书。一旦验证通过，设备密钥即被激活，并可以用于后续的许可证请求。

-----

#### **4. RKP 流程 PlantUML 时序图**

![](/ethenslab/images/drm-rkp.png)

传统的工厂预置私钥方式（Factory-Provisioned Keys）
在Android早期版本（如Android 11及之前）的密钥认证（Key Attestation）机制中，采用的是工厂预置私钥的方式。具体过程如下：

密钥生成与预置：OEM（原始设备制造商）或ODM（原始设计制造商）在工厂环境中生成密钥对（公钥和私钥）。私钥直接注入（provisioned）到设备的TEE（Trusted Execution Environment，可信执行环境）中。
风险与问题：这要求在工厂处理敏感的私钥秘密，增加了供应链泄露的风险（如工厂员工或供应链环节的潜在泄露）。一旦私钥泄露，整个批次的设备可能受影响，且难以恢复。同时，密钥是静态的，不易轮换，隐私保护较弱（例如，多个应用可能共享同一密钥，导致追踪风险）。
使用流程：设备出厂后，应用请求认证时，直接使用预置的私钥生成凭证链，无需在线请求新证书。但证书链较短，且根信任基于RSA。

这种方式确实在“第一步”（工厂阶段）就预置了私钥，这也是其主要安全隐患所在。
RKP（远程密钥预置）与传统的区别
RKP是Google从Android 12开始引入的可选机制，并在Android 13中强制要求（针对新设备），旨在取代传统的工厂预置私钥方式，提高安全性和隐私。RKP的核心是不预置私钥，而是由设备自行生成并保护私钥，只在工厂提取公钥。

密钥生成：密钥对（公钥和私钥）由设备TEE自行生成。私钥从生成起就永不离开TEE的安全环境，确保零暴露。
工厂流程（第一步）：

OEM在工厂启动设备公钥提取。
设备TEE生成唯一的硬件绑定密钥对。
只提取公钥（DK_PUB），上传到Google服务器存储。私钥不导出、不预置。


远程配置流程（设备端）：设备开箱联网后，应用触发请求，TEE生成CSR（凭证签名请求），用私钥签名后发送到Google服务器。服务器验证公钥匹配后，签名并返回短期证书链（有效期最长两个月）。证书定期轮换。
安全/隐私优势：

供应链安全：消除工厂处理私钥的风险，减少泄露可能。
隐私提升：每个应用获得不同的认证密钥，证书短期有效，服务器分段设计（验证公钥的服务器不接触认证密钥），防止设备追踪。
可恢复性：如果设备软件被入侵，Google可停止向其提供新证书，而不影响整个生态。
技术改进：证书链更长，根信任从RSA转向ECDSA，支持更安全的密钥轮换。


总之，传统的工厂预置确实在第一步预置私钥，但RKP避免了这一点，转而使用设备生成+公钥提取的方式。这大大降低了风险，并已成为Android生态的标准。


#### 流程对比：Widevine L1 预置 vs. RKP 认证

这两种流程服务于不同的核心目标，并且在工作流程、安全性及 OEM 责任方面存在根本差异。

| 特性比较 | **传统 Widevine L1 生产预置 (Keybox)** | **远程密钥预置 (RKP for Attestation)** |
| :--- | :--- | :--- |
| **核心目标** | DRM 内容保护，确保加密的影音内容只能在授权设备上播放。 |  设备完整性认证 (Attestation)，向 App (如银行、支付) 证明设备处于安全、未被篡改的状态 。 |
| **密钥配置地点** |  **工厂生产线** 。密钥在设备出厂前已完全烧录。 |  **用户端 (In-the-field)** 。设备在首次连接网络时，通过 OTA 远程获取密钥凭证 。 |
| **工厂流程** |  **注入私钥**  。将包含完整密钥对 (公钥+私钥) 的 `keybox.xml` 文件安全地烧录到每台设备中。 |  **提取公钥** 。仅从每台设备中提取其唯一的、非敏感的公钥 (DK\_PUB)。 |
| **关键交付物** | 一台包含**永久性** Widevine 设备密钥的、已完全配置的设备。 |  一台「已准备好」进行远程配置的设备，其公钥已在 Google 云端注册 。 |
| **密钥/凭证类型** |  **永久性、长生命周期的设备密钥**。一旦泄漏，影响是永久的 。 |  **短期、可再生的认证凭证** (例如，有效期仅两个月)。 |
| **安全性** |  **较高风险**。OEM 必须处理并保护高度敏感的私钥材料，存在工厂或供应链泄漏的风险 。 |  **极高安全性**。OEM 在工厂完全不接触任何私钥，私钥从未离开过设备的 TEE 。 |
| **灵活性与可恢复性** |  **低**。密钥一旦泄漏或被撤销，设备将永久失去信任 ，通常需要硬件召回 (RMA) 。 |  **高**。如果出现漏洞，Google 只需停止为有问题的设备签发新的短期凭证，即可有效控制风险，无需撤销永久密钥 。 |
| **OEM 责任** |  **责任重大**。需要建立和维护昂贵且复杂的安全生产环境，以保护私钥材料的安全 。 |  **责任较轻**。只需负责提取和上传非敏感的公钥 ，大大降低了安全管理的复杂度和成本。 |
