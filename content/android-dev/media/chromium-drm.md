+++
date = '2025-08-25T11:36:11+08:00'
draft = false
title = 'Chromium + Android DRM 视频安全渲染流程说明'
+++


![](/ethenslab/images/chromium-drm.png)

这份时序图详细描绘了在一个基于 Chromium 的 Android 浏览器中，播放受 Widevine L1 DRM 保护的视频时，从用户点击播放到影像最终显示在屏幕上的完整、端到端的安全流程。

整个流程的核心是确保**内容密钥 (Content Key)** 和**解密后的视频画面**始终处于硬件级别的安全保护之下，绝不泄漏到不安全的应用程序（浏览器）或操作系统主内存中。

## **流程详解**

### **1. 初始化与会话创建 (步骤 1-3)**

* **(1-2)** 当用户在浏览器中点击播放受保护的视频时，网页前端的 JavaScript 会通过 **Encrypted Media Extensions (EME)** API 向浏览器发出请求，表明需要处理 DRM 内容。
* **(3)** EME 接着会调用 Android 系统底层的 **`MediaDRM` API**，在系统层级创建一个 DRM 会话。这一步为后续的授权请求和解密操作做好了准备。

### **2. 授权请求与获取 (步骤 4-8)**

* **(4-6)** `MediaDRM` API 指示 **TEE (可信执行环境)** 内的 Widevine L1 模块生成一个加密的**授权请求**。这个请求包含了设备的唯一凭证，并经过设备私钥签名。TEE 将这个请求数据返回给浏览器。
* **(7-8)** **Chromium 浏览器** 负责处理网络通信。它将从 TEE 获取的授权请求，通过网络发送给**授权服务器 (License Server)**。服务器在验证请求的合法性后，会回传一个加密的授权（其中包含了用设备公钥加密的 Content Key）。

### **3. 授权处理与密钥提取 (步骤 9-10)**

* **(9)** 浏览器将从服务器获取的加密授权，通过 `MediaDRM` API 传递下去。
* **(10)** 加密的授权最终被送达 **TEE**。在 TEE 内部，Widevine L1 模块会使用其唯一的设备私钥来解密授权，从而安全地提取出 **Content Key**。
* **(Note)** 正如图中注释所示，**Content Key 从此步骤开始，永远不会离开 TEE 的安全环境**。

### **4. 安全解密与渲染 (步骤 11-14)**

* **(11)** `MediaDRM` 将一个指向 TEE 内部安全会话的**句柄 (handle)**，连同加密的视频流，一起提供给 **`MediaCodec`**（Android 的媒体编解码器）。
* **(12)** `MediaCodec` 与 TEE 协同工作。加密的视频帧被送入 TEE 进行硬件级别的解密。
* **(Note)** 图中注释再次强调，**解密后的明文视频帧会通过一个安全路径 (Secure Path) 直接传输**，完全绕过了浏览器和 Android 的应用程序层。
* **(13-14)** 这些明文帧被直接发送到 **GPU / Display** 硬件进行渲染，最终用户在屏幕上看到播放的画面。

---

## **核心安全原则总结**

这份时序图完美地展示了 Widevine L1 的核心安全原则：

* **密钥不离开 TEE**：最敏感的 Content Key 始终被锁在硬件安全区内。
* **数据不离开安全路径**：解密后的视频内容在任何时候都不会暴露给可以被拦截或复制的应用程序主内存，确保了端到端的内容保护。