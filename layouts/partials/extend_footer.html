{{- /* ==========================================
   1. 处理 Mermaid (改为主动触发渲染)
   ========================================== */ -}}
{{- if .Page.Store.Get "hasMermaid" }}
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs';
    
    // 初始化配置
    mermaid.initialize({ 
        startOnLoad: false, // 禁止自动加载，改为手动控制
        theme: 'default' 
    });
    
    // 立即查找并渲染所有 .mermaid 元素
    mermaid.run({
        querySelector: '.mermaid'
    });
</script>
{{- end }}

{{- /* ==========================================
   2. 处理 PlantUML (移除事件监听，直接执行)
   ========================================== */ -}}
{{- if .Page.Store.Get "hasPlantUML" }}
<script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
<script>
    (function(){
        // 定义核心渲染函数
        function renderPlantUML() {
            const codes = document.querySelectorAll('code.language-plantuml, code.language-planuml');
            
            codes.forEach(codeBlock => {
                if (codeBlock.getAttribute('data-processed')) return;
                codeBlock.setAttribute('data-processed', 'true'); // 标记已处理
                
                try {
                    const plantumlCode = codeBlock.innerText.trim();
                    if (!plantumlCode) return;

                    const encoded = plantumlEncoder.encode(plantumlCode);
                    const imageUrl = "https://www.plantuml.com/plantuml/svg/" + encoded;
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = "PlantUML Diagram";
                    img.style.maxWidth = "100%";
                    img.className = "plantuml-img";

                    const preBlock = codeBlock.closest('pre');
                    if (preBlock) {
                        preBlock.parentNode.replaceChild(img, preBlock);
                    } else {
                        codeBlock.parentNode.replaceChild(img, codeBlock);
                    }
                } catch (e) {
                    console.error('PlantUML rendering error:', e);
                }
            });
        }

        // 确保 plantumlEncoder 已经加载
        if (typeof plantumlEncoder !== 'undefined') {
            renderPlantUML();
        } else {
            // 如果脚本还没加载完（极少情况），稍微轮询一下
            const checkInterval = setInterval(() => {
                if (typeof plantumlEncoder !== 'undefined') {
                    clearInterval(checkInterval);
                    renderPlantUML();
                }
            }, 50);
        }
    })();
</script>
{{- end }}